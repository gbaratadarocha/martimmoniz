<!DOCTYPE html>
<!-- 
    üè≠ APP MANUTEN√á√ÉO MCF + PSY
    üì¶ Vers√£o: v3.7.2.1
    üìÖ Data: 2026-01-12
    
    üéØ v3.7.2.1: CORRE√á√ïES DE UX üé®
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ‚úÖ Bot√£o de alertas otimizado (apenas √≠cone üö®, mostra alertas ao clicar)
    ‚úÖ Filtro de equipamentos por empresa (MCF vs PSY)
    ‚úÖ Dropdown desabilitado at√© empresa ser selecionada
    ‚úÖ Componentes filtram por empresa E √°rea
    
    üéØ v3.7.2.0: ALERTAS DE PRODUTIVIDADE üö®
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ‚úÖ Banner de alerta para Marco e Gon√ßalo se t√©cnicos n√£o fecharem OTs
    ‚úÖ Verifica√ß√£o autom√°tica no √∫ltimo dia √∫til (Segunda-S√°bado)
    ‚úÖ L√≥gica: Segunda‚ÜíS√°bado, Ter√ßa-S√°bado‚Üídia anterior, Domingo‚Üísem verifica√ß√£o
    ‚úÖ Alerta aparece 1x por dia, visual vermelho com bot√£o "Entendido"
    ‚úÖ Logs detalhados no Console (F12) para debug
    
    üéØ v3.7.1.4: FIX CR√çTICO - ERRO renderMovimentos() BLOQUEAVA AN√ÅLISES üêõ
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ‚úÖ Removida refer√™ncia a renderMovimentos() (fun√ß√£o obsoleta)
    ‚úÖ Erro "renderMovimentos is not defined" estava a parar TODO o JavaScript
    ‚úÖ window.atualizarAnalises agora √© definida corretamente
    ‚úÖ An√°lises funcionam!
    
    üéØ v3.7.1.3: FIX CR√çTICO - AN√ÅLISES CARREGAM DADOS DO SUPABASE üêõ
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ‚úÖ Sincroniza√ß√£o do Supabase ANTES de restaurar aba ativa
    ‚úÖ Timeout aumentado (300ms‚Üí500ms) para garantir dados carregados
    ‚úÖ Logs para debug na chamada de atualizarAnalises()
    ‚úÖ Await expl√≠cito na sincroniza√ß√£o para garantir ordem
    
    üéØ v3.7.1.2: CORRE√á√ïES CR√çTICAS - AN√ÅLISES & CHATBOT üêõ
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ‚úÖ Removida declara√ß√£o window.atualizarAnalises = null (bug cr√≠tico)
    ‚úÖ Try/catch em todas as fun√ß√µes de renderiza√ß√£o de gr√°ficos
    ‚úÖ Valida√ß√£o de Chart.js carregado
    ‚úÖ Mensagens de erro mais claras no chatbot
    
    üéØ v3.7.1.1: PERMISS√ïES SIMPLIFICADAS üîê
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ‚úÖ Sistema de permiss√µes clarificado (Admin vs User)
    ‚úÖ User pode ver mas n√£o editar Planeamento
    ‚úÖ Utilizador registado automaticamente em movimentos
    ‚úÖ Removido role "visualizador" (n√£o usado)
    
    üéØ v3.7.1.0: ASSOCIA√á√ÉO DE STOCKS A ORDENS DE TRABALHO üí∞
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ‚úÖ Modal de Baixa M√∫ltipla de Stock (v√°rios artigos de uma vez)
    ‚úÖ Associa√ß√£o opcional de movimentos a OTs (campo pedidoId)
    ‚úÖ Bot√£o "Dar Baixa de Stock" no modal de detalhes da OT
    ‚úÖ Sec√ß√£o "Materiais Usados" mostrando custos por OT
    ‚úÖ Rastreabilidade completa: artigo, qtd, respons√°vel, data, custo
    ‚úÖ C√°lculo autom√°tico de custo total da OT
    ‚úÖ Suporta baixas sem OT (consum√≠veis gerais)
    
    üéØ v3.7.0.11: Hist√≥rico de Movimentos reformulado
    üéØ v3.7.0.10: Badges melhorados + Prioridade opcional
    
    üéØ v3.7.0.8: PREVENTIVAS COMPLETAS + CHATBOT IA (GEMINI 2.5 FLASH)
    üßπ v3.6.7: Limpeza profunda (‚Üì25% ficheiros, ‚Üì30% tamanho, zero 404)
-->
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Gestor de Tarefas">
    <title>üè° Gestor de Tarefas Dom√©sticas</title>
    
    <!-- PWA Manifest -->
    <!-- <link rel="manifest" href="/martimmoniz/manifest.json"> -->
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#000000">
    <style>
        /* ===================================
           App de Manuten√ß√£o - Estilo Apple (INLINE)
           =================================== */
        
        /* Reset e Vari√°veis */
        :root {
            /* Cores Apple */
            --color-white: #FFFFFF;
            --color-background: #F5F5F7;
            --color-text-primary: #1D1D1F;
            --color-text-secondary: #86868B;
            --color-blue: #007AFF;
            --color-blue-dark: #0051D5;
            --color-border: #D2D2D7;
            --color-shadow: rgba(0, 0, 0, 0.1);
            
            /* Cores de Prioridade */
            --color-alta: #FF3B30;
            --color-media: #FF9500;
            --color-baixa: #34C759;
            
            /* Cores de Estado */
            --color-novo: #007AFF;
            --color-emcurso: #FF9500;
            --color-resolvido: #34C759;
            
            /* Tipografia - System Fonts */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            /* Espa√ßamento */
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 999px;
            
            /* Sombras */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            
            /* Transi√ß√µes */
            --transition-fast: 0.15s ease;
            --transition-base: 0.3s ease;
            --transition-slow: 0.5s ease;
        }
        
        /* Reset Global */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            max-width: 100%;
        }
        
        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        body {
            font-family: var(--font-family);
            font-weight: var(--font-weight-regular);
            color: var(--color-text-primary);
            background-color: var(--color-background);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
        }
        
        /* Header */
        .app-header {
            background: var(--color-white);
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.8);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-header h1 {
            font-size: 1.5rem;
            font-weight: var(--font-weight-semibold);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .header-icon {
            width: 28px;
            height: 28px;
            color: var(--color-blue);
            flex-shrink: 0;
            /* Remover fundo branco */
            border-radius: 50%;
            background: transparent;
        }
        
        /* Espec√≠fico para IMG (n√£o SVG) */
        img.header-icon {
            width: 32px !important;
            height: 32px !important;
            object-fit: contain;
        }
        
        @media (max-width: 768px) {
            .header-icon {
                width: 20px !important;
                height: 20px !important;
            }
            
            img.header-icon {
                width: 24px !important;
                height: 24px !important;
            }
        }
        
        /* Main Content */
        .app-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
            width: 100%;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            background: var(--color-white);
            padding: 4px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }
        
        .tab-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            font-size: 0.9375rem;
            font-weight: var(--font-weight-medium);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .tab-btn svg {
            width: 20px;
            height: 20px;
        }
        
        .tab-btn.active {
            background: var(--color-blue);
            color: var(--color-white);
        }
        
        .tab-btn:hover:not(.active) {
            background: var(--color-background);
        }
        
        /* ‚úÖ NOVO: Badge de alertas no bot√£o tab */
        .alert-badge {
            background: #d32f2f;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7rem;
            margin-left: 6px;
            font-weight: var(--font-weight-semibold);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* ‚úÖ NOVO: Badges de status de stock */
        .badge-critico {
            background: #d32f2f;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: var(--font-weight-semibold);
        }
        
        .badge-alerta {
            background: #f57c00;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: var(--font-weight-semibold);
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ‚úÖ CORRE√á√ÉO v3.6.22: Esconder tabs durante carregamento (evita flash) */
        body.app-loading .tab-content {
            visibility: hidden !important;
        }
        
        body.app-loading .tabs {
            visibility: hidden !important;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Card */
        .card {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-lg);
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-lg);
            color: var(--color-text-primary);
        }
        
        /* Form */
        .maintenance-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .form-label {
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }
        
        .form-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-family: var(--font-family);
            color: var(--color-text-primary);
            background: var(--color-white);
            transition: all var(--transition-fast);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--color-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }
        
        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }
        
        select.form-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2386868B' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }
        
        /* Priority Selector */
        .priority-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
        }
        
        .priority-option {
            position: relative;
            cursor: pointer;
        }
        
        .priority-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        .priority-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-md);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            transition: all var(--transition-fast);
        }
        
        .priority-label svg {
            width: 24px;
            height: 24px;
        }
        
        .priority-alta .priority-label {
            color: var(--color-alta);
        }
        
        .priority-media .priority-label {
            color: var(--color-media);
        }
        
        .priority-baixa .priority-label {
            color: var(--color-baixa);
        }
        
        .priority-option input[type="radio"]:checked + .priority-label {
            border-width: 2px;
        }
        
        .priority-alta input[type="radio"]:checked + .priority-label {
            border-color: var(--color-alta);
            background: rgba(255, 59, 48, 0.05);
        }
        
        .priority-media input[type="radio"]:checked + .priority-label {
            border-color: var(--color-media);
            background: rgba(255, 149, 0, 0.05);
        }
        
        .priority-baixa input[type="radio"]:checked + .priority-label {
            border-color: var(--color-baixa);
            background: rgba(52, 199, 89, 0.05);
        }
        
        /* ‚úÖ Priority Selector Inline (Modal) */
        .detail-priority-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .priority-option-inline {
            cursor: pointer;
            position: relative;
        }
        
        .priority-option-inline input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .priority-badge svg {
            width: 14px;
            height: 14px;
        }
        
        .priority-alta {
            color: #ff3b30;
            background: rgba(255, 59, 48, 0.1);
        }
        
        .priority-option-inline.active .priority-alta,
        .priority-option-inline:hover .priority-alta {
            border-color: #ff3b30;
            background: rgba(255, 59, 48, 0.2);
        }
        
        .priority-media {
            color: #ff9500;
            background: rgba(255, 149, 0, 0.1);
        }
        
        .priority-option-inline.active .priority-media,
        .priority-option-inline:hover .priority-media {
            border-color: #ff9500;
            background: rgba(255, 149, 0, 0.2);
        }
        
        .priority-baixa {
            color: #34c759;
            background: rgba(52, 199, 89, 0.1);
        }
        
        .priority-option-inline.active .priority-baixa,
        .priority-option-inline:hover .priority-baixa {
            border-color: #34c759;
            background: rgba(52, 199, 89, 0.2);
        }
        
        /* File Upload */
        .file-upload {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--color-text-secondary);
            font-size: 0.9375rem;
        }
        
        .file-label svg {
            width: 24px;
            height: 24px;
            color: var(--color-blue);
        }
        
        .file-label:hover {
            border-color: var(--color-blue);
            background: rgba(0, 122, 255, 0.03);
        }
        
        .image-preview {
            display: none;
            position: relative;
        }
        
        .image-preview.active {
            display: block;
        }
        
        .image-preview img {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: var(--radius-md);
        }
        
        .image-preview .remove-image {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: var(--color-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            backdrop-filter: blur(10px);
        }
        
        .image-preview .remove-image svg {
            width: 16px;
            height: 16px;
        }
        
        .image-preview .remove-image:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-full);
            font-size: 1rem;
            font-weight: var(--font-weight-medium);
            font-family: var(--font-family);
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
        }
        
        .btn svg {
            width: 20px;
            height: 20px;
        }
        
        .btn-primary {
            background: var(--color-blue);
            color: var(--color-white);
        }
        
        .btn-primary:hover {
            background: var(--color-blue-dark);
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: var(--color-background);
            color: var(--color-text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--color-border);
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: var(--radius-full);
            background: transparent;
            color: var(--color-blue);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .btn-icon svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
        }
        
        .btn-icon:hover {
            background: var(--color-background);
        }
        
        .btn-text {
            padding: var(--spacing-xs) var(--spacing-md);
            border: none;
            background: transparent;
            color: var(--color-blue);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .btn-text:hover {
            opacity: 0.7;
        }
        
        .form-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            margin-top: var(--spacing-md);
        }
        
        /* Filters */
        .filters-card {
            margin-bottom: var(--spacing-lg);
        }
        
        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .filters-header h3 {
            font-size: 1.125rem;
            font-weight: var(--font-weight-semibold);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .filter-label {
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            cursor: pointer;
            font-size: 0.9375rem;
            color: var(--color-text-primary);
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--color-blue);
        }
        
        /* Filter Options - Grid Layout */
        .filter-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }
        
        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            cursor: pointer;
            font-size: 0.9375rem;
            color: var(--color-text-primary);
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: background-color var(--transition-fast);
        }
        
        .filter-checkbox:hover {
            background-color: var(--color-background);
        }
        
        .filter-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--color-blue);
        }
        
        .filter-checkbox span {
            user-select: none;
        }
        
        /* List Header */
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .list-info {
            font-size: 0.9375rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
        }
        
        /* Requests List */
        .requests-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .request-card {
            background: var(--color-white);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid transparent;
        }
        
        .request-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--color-border);
            transform: translateY(-2px);
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        
        .request-badges {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-tipo {
            background: var(--color-background);
            color: var(--color-text-primary);
        }
        
        .badge-prioridade {
            color: var(--color-white);
        }
        
        .badge-prioridade.alta {
            background: var(--color-alta);
        }
        
        .badge-prioridade.media {
            background: var(--color-media);
        }
        
        .badge-prioridade.baixa {
            background: var(--color-baixa);
        }
        
        .badge-estado {
            color: var(--color-white);
        }
        
        .badge-estado.novo {
            background: var(--color-novo);
        }
        
        .badge-estado.emcurso {
            background: var(--color-emcurso);
        }
        
        .badge-estado.resolvido {
            background: var(--color-resolvido);
        }
        
        .request-date {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
        }
        
        .request-body {
            margin-bottom: var(--spacing-sm);
        }
        
        .request-body h4 {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: 4px;
        }
        
        .request-body p {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .request-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--color-background);
        }
        
        .request-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }
        
        .request-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .request-meta svg {
            width: 16px;
            height: 16px;
        }
        
        .request-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .request-actions .btn-icon {
            width: 32px;
            height: 32px;
        }
        
        .request-actions .btn-icon svg {
            width: 18px;
            height: 18px;
        }
        
        /* Empty State */
        .empty-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
            text-align: center;
        }
        
        .empty-state.active {
            display: flex;
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-md);
        }
        
        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-xs);
        }
        
        .empty-state p {
            font-size: 0.9375rem;
            color: var(--color-text-secondary);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            animation: fadeIn var(--transition-base);
        }
        
        .modal-content {
            position: relative;
            background: var(--color-white);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            animation: slideUp var(--transition-base);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--color-background);
        }
        
        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: var(--font-weight-semibold);
        }
        
        .btn-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--color-background);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .btn-close svg {
            width: 16px;
            height: 16px;
        }
        
        .btn-close:hover {
            background: var(--color-border);
        }
        
        .modal-body {
            padding: var(--spacing-lg);
            overflow-y: auto;
        }
        
        .detail-group {
            margin-bottom: var(--spacing-lg);
        }
        
        .detail-label {
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 1rem;
            color: var(--color-text-primary);
        }
        
        .detail-badges {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }
        
        .detail-image {
            width: 100%;
            border-radius: var(--radius-md);
            margin-top: var(--spacing-xs);
        }
        
        .modal-actions {
            display: flex;
            gap: var(--spacing-sm);
            padding: var(--spacing-lg);
            border-top: 1px solid var(--color-background);
            background: var(--color-background);
        }
        
        .modal-actions .btn {
            flex: 1;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            pointer-events: none;
        }
        
        .toast {
            background: var(--color-white);
            color: var(--color-text-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            min-width: 300px;
            pointer-events: auto;
            animation: slideInRight var(--transition-base);
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .toast.success {
            border-left: 4px solid var(--color-resolvido);
        }
        
        .toast.error {
            border-left: 4px solid var(--color-alta);
        }
        
        .toast.info {
            border-left: 4px solid var(--color-blue);
        }
        
        .toast svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .toast.success svg {
            color: var(--color-resolvido);
        }
        
        .toast.error svg {
            color: var(--color-alta);
        }
        
        .toast.info svg {
            color: var(--color-blue);
        }
        
        .toast-message {
            flex: 1;
            font-size: 0.9375rem;
        }
        
        /* Loading State */
        .btn.loading {
            pointer-events: none;
            opacity: 0.7;
            position: relative;
        }
        
        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* ===================================
           Manuten√ß√µes Aut√≥nomas Tab
           =================================== */
        
        .card-description {
            color: var(--color-text-secondary);
            font-size: 0.9375rem;
            line-height: 1.6;
            margin-bottom: var(--spacing-lg);
        }
        
        /* PDF Actions */
        .pdf-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
            flex-wrap: wrap;
        }
        
        .pdf-actions .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .pdf-actions .btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* PDF Viewer Container */
        .pdf-viewer-container {
            margin-top: var(--spacing-lg);
            padding: 0;
            overflow: hidden;
        }
        
        .pdf-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
            background-color: var(--color-background);
        }
        
        .pdf-viewer-header h3 {
            font-size: 1.125rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: 0;
        }
        
        .pdf-viewer {
            width: 100%;
            height: 80vh;
            min-height: 600px;
            background-color: #525659;
            position: relative;
        }
        
        .pdf-viewer iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Loading State for PDF */
        .pdf-viewer.loading::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .pdf-viewer.loading::after {
            content: 'Carregando PDF...';
            position: absolute;
            top: calc(50% + 40px);
            left: 50%;
            transform: translateX(-50%);
            color: var(--color-white);
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            html {
                font-size: 14px;
            }
            
            body {
                overflow-x: hidden;
            }
            
            .app-main {
                padding: 12px;
            }
            
            .header-content {
                padding: 10px 12px;
            }
            
            .app-header h1 {
                font-size: 1rem !important;
                gap: 6px !important;
            }
            
            .app-header h1 svg,
            .header-icon {
                width: 18px !important;
                height: 18px !important;
            }
            
            img.header-icon {
                width: 20px !important;
                height: 20px !important;
            }
            
            .btn-icon {
                width: 32px !important;
                height: 32px !important;
                padding: 6px !important;
            }
            
            .btn-icon svg {
                width: 18px !important;
                height: 18px !important;
            }
            
            .tab-nav {
                padding: 4px;
                gap: 4px;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-btn {
                flex: 0 0 auto !important;
                font-size: 0.7rem !important;
                padding: 8px 12px !important;
                min-width: 80px;
                flex-direction: column !important;
                gap: 4px !important;
            }
            
            .tab-btn svg {
                width: 20px !important;
                height: 20px !important;
                margin: 0 !important;
            }
            
            .card {
                padding: var(--spacing-md);
            }
            
            .card-title {
                font-size: 1.25rem;
            }
            
            .priority-selector {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions .btn {
                width: 100%;
            }
            
            .modal {
                padding: 0;
            }
            
            .modal-content {
                max-height: 100vh;
                border-radius: 0;
            }
            
            .toast-container {
                left: var(--spacing-sm);
                right: var(--spacing-sm);
                top: var(--spacing-sm);
            }
            
            .toast {
                min-width: auto;
            }
        }
        
        /* Planeamento / Planning Grid */
        .planning-controls {
            margin-bottom: var(--spacing-lg);
        }
        
        .planning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        
        .planning-header h2 {
            margin: 0;
        }
        
        .planning-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .planning-range {
            font-size: 0.9375rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            padding: 0 var(--spacing-sm);
        }
        
        .planning-filters {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
        
        .planning-grid-container {
            overflow-x: auto;
            padding: 0;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }
        
        .planning-scroll {
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }
        
        .planning-grid {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .planning-grid th,
        .planning-grid td {
            padding: var(--spacing-sm);
            text-align: center;
            border: 1px solid var(--color-border);
        }
        
        .planning-grid th {
            background: var(--color-background);
            font-weight: var(--font-weight-semibold);
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.875rem;
        }
        
        .planning-grid th.task-header {
            text-align: left;
            min-width: 250px;
            max-width: 350px;
        }
        
        .planning-grid th.responsible-header {
            text-align: left;
            min-width: 120px;
            width: 150px;
        }
        
        .planning-grid th.hours-header {
            text-align: center;
            min-width: 80px;
            width: 80px;
        }
        
        .planning-grid th.date-header {
            min-width: 70px;
            writing-mode: horizontal-tb;
        }
        
        .planning-grid th.weekend {
            background: #f0f0f0;
            color: var(--color-text-secondary);
        }
        
        .planning-grid td.task-cell {
            text-align: left;
            font-size: 0.875rem;
            background: var(--color-white);
        }
        
        .planning-grid td.responsible-cell {
            text-align: left;
            font-size: 0.875rem;
            background: var(--color-white);
            color: var(--color-text-primary);
            font-weight: var(--font-weight-medium);
            padding: var(--spacing-xs);
        }
        
        /* ‚úÖ NOVO: Estilo para select de respons√°vel */
        .planning-grid .responsible-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 0.875rem;
            background-color: var(--color-white);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: border-color 0.2s ease;
        }
        
        .planning-grid .responsible-select:hover {
            border-color: var(--color-primary);
        }
        
        .planning-grid .responsible-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .planning-grid td.hours-cell {
            text-align: center;
            background: var(--color-white);
            padding: var(--spacing-xs);
        }
        
        .hours-input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            text-align: center;
            font-family: var(--font-family);
            transition: all var(--transition-fast);
        }
        
        .hours-input:focus {
            outline: none;
            border-color: var(--color-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .hours-input::-webkit-inner-spin-button,
        .hours-input::-webkit-outer-spin-button {
            opacity: 1;
        }
        
        .planning-grid td.date-cell {
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--color-white);
            position: relative;
        }
        
        .planning-grid td.date-cell:hover {
            background: var(--color-background);
        }
        
        .planning-grid td.date-cell.allocated {
            background: var(--color-blue);
            color: var(--color-white);
            font-weight: var(--font-weight-bold);
        }
        
        .planning-grid td.date-cell.allocated::after {
            content: 'X';
            font-size: 1.125rem;
        }
        
        .planning-grid td.date-cell.weekend {
            background: #f9f9f9;
        }
        
        .planning-grid td.date-cell.weekend:hover {
            background: #f0f0f0;
        }
        
        .planning-grid td.date-cell.weekend.allocated {
            background: var(--color-blue);
            opacity: 0.8;
        }
        
        .task-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .task-title {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .task-meta {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }
        
        .task-responsible {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .task-responsible svg {
            width: 12px;
            height: 12px;
        }
        
        .planning-legend {
            margin-top: var(--spacing-lg);
        }
        
        .planning-legend h3 {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-md);
        }
        
        .legend-items {
            display: flex;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
        }
        
        .legend-box {
            width: 40px;
            height: 30px;
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-weight: var(--font-weight-bold);
        }
        
        .legend-box.allocated {
            background: var(--color-blue);
            color: var(--color-white);
        }
        
        .legend-box.weekend {
            background: #f9f9f9;
        }
        
        /* Responsivo - Planeamento */
        @media (max-width: 768px) {
            .planning-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .planning-actions {
                justify-content: space-between;
            }
            
            .planning-filters {
                flex-direction: column;
            }
            
            .planning-filters .btn {
                width: 100%;
            }
            
            .planning-grid {
                min-width: 600px;
            }
            
            .planning-grid th.task-header {
                min-width: 150px;
                max-width: 150px;
                font-size: 0.75rem;
            }
            
            .planning-grid th.responsible-header {
                min-width: 80px;
                font-size: 0.7rem;
            }
            
            .planning-grid th.hours-header {
                min-width: 50px;
                font-size: 0.7rem;
            }
            
            .planning-grid th.date-header {
                min-width: 50px;
                font-size: 0.7rem;
                padding: 4px;
            }
            
            .planning-grid td {
                padding: 6px;
                font-size: 0.75rem;
            }
            
            .hours-input {
                width: 45px;
                font-size: 0.75rem;
                padding: 2px 4px;
            }
            
            .legend-items {
                flex-direction: column;
            }
            
            /* PDF Viewer Mobile */
            .pdf-actions {
                flex-direction: column;
                gap: var(--spacing-xs);
            }
            
            .pdf-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            .pdf-viewer {
                height: 70vh;
                min-height: 400px;
            }
            
            .pdf-viewer-header {
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            .pdf-viewer-header h3 {
                font-size: 1rem;
            }
        }
        
        /* Mobile Pequeno (iPhone SE, etc) */
        @media (max-width: 480px) {
            .app-header h1 {
                font-size: 0.9rem !important;
            }
            
            .tab-btn {
                font-size: 0.65rem !important;
                padding: 6px 10px !important;
                min-width: 70px;
            }
            
            .tab-btn svg {
                width: 18px !important;
                height: 18px !important;
            }
            
            .app-main {
                padding: var(--spacing-sm);
            }
            
            .card {
                padding: var(--spacing-sm);
            }
            
            .card-title {
                font-size: 1.1rem;
            }
            
            .form-group label {
                font-size: 0.875rem;
            }
            
            .form-input,
            .form-select,
            .form-textarea {
                font-size: 0.875rem;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 0.875rem;
            }
            
            .planning-grid {
                min-width: 500px;
            }
            
            .planning-grid th.task-header {
                min-width: 120px;
                max-width: 120px;
            }
            
            .planning-grid th.responsible-header {
                min-width: 70px;
            }
            
            .planning-grid th.hours-header {
                min-width: 45px;
            }
            
            .planning-grid th.date-header {
                min-width: 45px;
                font-size: 0.65rem;
                padding: 2px;
            }
            
            .hours-input {
                width: 40px;
                font-size: 0.7rem;
            }
            
            .request-card {
                padding: var(--spacing-sm);
            }
            
            .request-header h3 {
                font-size: 1rem;
            }
            
            .badge {
                font-size: 0.7rem;
                padding: 2px 8px;
            }
            
            .pdf-viewer {
                height: 60vh;
                min-height: 300px;
            }
        }
        
        /* Mobile Extra Pequeno (iPhone 12/13/14 width) */
        @media (max-width: 400px) {
            .app-header h1 {
                font-size: 0.85rem !important;
            }
            
            .tab-btn {
                font-size: 0.6rem !important;
                padding: 6px 8px !important;
                min-width: 65px;
            }
            
            .tab-btn svg {
                width: 16px !important;
                height: 16px !important;
            }
        }
        
        /* Fix espec√≠fico Chrome iOS */
        @supports (-webkit-touch-callout: none) {
            @media (max-width: 768px) {
                .tab-btn {
                    -webkit-tap-highlight-color: transparent;
                    touch-action: manipulation;
                }
                
                .app-main {
                    padding: 10px !important;
                }
            }
        }
        
        /* Print Styles */
        @media print {
            @page {
                size: A4;
                margin: 12mm;
            }
            
            /* Esconder tudo exceto printContainer */
            body > *:not(#printContainer) {
                display: none !important;
            }
            
            /* Mostrar apenas o container de impress√£o */
            #printContainer {
                display: block !important;
                width: 100%;
                max-width: 186mm;
                margin: 0;
                padding: 0;
                font-family: Arial, sans-serif;
                font-size: 9pt;
                line-height: 1.3;
                color: #000;
            }
            
            #printContainer h1 {
                text-align: center;
                color: #667eea;
                border-bottom: 2px solid #667eea;
                padding-bottom: 6px;
                margin: 0 0 10px 0;
                font-size: 16pt;
            }
            
            #printContainer .print-header {
                text-align: center;
                margin-bottom: 12px;
                font-size: 9pt;
            }
            
            #printContainer .print-header p {
                margin: 2px 0;
            }
            
            #printContainer .print-section {
                margin-bottom: 10px;
                page-break-inside: avoid;
            }
            
            #printContainer .print-section h2 {
                color: #667eea;
                border-bottom: 1px solid #667eea;
                padding-bottom: 3px;
                margin: 0 0 6px 0;
                font-size: 12pt;
            }
            
            #printContainer table {
                width: 100%;
                border-collapse: collapse;
            }
            
            #printContainer td {
                padding: 3px 6px;
                border-bottom: 1px solid #ddd;
                vertical-align: top;
                font-size: 9pt;
            }
            
            #printContainer td:first-child {
                font-weight: bold;
                width: 38%;
            }
            
            #printContainer .description {
                white-space: pre-wrap;
                word-wrap: break-word;
                font-size: 9pt;
                line-height: 1.4;
            }
            
            #printContainer .photo-section {
                page-break-before: always;
                text-align: center;
            }
            
            #printContainer .photo-section img {
                max-width: 100%;
                max-height: 250mm;
                height: auto;
                display: block;
                margin: 8px auto;
            }
            
            #printContainer .print-footer {
                margin-top: 15px;
                padding-top: 8px;
                border-top: 1px solid #999;
                text-align: center;
                color: #666;
                font-size: 8pt;
            }
            
            #printContainer .print-footer p {
                margin: 2px 0;
            }
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* ===================================
           STOCK MODULE - ESTILOS
           =================================== */
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        
        .stock-search {
            flex: 1;
            min-width: 250px;
            max-width: 500px;
        }
        
        .stock-filters {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
        
        .familia-selector {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-white);
            font-family: var(--font-family);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .familia-selector:focus {
            outline: none;
            border-color: var(--color-blue);
        }
        
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }
        
        .stock-card {
            background: var(--color-white);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
            border: 1px solid var(--color-border);
        }
        
        .stock-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .stock-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        
        .stock-familia-badge {
            font-size: 0.75rem;
            font-weight: var(--font-weight-semibold);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            background: rgba(0, 122, 255, 0.1);
            color: var(--color-blue);
            white-space: nowrap;
        }
        
        .stock-card-title {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: var(--spacing-xs) 0;
            line-height: 1.3;
        }
        
        .stock-card-ref {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            font-family: 'Courier New', monospace;
        }
        
        .stock-info {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            margin: var(--spacing-md) 0;
            padding: var(--spacing-sm);
            background: var(--color-background);
            border-radius: var(--radius-sm);
        }
        
        .stock-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
        
        .stock-info-label {
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
        }
        
        .stock-info-value {
            color: var(--color-text-primary);
            font-weight: var(--font-weight-semibold);
        }
        
        .stock-level {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .stock-level.baixo {
            color: var(--color-alta);
        }
        
        .stock-level.ok {
            color: var(--color-baixa);
        }
        
        .stock-level-icon {
            font-size: 1.2rem;
        }
        
        .stock-card-actions {
            display: flex;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-md);
        }
        
        .stock-btn {
            flex: 1;
            padding: var(--spacing-sm);
            border: none;
            border-radius: var(--radius-sm);
            font-family: var(--font-family);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
        }
        
        .stock-btn-primary {
            background: var(--color-blue);
            color: var(--color-white);
        }
        
        .stock-btn-primary:hover {
            background: var(--color-blue-dark);
        }
        
        .stock-btn-secondary {
            background: var(--color-background);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }
        
        .stock-btn-secondary:hover {
            background: var(--color-border);
        }
        
        .stock-alerts {
            margin-bottom: var(--spacing-lg);
        }
        
        .alert-card {
            background: #FFF3CD;
            border: 1px solid #FFC107;
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .alert-card.critical {
            background: #F8D7DA;
            border-color: #F5C6CB;
        }
        
        .alert-title {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .alert-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .alert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-xs);
            background: rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }
        
        .movimento-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .artigo-selected-info {
            background: var(--color-background);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }
        
        .artigo-selected-info h4 {
            margin-bottom: var(--spacing-xs);
            color: var(--color-text-primary);
        }
        
        .artigo-selected-info p {
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            margin: 4px 0;
        }
        
        .quantidade-input-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .quantidade-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background: var(--color-white);
            color: var(--color-text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .quantidade-btn:hover {
            background: var(--color-background);
            border-color: var(--color-blue);
        }
        
        .quantidade-input {
            flex: 1;
            text-align: center;
            font-size: 1.2rem;
            font-weight: var(--font-weight-semibold);
        }
        
        .artigos-list {
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            background: var(--color-background);
            margin-top: var(--spacing-md);
        }
        
        .artigos-list-title {
            font-size: 0.875rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .artigo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm);
            background: var(--color-white);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-xs);
        }
        
        .artigo-item-info {
            flex: 1;
        }
        
        .artigo-item-name {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            font-size: 0.875rem;
        }
        
        .artigo-item-details {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            margin-top: 2px;
        }
        
        .artigo-item-remove {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--color-alta);
            color: var(--color-alta);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all var(--transition-fast);
        }
        
        .artigo-item-remove:hover {
            background: var(--color-alta);
            color: var(--color-white);
        }
        
        .artigos-total {
            margin-top: var(--spacing-sm);
            padding-top: var(--spacing-sm);
            border-top: 2px solid var(--color-border);
            font-weight: var(--font-weight-semibold);
            text-align: right;
            color: var(--color-text-primary);
        }
        
        @media (max-width: 768px) {
            .stock-grid {
                grid-template-columns: 1fr;
            }
            
            .stock-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stock-search {
                max-width: none;
            }
        }
        
        /* ===================================
           STOCK MODULE - NOVOS ESTILOS
           =================================== */
        
        .card-header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }
        
        .stock-table-container {
            overflow-x: auto;
            margin-top: var(--spacing-md);
        }
        
        .stock-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-white);
            font-size: 0.875rem;
        }
        
        .stock-table thead {
            background: var(--color-background);
            position: sticky;
            top: 0;
        }
        
        .stock-table th {
            padding: var(--spacing-sm) var(--spacing-md);
            text-align: left;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            border-bottom: 2px solid var(--color-border);
            white-space: nowrap;
        }
        
        .stock-table td {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
            vertical-align: middle;
        }
        
        .stock-table tbody tr:hover {
            background: var(--color-background);
        }
        
        .stock-value {
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }
        
        .stock-value.baixo {
            color: var(--color-alta);
        }
        
        .stock-value.ok {
            color: var(--color-baixa);
        }
        
        .stock-actions {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: nowrap;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.75rem;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: var(--font-weight-semibold);
            white-space: nowrap;
        }
        
        .badge-entrada {
            background: rgba(52, 199, 89, 0.1);
            color: var(--color-baixa);
        }
        
        .badge-saida {
            background: rgba(255, 59, 48, 0.1);
            color: var(--color-alta);
        }
        
        .badge-ajuste {
            background: rgba(255, 149, 0, 0.1);
            color: var(--color-media);
        }
        
        .empty-state-small {
            text-align: center;
            padding: var(--spacing-lg);
            color: var(--color-text-secondary);
            font-size: 0.875rem;
        }
        
        /* üìö ESTILOS DE MANUAIS */
        .manual-card {
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            transition: all 0.3s ease;
        }
        
        .manual-card:hover {
            box-shadow: 0 4px 12px var(--color-shadow);
            border-color: var(--color-blue);
        }
        
        .manual-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        
        .manual-card-title {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: 0 0 4px 0;
        }
        
        .manual-card-equipment {
            font-size: 0.875rem;
            color: var(--color-blue);
            font-weight: var(--font-weight-medium);
        }
        
        .manual-card-description {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            margin: var(--spacing-sm) 0;
            line-height: 1.5;
        }
        
        .manual-card-meta {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            margin: var(--spacing-sm) 0;
        }
        
        .manual-card-actions {
            display: flex;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
        }
        
        .manual-status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
        }
        
        .manual-status-processado {
            background: rgba(52, 199, 89, 0.1);
            color: var(--color-baixa);
        }
        
        .manual-status-pendente {
            background: rgba(255, 159, 10, 0.1);
            color: var(--color-media);
        }
        
        .stock-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: var(--spacing-md) 0 var(--spacing-sm) 0;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--color-border);
        }
        
        .movimento-filters {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }
        
        .movimento-filters .form-input {
            flex: 1;
            min-width: 150px;
        }
        
        .quantidade-badge {
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
        }
        
        .quantidade-badge.negativo {
            color: var(--color-alta);
        }
        
        .quantidade-badge.positivo {
            color: var(--color-baixa);
        }
        
        .badge-entrada {
            background: rgba(52, 199, 89, 0.1);
            color: var(--color-baixa);
        }
        
        .badge-saida {
            background: rgba(255, 59, 48, 0.1);
            color: var(--color-alta);
        }
        
        .badge-ajuste {
            background: rgba(255, 149, 0, 0.1);
            color: var(--color-media);
        }
        
        .stock-actions {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.75rem;
        }
        
        .stock-value {
            font-weight: var(--font-weight-semibold);
        }
        
        .stock-value.baixo {
            color: var(--color-alta);
        }
        
        .stock-value.ok {
            color: var(--color-baixa);
        }
        
        .artigo-selected-info {
            padding: var(--spacing-md);
            background: var(--color-background);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }
        
        .artigo-selected-info h4 {
            margin-bottom: var(--spacing-xs);
            color: var(--color-text-primary);
        }
        
        .artigo-selected-info p {
            margin: var(--spacing-xs) 0;
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }
        
        /* Sec√ß√£o de Novo Movimento - Destacada */
        .card .btn-primary svg {
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Stock Cards Grid */
        .stock-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }
        
        .stock-card {
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        
        .stock-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .stock-card-header {
            margin-bottom: var(--spacing-sm);
        }
        
        .stock-card-title {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-xs);
        }
        
        .stock-card-ref {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            font-family: 'Courier New', monospace;
        }
        
        .stock-card-body {
            margin-bottom: var(--spacing-md);
        }
        
        .stock-card-info {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
        }
        
        .stock-card-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stock-card-info-label {
            color: var(--color-text-secondary);
        }
        
        .stock-card-info-value {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }
        
        .stock-card-stock {
            background: var(--color-background);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            margin: var(--spacing-sm) 0;
            text-align: center;
        }
        
        .stock-card-stock-label {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .stock-card-stock-value {
            font-size: 1.5rem;
            font-weight: var(--font-weight-bold);
        }
        
        .stock-card-stock-value.baixo {
            color: var(--color-alta);
        }
        
        .stock-card-stock-value.ok {
            color: var(--color-baixa);
        }
        
        .stock-card-footer {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .stock-card-footer .btn {
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .stock-cards-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .stock-table {
                font-size: 0.75rem;
            }
            
            .stock-table th,
            .stock-table td {
                padding: var(--spacing-xs) var(--spacing-sm);
            }
            
            .stock-actions {
                flex-direction: column;
            }
            
            .card-header-flex {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* ===================================
           TOAST NOTIFICATIONS
           =================================== */
        
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            pointer-events: none;
        }
        
        .toast {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--color-white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 300px;
            max-width: 400px;
            pointer-events: auto;
            animation: slideInRight 0.3s ease;
        }
        
        .toast svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .toast.success {
            border-left: 4px solid var(--color-baixa);
        }
        
        .toast.success svg {
            color: var(--color-baixa);
        }
        
        .toast.error {
            border-left: 4px solid var(--color-alta);
        }
        
        .toast.error svg {
            color: var(--color-alta);
        }
        
        .toast.info {
            border-left: 4px solid var(--color-blue);
        }
        
        .toast.info svg {
            color: var(--color-blue);
        }
        
        .toast-message {
            flex: 1;
            font-size: 0.875rem;
            color: var(--color-text-primary);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        @media (max-width: 768px) {
            .toast-container {
                top: 60px;
                right: 10px;
                left: 10px;
            }
            
            .toast {
                min-width: auto;
                max-width: none;
            }
        }
        
        /* ============================================
           LOADING SPINNER - Feedback visual durante carregamento
           ============================================ */
        
        .loading-spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .loading-spinner-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner-content {
            background: white;
            padding: 40px 60px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .spinner-circle {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner-message {
            margin: 0;
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .loading-spinner-content {
                padding: 30px 40px;
            }
            
            .spinner-circle {
                width: 50px;
                height: 50px;
                border-width: 4px;
            }
            
            .spinner-message {
                font-size: 14px;
            }
        }
        
        /* ============================================
           LOGIN SCREEN - APPLE CLEAN STYLE
           ============================================ */
        
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FFFFFF;
            display: none; /* Escondido por padr√£o - JS mostra se necess√°rio */
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-screen.show {
            display: flex; /* Mostrar quando JS adicionar classe .show */
        }
        
        .login-card-wrapper {
            width: 100%;
            max-width: 420px;
            padding: 20px;
        }
        
        .login-card-apple {
            background: #FFFFFF;
            border-radius: 20px;
            padding: 48px 40px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            border: 1px solid #E5E5E7;
            text-align: center;
            animation: fadeInUp 0.4s ease;
        }
        
        .login-logo-container {
            margin-bottom: 32px;
        }
        
        .login-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            display: block;
            /* Remover fundo branco da imagem */
            border-radius: 50%;
            padding: 10px;
            background: transparent;
            /* Adicionar sombra suave para destacar */
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.1));
        }
        
        img.login-logo {
            width: 140px !important;
            height: 140px !important;
            object-fit: contain;
            border-radius: 0;
            padding: 0;
        }
        
        .login-title-apple {
            font-size: 28px;
            font-weight: 600;
            color: #1D1D1F;
            margin: 0 0 8px 0;
            letter-spacing: -0.5px;
        }
        
        .login-subtitle-apple {
            font-size: 15px;
            color: #86868B;
            margin: 0 0 32px 0;
            font-weight: 400;
        }
        
        .login-form-apple {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .login-input-wrapper {
            position: relative;
        }
        
        .login-input-apple {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid #D2D2D7;
            border-radius: 12px;
            font-size: 17px;
            font-family: var(--font-family);
            background: #FAFAFA;
            color: #1D1D1F;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }
        
        .login-input-apple::placeholder {
            color: #86868B;
        }
        
        .login-input-apple:focus {
            outline: none;
            border-color: #1D1D1F;
            background: #FFFFFF;
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.03);
        }
        
        .login-button-apple {
            width: 100%;
            padding: 16px 24px;
            background: #1D1D1F;
            color: #FFFFFF;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s ease;
            font-family: var(--font-family);
        }
        
        .login-button-apple:hover {
            background: #000000;
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        
        .login-button-apple:active {
            transform: translateY(0);
        }
        
        .login-button-apple:disabled {
            background: #D2D2D7;
            cursor: not-allowed;
            transform: none;
        }
        
        .login-error-apple {
            background: #FFEBEE;
            border: 1px solid #FFCDD2;
            color: #C62828;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            text-align: center;
            margin: 8px 0;
            animation: shake 0.3s;
        }
        
        .login-hint-apple {
            margin-top: 24px;
            padding: 16px;
            background: #F5F5F7;
            border-radius: 12px;
            text-align: left;
        }
        
        .hint-title {
            font-size: 13px;
            font-weight: 600;
            color: #1D1D1F;
            margin-bottom: 8px;
        }
        
        .hint-credentials {
            font-size: 13px;
            color: #86868B;
            line-height: 1.6;
        }
        
        .hint-label {
            color: #1D1D1F;
            font-weight: 500;
        }
        
        .hint-credentials code {
            background: #FFFFFF;
            padding: 3px 8px;
            border-radius: 6px;
            color: #1D1D1F;
            font-size: 13px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            border: 1px solid #E5E5E7;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        @media (max-width: 768px) {
            .login-card-apple {
                padding: 36px 28px;
            }
            
            .login-title-apple {
                font-size: 24px;
            }
            
            .login-logo {
                width: 80px;
                height: 80px;
            }
            
            img.login-logo {
                width: 100px !important;
                height: 100px !important;
                object-fit: contain;
            }
        }
        
        /* Estilos antigos mantidos para compatibilidade */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FFFFFF;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-overlay.hidden { display: none; }
        
        .login-btn {
            background: #1D1D1F;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        
        .login-btn:hover { transform: translateY(-2px); }
        .login-btn:active { transform: translateY(0); }
        .login-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .login-error {
            background: #ffebee;
            border: 1px solid #ef5350;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            animation: shake 0.3s;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
            margin-right: 12px;
        }
        
        .user-info .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-primary);
        }
        
        .user-info .user-dept {
            font-size: 12px;
            color: var(--color-text-secondary);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }
        
        .logout-btn {
            background: transparent !important;
            border: 1px solid var(--color-border) !important;
            color: var(--color-text-primary) !important;
            width: 40px !important;
            height: 40px !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: var(--color-background);
            border-color: var(--color-blue);
            color: var(--color-blue);
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* ===================================
           TAB AN√ÅLISE - Gr√°ficos e Chatbot
           =================================== */
        
        /* Analytics Cards */
        .analytics-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        
        .analytics-card {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            border: 1px solid var(--color-border);
            transition: all var(--transition-base);
        }
        
        .analytics-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .analytics-card-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .analytics-card-icon svg {
            width: 28px;
            height: 28px;
        }
        
        .analytics-card-content {
            flex: 1;
        }
        
        .analytics-card-label {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-xs);
        }
        
        .analytics-card-value {
            font-size: 2rem;
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
        }
        
        .analytics-card-trend {
            font-size: 0.875rem;
            margin-top: var(--spacing-xs);
        }
        
        .analytics-card-trend.up {
            color: #f44336;
        }
        
        .analytics-card-trend.down {
            color: #4CAF50;
        }
        
        /* Analytics Filters */
        .analytics-filters {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
        }
        
        .analytics-filters .form-input {
            flex: 1;
            min-width: 200px;
        }
        
        .analytics-filters .btn {
            white-space: nowrap;
        }
        
        /* Analytics Charts */
        .analytics-chart-container {
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: var(--color-white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }
        
        .analytics-chart-title {
            font-size: 1.125rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-lg);
            color: var(--color-text-primary);
        }
        
        .analytics-chart-container canvas {
            max-height: 400px;
        }
        
        /* Filtros de An√°lise */
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            background: var(--color-white);
            color: var(--color-text-primary);
            cursor: pointer;
            font-size: 13px;
            font-family: var(--font-family);
            transition: all 0.2s ease;
        }
        
        .filter-btn:hover {
            background: var(--color-background);
        }
        
        .filter-btn.active {
            background: var(--color-blue);
            color: var(--color-white);
            border-color: var(--color-blue);
        }
        
        /* Filtros de Documentos */
        .filter-chip {
            padding: 8px 16px;
            border: 1px solid var(--color-border);
            border-radius: 20px;
            background: var(--color-white);
            color: var(--color-text-primary);
            cursor: pointer;
            font-size: 13px;
            font-family: var(--font-family);
            font-weight: var(--font-weight-medium);
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .filter-chip:hover {
            background: var(--color-background);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .filter-chip.active {
            background: var(--color-blue);
            color: var(--color-white);
            border-color: var(--color-blue);
            box-shadow: 0 2px 12px rgba(0, 122, 255, 0.25);
        }
        
        /* Card de Documento */
        .documento-card {
            padding: 16px;
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .documento-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .documento-card.vencido {
            border-left: 4px solid var(--color-alta);
            background: #FFF5F5;
        }
        
        .documento-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .documento-tipo {
            font-size: 13px;
            font-weight: var(--font-weight-semibold);
            color: var(--color-blue);
        }
        
        .documento-validade {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            background: var(--color-background);
            color: var(--color-text-secondary);
        }
        
        .documento-validade.vencido {
            background: #FFE5E5;
            color: var(--color-alta);
            font-weight: var(--font-weight-semibold);
        }
        
        .documento-descricao {
            font-size: 14px;
            color: var(--color-text-primary);
            margin-bottom: 12px;
            line-height: 1.4;
        }
        
        .documento-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .documento-data {
            font-size: 12px;
            color: var(--color-text-secondary);
        }
        
        .documento-actions {
            display: flex;
            gap: 8px;
        }
        
        .documento-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            background: var(--color-background);
            color: var(--color-text-primary);
            cursor: pointer;
            font-size: 12px;
            font-family: var(--font-family);
            transition: all 0.2s ease;
        }
        
        .documento-btn:hover {
            background: var(--color-blue);
            color: var(--color-white);
        }
        
        .documento-btn.delete:hover {
            background: var(--color-alta);
        }
        
        /* Chatbot */
        .chatbot-history {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            background: var(--color-background);
            border-radius: var(--radius-md);
        }
        
        .chatbot-message {
            margin-bottom: var(--spacing-md);
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .chatbot-message-user {
            justify-content: flex-end;
        }
        
        .chatbot-message-content {
            max-width: 80%;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            line-height: 1.5;
        }
        
        .chatbot-message-assistant .chatbot-message-content {
            background: var(--color-white);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }
        
        .chatbot-message-user .chatbot-message-content {
            background: var(--color-blue);
            color: white;
        }
        
        .chatbot-input-container {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .chatbot-input {
            flex: 1;
            padding: var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-family: var(--font-family);
            font-size: 0.9375rem;
            resize: vertical;
            min-height: 60px;
        }
        
        .chatbot-input:focus {
            outline: none;
            border-color: var(--color-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .chatbot-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            padding: var(--spacing-md);
            background: var(--color-background);
            border-radius: var(--radius-md);
        }
        
        .chatbot-loading {
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
    
    <!-- PDF.js para processar manuais -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script>
        // Configurar worker do PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
            console.log('‚úÖ PDF.js carregado e configurado');
        }
    </script>
    
    <!-- Tesseract.js para OCR (reconhecimento de texto em imagens) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
    <script>
        // Verificar se Tesseract.js carregou
        if (typeof Tesseract !== 'undefined') {
            console.log('‚úÖ Tesseract.js carregado (OCR habilitado)');
        } else {
            console.warn('‚ö†Ô∏è Tesseract.js n√£o carregou (OCR desabilitado)');
        }
    </script>
</head>
<body class="app-loading">
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <h1>
                <img src="/appmanutencao/icons/android-chrome-192x192.png" alt="Logo" class="header-icon" id="headerLogo">
                üè° Tarefas de Casa
            </h1>
            <div class="header-actions">
                <!-- üìö BOT√ÉO DE TESTE REMOVIDO - Usava fun√ß√£o antiga -->
                
                <!-- üö® BOT√ÉO DE ALERTAS (S√ì √çCONE) -->
                <button 
                    id="testarAlertasBtn" 
                    onclick="mostrarAlertasPendentes()" 
                    style="
                        width: 40px;
                        height: 40px;
                        background: #ff6b6b;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 20px;
                        display: none;
                        align-items: center;
                        justify-content: center;
                        margin-right: 12px;
                        transition: all 0.2s;
                        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
                    "
                    onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(255, 107, 107, 0.5)';"
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(255, 107, 107, 0.3)';"
                    title="Ver alertas de produtividade"
                >
                    üö®
                </button>
                
                <div id="userInfo" class="user-info" style="display: none;">
                    <span class="user-name"></span>
                    <span class="user-dept"></span>
                </div>

                <button class="btn-icon logout-btn" id="logoutBtn" title="Terminar Sess√£o" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="app-main">
        
        <!-- Tab Navigation -->
        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="novo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                Nova Tarefa
            </button>
            <button class="tab-btn" data-tab="lista">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
                </svg>
                üìã Lista de Tarefas
            </button>
            <button class="tab-btn" data-tab="stock">
                üõí Compras
            </button>
            <button class="tab-btn" data-tab="novoDocumento">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                Novo Documento
            </button>
            <button class="tab-btn" data-tab="analise">
                üìÑ Documentos
            </button>
            <button class="tab-btn" data-tab="farmacia">
                üíä Farm√°cia
            </button>

        </nav>

        <!-- Nova Tarefa Tab -->
        <section class="tab-content active" id="tab-novo">
            <div class="container">
                <div class="card form-card">
                    <h2 class="card-title">Criar Nova Tarefa</h2>
                    
                    <form id="maintenanceForm" class="maintenance-form">
                        <!-- 1. Tipo de Tarefa -->
                        <div class="form-group">
                            <label class="form-label" for="tipo">Tipo de Tarefa *</label>
                            <select class="form-input" id="tipo" name="tipo" required>
                                <option value="">Selecione o tipo</option>
                                <option value="Casa">üè† Casa</option>
                                <option value="Jardim">üå≥ Jardim</option>
                                <option value="Carro">üöó Carro</option>
                                <option value="Administrativo">üìÑ Administrativo</option>
                                <option value="Compras">üõí Compras</option>
                                <option value="Outros">üìå Outros</option>
                            </select>
                        </div>

                        <!-- 2. Prioridade -->
                        <div class="form-group" id="prioridadeGroup">
                            <label class="form-label">Prioridade *</label>
                            <div class="priority-selector">
                                <label class="priority-option priority-alta">
                                    <input type="radio" name="prioridade" value="Alta" id="prioridadeAlta">
                                    <span class="priority-label">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 2L2 12h3v8h14v-8h3L12 2z"/>
                                        </svg>
                                        Alta
                                    </span>
                                </label>
                                <label class="priority-option priority-media">
                                    <input type="radio" name="prioridade" value="M√©dia" id="prioridadeMedia">
                                    <span class="priority-label">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="10"/>
                                        </svg>
                                        M√©dia
                                    </span>
                                </label>
                                <label class="priority-option priority-baixa">
                                    <input type="radio" name="prioridade" value="Baixa" id="prioridadeBaixa">
                                    <span class="priority-label">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 22L22 12h-3V4H5v8H2l10 10z"/>
                                        </svg>
                                        Baixa
                                    </span>
                                </label>
                            </div>
                        </div>

                        <!-- 3. Zona -->
                        <div class="form-group">
                            <label class="form-label" for="zona">Zona *</label>
                            <select class="form-input" id="zona" name="zona" required>
                                <option value="">Selecione a zona da casa</option>
                                <!-- Preenchido dinamicamente do Supabase -->
                            </select>
                        </div>

                        <!-- 4. Descri√ß√£o -->
                        <div class="form-group">
                            <label class="form-label" for="descricao">Descri√ß√£o da Tarefa *</label>
                            <textarea class="form-input" id="descricao" name="descricao" rows="4" placeholder="Descreve a tarefa a fazer..." required></textarea>
                        </div>

                        <!-- 5. Upload de Foto -->
                        <div class="form-group">
                            <label class="form-label" for="foto">üì∏ Fotografia (opcional, m√°x. 5MB)</label>
                            <div class="file-upload">
                                <input type="file" id="foto" name="foto" accept="image/*" class="file-input" onchange="handleTarefaImage(event)">
                                <label for="foto" class="file-label">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <path d="M21 15l-5-5L5 21"/>
                                    </svg>
                                    <span id="fileName">Escolher imagem</span>
                                </label>
                                <div id="imagePreview" class="image-preview"></div>
                            </div>
                        </div>

                        <!-- 6. Respons√°vel -->
                        <div class="form-group">
                            <label class="form-label" for="nome">Respons√°vel *</label>
                            <input type="text" class="form-input" id="nome" name="nome" placeholder="Quem vai fazer esta tarefa?" required>
                        </div>

                        <!-- Bot√µes -->
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="clearBtn">Limpar</button>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                    <polyline points="17 21 17 13 7 13 7 21"/>
                                    <polyline points="7 3 7 8 15 8"/>
                                </svg>
                                ‚úÖ Criar Tarefa
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Lista de Tarefas Tab -->
        <section class="tab-content" id="tab-lista">
            <div class="container">
                <!-- Filtros -->
                <div class="card filters-card">
                    <div class="filters-header">
                        <h3>Filtros</h3>
                        <button class="btn-text" id="clearFilters">Limpar</button>
                    </div>
                    
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Tipo de Tarefa</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Casa" class="filter-tipo">
                                    <span>üè† Casa</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Jardim" class="filter-tipo">
                                    <span>üå≥ Jardim</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Carro" class="filter-tipo">
                                    <span>üöó Carro</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Administrativo" class="filter-tipo">
                                    <span>üìÑ Administrativo</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Compras" class="filter-tipo">
                                    <span>üõí Compras</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Outros" class="filter-tipo">
                                    <span>üìå Outros</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Prioridade</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Alta" class="filter-prioridade">
                                    <span>Alta</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="M√©dia" class="filter-prioridade">
                                    <span>M√©dia</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Baixa" class="filter-prioridade">
                                    <span>Baixa</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Estado</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Novo" class="filter-estado" checked>
                                    <span>Novo</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Em curso" class="filter-estado" checked>
                                    <span>Em curso</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Resolvido" class="filter-estado">
                                    <span>Resolvido</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">üìç Zona</label>
                            <select id="filterEquipamento" class="form-input" style="width: 100%; margin-top: 8px;">
                                <option value="">Todas as zonas</option>
                                <!-- Populado dinamicamente via JavaScript -->
                            </select>
                        </div>
                        
                        <!-- ‚úÖ v3.7.0.9: NOVO Filtro de Respons√°vel -->
                        <div class="filter-group">
                            <label class="filter-label">üë§ Respons√°vel</label>
                            <select id="filterResponsavel" class="form-input" style="width: 100%; margin-top: 8px;">
                                <option value="">Todos os respons√°veis</option>
                                <!-- Populado dinamicamente via JavaScript -->
                            </select>
                        </div>


                    </div>
                </div>

                <!-- Lista Header -->
                <div class="list-header">
                    <div class="list-info">
                        <span id="listCount">0 pedidos</span>
                    </div>
                    <button class="btn-icon" id="sortBtn" title="Ordenar por data">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 5h10M11 9h7M11 13h4M3 17l3 3 3-3M6 18V4"/>
                        </svg>
                    </button>
                </div>

                <!-- Lista de Tarefas -->
                <div id="requestsList" class="requests-list">
                    <!-- Pedidos ser√£o inseridos aqui dinamicamente -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    <h3>Nenhuma tarefa encontrada</h3>
                    <p>Crie a primeira tarefa ou ajuste os filtros</p>
                </div>
            </div>
        </section>


        <!-- Tab Stock -->
        <!-- Compras Tab -->
        <section class="tab-content" id="tab-stock">
            <div class="container">
                
                <!-- Card: Adicionar Item -->
                <div class="card">
                    <h2 class="card-title">üõí Lista de Compras</h2>
                    <p class="card-description">Adiciona artigos para as pr√≥ximas compras semanais</p>
                    
                    <form id="comprasForm" style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <input type="text" 
                               class="form-input" 
                               id="novoItemCompras" 
                               placeholder="Ex: Leite, P√£o, Detergente..." 
                               style="flex: 1;"
                               required>
                        <button type="submit" class="btn btn-primary" style="padding: 0 24px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 6px;">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            Adicionar
                        </button>
                    </form>
                    
                    <!-- Bot√µes de A√ß√£o -->
                    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="limparComprasCompletas()" style="flex: 1;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 6px;">
                                <path d="M9 11l3 3L22 4"/>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                            </svg>
                            Limpar Compradas
                        </button>
                        <button class="btn btn-secondary" onclick="resetarTodasCompras()" style="flex: 1;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 6px;">
                                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Limpar Tudo
                        </button>
                    </div>
                    
                    <!-- Lista de Compras -->
                    <div id="listaCompras" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- Items ser√£o inseridos aqui -->
                    </div>
                    
                    <!-- Empty State -->
                    <div id="comprasEmptyState" class="empty-state-small">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 12px; color: #999;">
                            <circle cx="9" cy="21" r="1"/>
                            <circle cx="20" cy="21" r="1"/>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                        </svg>
                        <p style="color: #666;">üìù Ainda n√£o h√° itens na lista de compras</p>
                        <p style="color: #999; font-size: 0.875rem;">Adiciona o primeiro item acima</p>
                    </div>
                </div>
                
            </div>
        </section>

        <!-- Novo Documento Tab -->
        <section class="tab-content" id="tab-novoDocumento">
            <div class="container">
                <div class="card form-card">
                    <h2 class="card-title">Criar Novo Documento</h2>
                    
                    <form id="documentoForm" class="maintenance-form">
                        
                        <!-- Tipo de Documento -->
                        <div class="form-group">
                            <label class="form-label" for="tipoDocumento">Tipo de Documento *</label>
                            <select class="form-input" id="tipoDocumento" required>
                                <option value="">Selecione o tipo</option>
                                <option value="Certid√£o">üìú Certid√£o</option>
                                <option value="Contrato">üìÑ Contrato</option>
                                <option value="Garantia">üõ°Ô∏è Garantia</option>
                                <option value="Fatura">üßæ Fatura</option>
                                <option value="Seguro">üè• Seguro</option>
                                <option value="Identifica√ß√£o">ü™™ Identifica√ß√£o</option>
                                <option value="Senha">üîê Senha</option>
                                <option value="Foto">üì∏ Fotografia</option>
                                <option value="Outro">üìå Outro</option>
                            </select>
                        </div>
                        
                        <!-- T√≠tulo do Documento -->
                        <div class="form-group">
                            <label class="form-label" for="tituloDocumento">T√≠tulo *</label>
                            <input type="text" 
                                   class="form-input" 
                                   id="tituloDocumento" 
                                   placeholder="Ex: Seguro de Sa√∫de, Contrato de Trabalho..." 
                                   required>
                        </div>
                        
                        <!-- Descri√ß√£o -->
                        <div class="form-group">
                            <label class="form-label" for="descricaoDocumento">Descri√ß√£o/Notas</label>
                            <textarea class="form-input" 
                                      id="descricaoDocumento" 
                                      rows="4" 
                                      placeholder="Detalhes adicionais, n√∫meros de ap√≥lice, observa√ß√µes..."></textarea>
                        </div>
                        
                        <!-- Data de Validade -->
                        <div class="form-group">
                            <label class="form-label" for="validadeDocumento">Data de Validade (opcional)</label>
                            <input type="date" class="form-input" id="validadeDocumento">
                        </div>
                        
                        <!-- Fotografia/Scan -->
                        <div class="form-group">
                            <label class="form-label" for="fotoDocumento">üìé Anexar Ficheiro (opcional, m√°x. 5MB)</label>
                            <div class="file-upload">
                                <input type="file" id="fotoDocumento" accept="image/*,application/pdf" class="file-input" onchange="handleDocumentoImage(event)">
                                <label for="fotoDocumento" class="file-label">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <path d="M21 15l-5-5L5 21"/>
                                    </svg>
                                    <span id="fileNameDocumento">Escolher imagem ou PDF</span>
                                </label>
                                <div id="imagePreviewDocumento" class="image-preview"></div>
                            </div>
                        </div>
                        
                        <!-- Bot√µes -->
                        <div class="form-buttons">
                            <button type="button" class="btn btn-secondary" onclick="limparFormDocumento()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                                Limpar
                            </button>
                            <button type="submit" class="btn btn-primary" id="submitBtnDocumento">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                    <polyline points="17 21 17 13 7 13 7 21"/>
                                    <polyline points="7 3 7 8 15 8"/>
                                </svg>
                                Guardar Documento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- ‚úÖ DOCUMENTOS TAB - VERS√ÉO FINAL v3.7.2.10 ‚úÖ -->
        <section class="tab-content" id="tab-analise">
            <div class="container">
                
                <!-- Filtros Card -->
                <div class="card filters-card">
                    <div class="filters-header">
                        <h3 class="filters-title">Filtros</h3>
                        <button class="btn-text" id="clearFiltersDocumentos" onclick="limparFiltrosDocumentos()">Limpar</button>
                    </div>
                    
                    <!-- Filtro por Tipo -->
                    <div class="filter-group">
                        <label class="filter-label">Tipo de Documento</label>
                        <div class="filter-options">
                            <label class="filter-checkbox">
                                <input type="checkbox" class="filter-tipo-documento" value="Certid√£o" checked>
                                <span>üìú Certid√£o</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" class="filter-tipo-documento" value="Contrato" checked>
                                <span>üìÑ Contrato</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" class="filter-tipo-documento" value="Garantia" checked>
                                <span>üõ°Ô∏è Garantia</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" class="filter-tipo-documento" value="Fatura" checked>
                                <span>üßæ Fatura</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" class="filter-tipo-documento" value="Seguro" checked>
                                <span>üè• Seguro</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" class="filter-tipo-documento" value="Identifica√ß√£o" checked>
                                <span>ü™™ Identifica√ß√£o</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" class="filter-tipo-documento" value="Senha" checked>
                                <span>üîê Senha</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" class="filter-tipo-documento" value="Foto" checked>
                                <span>üì∏ Foto</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" class="filter-tipo-documento" value="Outro" checked>
                                <span>üìå Outro</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Lista Header -->
                <div class="list-header">
                    <span class="list-count" id="documentosCount">0 documentos</span>
                    <button class="btn-icon" id="sortBtnDocumentos" title="Ordenar por data" onclick="toggleSortOrderDocumentos()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M7 12h10M11 18h4"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Lista de Documentos -->
                <div id="documentosLista" class="requests-list">
                    <!-- Cards de documentos ser√£o inseridos aqui -->
                </div>
                
                <!-- Empty State -->
                <div id="documentosEmptyState" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    <h3>Nenhum documento encontrado</h3>
                    <p>Cria o primeiro documento na tab "Novo Documento"</p>
                </div>
                
            </div>
        </section>

        <!-- ‚úÖ FARM√ÅCIA TAB - v3.7.2.17 ‚úÖ -->
        <section class="tab-content" id="tab-farmacia">
            <div class="container">
                <div class="card">
                    <h2 class="card-title" style="text-align: center; color: #007AFF; margin-bottom: 16px;">
                        üíä Farm√°cia
                    </h2>
                    <div style="
                        text-align: center;
                        padding: 60px 20px;
                        color: #8E8E93;
                    ">
                        <div style="font-size: 64px; margin-bottom: 16px;">üíä</div>
                        <h3 style="
                            font-size: 20px;
                            font-weight: 600;
                            color: #1D1D1F;
                            margin-bottom: 8px;
                        ">Tab Farm√°cia</h3>
                        <p style="
                            font-size: 15px;
                            color: #86868B;
                            max-width: 400px;
                            margin: 0 auto;
                        ">Esta tab est√° pronta para adicionar funcionalidades de gest√£o de medicamentos, prescri√ß√µes e alertas de toma.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal de Detalhes -->
    <div class="modal" id="detailsModal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Detalhes da Ordem de Trabalho</h2>
                <button class="btn-close" id="closeModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Conte√∫do ser√° inserido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Container de Impress√£o (oculto) -->
    <div id="printContainer" style="display: none;"></div>

    <!-- Modal: Movimento de Stock -->
    <div class="modal" id="movimentoModal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="movimentoModalTitle">Movimento de Stock</h2>
                <button class="btn-close" onclick="closeMovimentoModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="movimentoForm" class="movimento-form">
                    <!-- Filtro de Fam√≠lia -->
                    <div class="form-group">
                        <label class="form-label">üì¶ Fam√≠lia</label>
                        <select class="form-input" id="movimentoFamiliaSelect" onchange="filtrarArtigosPorFamilia()">
                            <option value="">Todas as fam√≠lias</option>
                        </select>
                    </div>
                    
                    <!-- Sele√ß√£o de Artigo -->
                    <div class="form-group" id="artigoSelectGroup">
                        <label class="form-label">Artigo *</label>
                        <select class="form-input" id="movimentoArtigoSelect" required onchange="updateArtigoInfo()">
                            <option value="">Selecione um artigo...</option>
                        </select>
                    </div>
                    
                    <!-- Info do Artigo Selecionado -->
                    <div class="artigo-selected-info" id="artigoSelectedInfo" style="display: none;"></div>
                    
                    <div class="form-group">
                        <label class="form-label">Tipo de Movimento *</label>
                        <select class="form-input" id="movimentoTipo" required>
                            <option value="Entrada">üì• Entrada (Compra/Devolu√ß√£o)</option>
                            <option value="Sa√≠da">üì§ Sa√≠da (Consumo)</option>
                            <option value="Ajuste">‚öôÔ∏è Ajuste (Corre√ß√£o)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Quantidade *</label>
                        <div class="quantidade-input-group">
                            <button type="button" class="quantidade-btn" onclick="adjustQuantidade(-1)">‚àí</button>
                            <input type="number" 
                                   class="form-input quantidade-input" 
                                   id="movimentoQuantidade" 
                                   min="1" 
                                   value="1" 
                                   required>
                            <button type="button" class="quantidade-btn" onclick="adjustQuantidade(1)">+</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Empresa *</label>
                        <select class="form-input" id="movimentoEmpresa" required>
                            <option value="">Selecione a empresa</option>
                            <option value="MCF" selected>MCF</option>
                            <option value="PSY">PSY</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Respons√°vel</label>
                        <input type="text" 
                               class="form-input" 
                               id="movimentoResponsavel" 
                               list="responsaveisList">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Observa√ß√µes</label>
                        <textarea class="form-input" 
                                  id="movimentoObservacoes" 
                                  rows="3" 
                                  placeholder="Motivo do movimento, notas adicionais..."></textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeMovimentoModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">üíæ Registar Movimento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- üÜï Modal: Baixa M√∫ltipla de Stock -->
    <div class="modal" id="baixaMultiplaModal">
        <div class="modal-overlay"></div>
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="baixaMultiplaModalTitle">üí∞ Baixa de Stock</h2>
                <button class="btn-close" onclick="closeBaixaMultiplaModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Associar a OT (opcional) -->
                <div class="form-group" style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <label class="form-label">üîó Associar a Ordem de Trabalho (opcional)</label>
                    <input type="text" 
                           class="form-input" 
                           id="baixaMultiplaOTSearch" 
                           placeholder="Digite ID da OT (ex: OT_00067) ou deixe vazio..."
                           style="margin-bottom: 8px;">
                    <div id="baixaMultiplaOTInfo" style="display: none; padding: 12px; background: white; border-radius: 8px; border: 1px solid #dee2e6;">
                        <!-- Info da OT selecionada -->
                    </div>
                </div>

                <!-- Lista de Artigos para Baixa -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <label class="form-label" style="margin: 0;">üì¶ Artigos para Baixa</label>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="adicionarLinhaBaixa()">
                            ‚ûï Adicionar Artigo
                        </button>
                    </div>
                    
                    <div id="baixaMultiplaLinhas" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Linhas de artigos adicionadas dinamicamente -->
                    </div>
                </div>

                <!-- Resumo e Total -->
                <div id="baixaMultiplaResumo" style="display: none; padding: 16px; background: #e8f5e9; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">üìä Resumo da Baixa:</div>
                    <div id="baixaMultiplaResumoConteudo"></div>
                </div>

                <!-- Campos Comuns -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Empresa *</label>
                        <select class="form-input" id="baixaMultiplaEmpresa" required>
                            <option value="MCF" selected>MCF</option>
                            <option value="PSY">PSY</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Respons√°vel *</label>
                        <input type="text" 
                               class="form-input" 
                               id="baixaMultiplaResponsavel" 
                               placeholder="Nome do respons√°vel"
                               required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Observa√ß√µes</label>
                    <textarea class="form-input" 
                              id="baixaMultiplaObservacoes" 
                              rows="2" 
                              placeholder="Observa√ß√µes gerais sobre esta baixa..."></textarea>
                </div>

                <!-- A√ß√µes -->
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeBaixaMultiplaModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarBaixaMultipla()">
                        ‚úÖ Confirmar Baixa
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Login - Apple Style Clean -->
    <div class="login-screen" id="loginModal" style="display: none;">
        <div class="login-card-wrapper">
            <div class="login-card-apple">
                <!-- Logo -->
                <div class="login-logo-container">
                    <img src="/appmanutencao/icons/android-chrome-192x192.png" alt="Logo Manuten√ß√£o" class="login-logo" id="loginLogo">
                </div>
                
                <!-- T√≠tulo -->
                <h1 class="login-title-apple">üè° Gestor de Tarefas Dom√©sticas</h1>
                <p class="login-subtitle-apple">Fa√ßa login para continuar</p>
                
                <!-- Formul√°rio -->
                <form id="loginForm" class="login-form-apple">
                    <div class="login-input-wrapper">
                        <input type="text" 
                               class="login-input-apple" 
                               id="loginUsername" 
                               placeholder="Username"
                               required 
                               autocomplete="username">
                    </div>
                    
                    <div class="login-input-wrapper">
                        <input type="password" 
                               class="login-input-apple" 
                               id="loginPassword" 
                               placeholder="Password"
                               required 
                               autocomplete="current-password">
                    </div>
                    
                    <div id="loginError" class="login-error-apple" style="display: none;"></div>
                    
                    <button type="submit" class="login-button-apple">
                        Entrar
                    </button>
                    

                </form>
            </div>
        </div>
    </div>


    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    
    <!-- üî• Supabase Client INLINE v3.6.8 -->
    <script>
// ================================================
// üî• SUPABASE CLIENT - INLINE
// ================================================

// ‚úÖ CONFIGURA√á√ÉO SUPABASE - Gestor de Tarefas Dom√©sticas v3.7.2.4
const SUPABASE_CONFIG = {
    URL: 'https://jvnymteivdcslrlgjzfu.supabase.co',
    ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2bnltdGVpdmRjc2xybGdqemZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNzQ4NDUsImV4cCI6MjA4Mzk1MDg0NX0.QwMuZ7XAhfrcQb4QdAqA4GZSQQJy5HYY32wPZ1ImG9c'
};

// HELPER: Fetch gen√©rico para Supabase REST API
async function supabaseFetch(endpoint, options = {}) {
    const url = `${SUPABASE_CONFIG.URL}/rest/v1/${endpoint}`;
    const headers = {
        'apikey': SUPABASE_CONFIG.ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation',
        ...options.headers
    };

    console.log('üî• Supabase Fetch:', { url, method: options.method || 'GET' });

    const response = await fetch(url, {
        ...options,
        headers
    });

    console.log('üì° Supabase Response:', { status: response.status, ok: response.ok });

    if (!response.ok) {
        const error = await response.json();
        console.error('‚ùå Supabase Error:', error);
        throw new Error(error.message || 'Erro na API Supabase');
    }

    return response.json();
}

// ================================================
// API FUNCTIONS
// ================================================

// Artigos
async function getArtigos() {
    // ‚úÖ v3.7.0.9: Filtrar apenas artigos vis√≠veis (Vis√≠vel = true)
    return await supabaseFetch('artigos?select=*&Vis√≠vel=eq.true&order=ID.asc');
}

// Utilizadores
async function getUtilizadores() {
    return await supabaseFetch('users?select=*&order=username.asc');
}

async function loginUtilizador(username, password) {
    const users = await supabaseFetch(`users?username=eq.${encodeURIComponent(username)}&password=eq.${encodeURIComponent(password)}`);
    
    if (users.length === 0) {
        throw new Error('Utilizador ou password incorretos');
    }
    
    return users[0];
}

// Pedidos
async function getPedidos() {
    // ‚úÖ Corrigido: Remover order porque "Data/hora" tem barra
    return await supabaseFetch('pedidos?select=*');
}

async function addPedido(pedido) {
    console.log('üî• DEBUG addPedido: ID recebido =', pedido.ID);
    console.log('üî• DEBUG addPedido: Body completo =', JSON.stringify(pedido, null, 2));
    
    const result = await supabaseFetch('pedidos', {
        method: 'POST',
        body: JSON.stringify(pedido)
    });
    
    console.log('üî• DEBUG addPedido: Resultado do Supabase =', result);
    return result;
}

async function updatePedido(id, pedido) {
    console.log(`üîÑ SupabaseAPI.updatePedido chamado para ID: ${id}`);
    console.log('üì¶ Dados da ordem de trabalho:', pedido);
    
    const result = await supabaseFetch(`pedidos?ID=eq.${id}`, {
        method: 'PATCH',
        body: JSON.stringify(pedido)
    });
    
    console.log('‚úÖ SupabaseAPI.updatePedido: Resposta recebida:', result);
    return result;
}

async function deletePedido(id) {
    return await supabaseFetch(`pedidos?ID=eq.${id}`, {
        method: 'DELETE'
    });
}

// Movimentos
async function getMovimentos() {
    // ‚úÖ Corrigido: Remover order porque "Data/Hora" tem barra
    return await supabaseFetch('movimentos?select=*');
}

async function addMovimento(movimento) {
    return await supabaseFetch('movimentos', {
        method: 'POST',
        body: JSON.stringify(movimento)
    });
}

// Planeamento
async function getPlaneamento() {
    return await supabaseFetch('planeamento?select=*');
}

async function addPlaneamento(planeamento) {
    return await supabaseFetch('planeamento', {
        method: 'POST',
        body: JSON.stringify(planeamento)
    });
}

async function updatePlaneamento(id, planeamento) {
    return await supabaseFetch(`planeamento?ID=eq.${id}`, {
        method: 'PATCH',
        body: JSON.stringify(planeamento)
    });
}

async function deletePlaneamento(id) {
    return await supabaseFetch(`planeamento?ID=eq.${id}`, {
        method: 'DELETE'
    });
}

// üì∏ v3.6.18: Storage para Fotos
async function uploadFoto(pedidoId, file) {
    try {
        console.log('üì∏ Iniciando upload...', file.name, (file.size / 1024 / 1024).toFixed(2) + ' MB');
        
        // Nome do ficheiro = ID da ordem + extens√£o
        const ext = file.type.split('/')[1] || 'jpg';
        const fileName = `${pedidoId}.${ext}`;
        
        // Upload via REST API do Supabase Storage
        const url = `${SUPABASE_CONFIG.URL}/storage/v1/object/pedidos-fotos/${fileName}`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_CONFIG.ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`,
                'Content-Type': file.type,
                'x-upsert': 'true'  // Substituir se j√° existir
            },
            body: file  // Enviar File diretamente
        });
        
        if (!response.ok) {
            const error = await response.text();
            console.error('‚ùå Erro upload Storage:', error);
            throw new Error('Erro ao fazer upload da foto');
        }
        
        // Retornar URL p√∫blica
        const publicUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/public/pedidos-fotos/${fileName}`;
        console.log('‚úÖ Foto enviada:', publicUrl);
        return publicUrl;
        
    } catch (error) {
        console.error('‚ùå Erro ao fazer upload:', error);
        return null;  // Retornar null em vez de falhar
    }
}

async function deleteFoto(pedidoId) {
    try {
        // Tentar deletar jpg, jpeg, png, webp (n√£o sabemos a extens√£o)
        const extensions = ['jpg', 'jpeg', 'png', 'webp'];
        
        for (const ext of extensions) {
            const fileName = `${pedidoId}.${ext}`;
            const url = `${SUPABASE_CONFIG.URL}/storage/v1/object/pedidos-fotos/${fileName}`;
            
            await fetch(url, {
                method: 'DELETE',
                headers: {
                    'apikey': SUPABASE_CONFIG.ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`
                }
            });
        }
        
        console.log('‚úÖ Foto eliminada (tentado todas extens√µes)');
        
    } catch (error) {
        console.error('‚ö†Ô∏è Erro ao eliminar foto:', error);
        // N√£o falhar se n√£o conseguir deletar
    }
}

function getFotoUrl(pedidoId, extensao = 'jpg') {
    if (!pedidoId) return null;
    return `${SUPABASE_CONFIG.URL}/storage/v1/object/public/pedidos-fotos/${pedidoId}.${extensao}`;
}

// ‚úÖ v3.7.0.9: Buscar equipamentos do Supabase
async function getEquipamentos() {
    try {
        // Buscar TODOS os equipamentos (sem filtro ativo, para debug)
        const result = await supabaseFetch('lista_equipamentos?select=*&order=area.asc,ordem.asc');
        console.log('üîç getEquipamentos - Total recebido:', result?.length || 0);
        if (result && result.length > 0) {
            console.log('üîç Primeiro equipamento:', result[0]);
        } else {
            console.error('‚ö†Ô∏è Nenhum equipamento retornado do Supabase!');
            console.error('   Verifique se executou os INSERTs do SQL');
        }
        return result || [];
    } catch (error) {
        console.error('‚ùå Erro ao buscar equipamentos:', error);
        return [];
    }
}

// üìö MANUAIS
async function getManuais() {
    try {
        return await supabaseFetch('manuais?select=*&ativo=eq.true&order=created_at.desc');
    } catch (error) {
        console.error('‚ùå Erro ao buscar manuais:', error);
        return [];
    }
}

async function addManual(manual) {
    return await supabaseFetch('manuais', {
        method: 'POST',
        body: JSON.stringify(manual)
    });
}

async function updateManual(id, manual) {
    return await supabaseFetch(`manuais?id=eq.${id}`, {
        method: 'PATCH',
        body: JSON.stringify(manual)
    });
}

async function deleteManual(id) {
    return await supabaseFetch(`manuais?id=eq.${id}`, {
        method: 'PATCH',
        body: JSON.stringify({ ativo: false })
    });
}

async function addConteudoManual(conteudo) {
    return await supabaseFetch('manuais_conteudo', {
        method: 'POST',
        body: JSON.stringify(conteudo)
    });
}

async function getConteudoManual(manualId) {
    try {
        return await supabaseFetch(`manuais_conteudo?manual_id=eq.${manualId}&order=pagina_inicio.asc`);
    } catch (error) {
        console.error('‚ùå Erro ao buscar conte√∫do do manual:', error);
        return [];
    }
}

async function uploadManualPDF(manualId, file) {
    try {
        console.log('üìÑ Iniciando upload do PDF...', file.name, (file.size / 1024 / 1024).toFixed(2) + ' MB');
        
        const fileName = `${manualId}.pdf`;
        
        // üîß CORRE√á√ÉO v3.7.3.2: Usar FormData para upload correto
        const formData = new FormData();
        formData.append('file', file);
        
        // URL correto do Supabase Storage
        const url = `${SUPABASE_CONFIG.URL}/storage/v1/object/manuais/${fileName}`;
        
        console.log('[DEBUG Upload] URL:', url);
        console.log('[DEBUG Upload] Bucket: manuais');
        console.log('[DEBUG Upload] FileName:', fileName);
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_CONFIG.ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`,
                // ‚ùå N√ÉO definir Content-Type - deixar o browser definir para FormData
            },
            body: formData  // üîß Usar FormData em vez de file direto
        });
        
        console.log('[DEBUG Upload] Response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Erro upload Storage:', response.status, errorText);
            
            // Tentar parsear como JSON para melhor diagn√≥stico
            try {
                const errorJson = JSON.parse(errorText);
                console.error('‚ùå Detalhes do erro:', errorJson);
                throw new Error(errorJson.message || errorJson.error || 'Erro ao fazer upload do PDF');
            } catch (parseError) {
                throw new Error(`Erro ao fazer upload do PDF: ${response.status} - ${errorText}`);
            }
        }
        
        // Construir URL p√∫blico
        const publicUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/public/manuais/${fileName}`;
        console.log('‚úÖ PDF enviado com sucesso!');
        console.log('‚úÖ URL p√∫blica:', publicUrl);
        return publicUrl;
        
    } catch (error) {
        console.error('‚ùå Erro ao fazer upload do PDF:', error);
        throw error;
    }
}

// Exportar para uso global
window.SupabaseAPI = {
    getArtigos,
    getUtilizadores,
    loginUtilizador,
    getPedidos,
    addPedido,
    updatePedido,
    deletePedido,
    getMovimentos,
    addMovimento,
    getPlaneamento,
    addPlaneamento,
    updatePlaneamento,
    deletePlaneamento,
    uploadFoto,
    deleteFoto,
    getFotoUrl,
    getEquipamentos,
    // Manuais
    getManuais,
    addManual,
    updateManual,
    deleteManual,
    addConteudoManual,
    getConteudoManual,
    uploadManualPDF
};

console.log('‚úÖ Supabase API inicializada (INLINE)');
    </script>
    
    <!-- JavaScript Principal (INLINE para garantir funcionamento) -->
    <script>
// ================================================
// App de Manuten√ß√£o - JavaScript Principal  
// VERS√ÉO INLINE PARA MOBILE PWA
// ================================================

// CONFIGURA√á√ÉO
const CONFIG = {
    // ‚ùå DESATIVADO - Migrado para Supabase v3.6.8
    // GOOGLE_SHEETS_URL: 'https://script.google.com/macros/s/AKfycbxsgLa1qTwDRg13sItlTHg5cqhFaxrvjj_Oq-7f7VCBUcMNog_qPvRDrYm1vgAkoB-w-g/exec',
    
    // üì∏ v3.6.18: Aumentar limites para fotos (Storage)
    MAX_IMAGE_SIZE: 5 * 1024 * 1024,  // 5 MB (era 2 MB)
    IMAGE_QUALITY: 0.85,               // 85% (era 80%)
    MAX_IMAGE_WIDTH: 2560,             // 2560px (era 1920px)
    MAX_IMAGE_HEIGHT: 2560,            // 2560px (era 1920px),
    LOGO_PATHS: [
        'icons/android-chrome-192x192.png',
        './icons/android-chrome-192x192.png',
        '/icons/android-chrome-192x192.png'
    ],
    STORAGE_KEYS: {
        REQUESTS: 'maintenance_requests',
        OFFLINE_QUEUE: 'maintenance_offline_queue',
        USER_NAME: 'maintenance_user_name',
        PLANNING: 'maintenance_planning',
        USER_SESSION: 'maintenance_user_session',
        USER_TOKEN: 'maintenance_user_token'
    },
    PLANNING_WEEKS: 2,
    INCLUDE_WEEKENDS: true,
    MACHINES: {
        'crivo': { name: 'Crivo de exc√™ntrico', url: 'https://drive.google.com/file/d/1cONotpIDkqzWx7vuKp7nj1xc2qON2uTT/view', embedUrl: 'https://drive.google.com/file/d/1cONotpIDkqzWx7vuKp7nj1xc2qON2uTT/preview' },
        'destrocador': { name: 'Destro√ßador', url: 'https://drive.google.com/file/d/17CrN8UxtaD5bmDknHSl7GyhnT5kDxEln/view', embedUrl: 'https://drive.google.com/file/d/17CrN8UxtaD5bmDknHSl7GyhnT5kDxEln/preview' },
        'l01-dupla': { name: 'L01 - Dupla', url: 'https://drive.google.com/file/d/1ekrMpI3U0928ZPP0bemW18bL0rm0PwdT/view', embedUrl: 'https://drive.google.com/file/d/1ekrMpI3U0928ZPP0bemW18bL0rm0PwdT/preview' },
        'l01-multiserra': { name: 'L01 - Multiserra', url: 'https://drive.google.com/file/d/1Fm3KuVQA1DW17NeAMpMiX6biJRoxE5Yv/view', embedUrl: 'https://drive.google.com/file/d/1Fm3KuVQA1DW17NeAMpMiX6biJRoxE5Yv/preview' },
        'l01-paletizadora': { name: 'L01 - Paletizadora', url: 'https://drive.google.com/file/d/1XGzzWrVY7y2N7Qjc9pTfjcCbtZoIrpFJ/view', embedUrl: 'https://drive.google.com/file/d/1XGzzWrVY7y2N7Qjc9pTfjcCbtZoIrpFJ/preview' },
        'l01-retestadeira': { name: 'L01 - Retestadeira', url: 'https://drive.google.com/file/d/1yhMPDhdVLbnNyipXW4YcurPuYApd1kzv/view', embedUrl: 'https://drive.google.com/file/d/1yhMPDhdVLbnNyipXW4YcurPuYApd1kzv/preview' },
        'l01-tracador': { name: 'L01 - Tra√ßador', url: 'https://drive.google.com/file/d/1_z76x5wlAed80dL2cnoiiaN0EaOqK87J/view', embedUrl: 'https://drive.google.com/file/d/1_z76x5wlAed80dL2cnoiiaN0EaOqK87J/preview' },
        'l02-charriot': { name: 'L02 - Charriot', url: 'https://drive.google.com/file/d/1ms0jVeOePed49KqniSLDlUPEmrPdbYgr/view', embedUrl: 'https://drive.google.com/file/d/1ms0jVeOePed49KqniSLDlUPEmrPdbYgr/preview' },
        'l02-retestadeira': { name: 'L02 - Retestadeira', url: 'https://drive.google.com/file/d/1NvggjN6HKYpo1wF4qZfZcXnlPD-uaWUm/view', embedUrl: 'https://drive.google.com/file/d/1NvggjN6HKYpo1wF4qZfZcXnlPD-uaWUm/preview' },
        'l03-alinhadeira': { name: 'L03 - Alinhadeira', url: 'https://drive.google.com/file/d/1M0tepr43OZ1AGhtLDBqh2Q9cK3W01lmh/view', embedUrl: 'https://drive.google.com/file/d/1M0tepr43OZ1AGhtLDBqh2Q9cK3W01lmh/preview' },
        'l03-paletizadora': { name: 'L03 - Paletizadora', url: 'https://drive.google.com/file/d/14BuEGLBx_JXMWVCeUGKbr_t_L-6fe6mY/view', embedUrl: 'https://drive.google.com/file/d/14BuEGLBx_JXMWVCeUGKbr_t_L-6fe6mY/preview' },
        'l03-retestadeira': { name: 'L03 - Retestadeira', url: 'https://drive.google.com/file/d/1X4L2M8KInJMRUaGheGjLcRKHV0vbqUuv/view', embedUrl: 'https://drive.google.com/file/d/1X4L2M8KInJMRUaGheGjLcRKHV0vbqUuv/preview' },
        'tinas': { name: 'Tinas impregnante', url: 'https://drive.google.com/file/d/16dwf9DGaiGrNI2xF1LfoRw1wVA1nZQP-/view', embedUrl: 'https://drive.google.com/file/d/16dwf9DGaiGrNI2xF1LfoRw1wVA1nZQP-/preview' }
    },
    
    // ‚ùå REMOVIDO v3.7.0.9: Migrado para Supabase (tabela lista_equipamentos)
    // Os equipamentos agora s√£o carregados dinamicamente do Supabase
    EQUIPAMENTOS_OLD: {
        'Triagem': [
            'Redler superior Silo Casca',
            'Redler transporte para Silo Casca',
            'Rampa Entrada principal Triagem',
            'Descascadeira',
            'Corrente Sa√≠da Descascadeira',
            'Rampa Entrada P√≥s-Descascadeira',
            'Raixo X',
            'Corrente Sa√≠da Raio X',
            'Redler Principal Triagem',
            'Redler Cascas Descascador Charriot',
            'Corrente Transporte Triagem',
            'Box 1',
            'Box 2',
            'Box 3',
            'Box 4',
            'Box 5',
            'Box 6',
            'Box 7',
            'Box 8 - Rampa Linha Principal',
            'Triagem Outros'
        ],
        'L01 - Linha Principal': [
            'Tapete desperdicio L01',
            'Quadro El√©ctrico/Aut√≥mato L01',
            'Tapete Costaneiros L01-L03',
            'Tapete Superior de Escolha L01',
            'Tapete Escolha L01',
            'Progrow',
            'Estrutura L01',
            'Separador do Tra√ßador L01',
            'Rampa Entrada Exterior Tra√ßador L01',
            'Redler Entrada Tra√ßador L01',
            'Tra√ßador L01',
            'Tapete Sa√≠da Tra√ßador L01',
            'Rampa sa√≠da Tra√ßador L01',
            'Comandos Controlo Dupla L01',
            'Separador Dupla L1',
            'Rolos rota√ß√£o Dupla L01',
            'Calcador Dupla L01',
            'Serra Esquerda Dupla L01',
            'Serra Direita Dupla L01',
            'Corrente de tra√ß√£o Dupla L01',
            'Tapete Sa√≠da Dupla L01',
            'Rolos Tra√ß√£o Centrador L01',
            'Centrador L01',
            'Tapete Entrada 3/4 Face L01',
            '3/4 Face L01',
            'Rolos tra√ß√£o 3/4 Face L01',
            'Rolos tra√ß√£o Retestadeira L01',
            'Retestadeira L01',
            'Rolos tra√ß√£o Multiserra L01',
            'Multiserra L01',
            'Tapete saida Multiserra L01',
            'Tapete entrada Paletizador L01',
            'Paletizador L01',
            'Descarga Paletizador L01',
            'L01 - Linha Principal - Outros'
        ],
        'L03 - Linha Aproveitamentos': [
            'Tapete desperdicio L03.01',
            'Tapete desperdicio L03.02',
            'Tapete inferior da Escolha L03.01',
            'Tapete Escolha L03.02',
            'Plataforma elevatoria L03',
            'Estrutura L03',
            'Tapete Entrada Alinhadeira L03',
            'Alinhadeira L03',
            'Tapete Entrada Retestadeira L03',
            'Retestadeira L03',
            'Corrente de sa√≠da Retestadeira L03',
            'Tapete Transporte Retest. L03-Multiserra',
            'Corrente entrada Multis.L03.01',
            'Multiserra L03.01',
            'Corrente entrada Multis.L03.02',
            'Multiserra L03.02',
            'Tapete entrada-Mesa de Escolha L03.01',
            'Paletizador L03',
            'L03 - Linha Aproveitamentos - Outros'
        ],
        'L02 - Charriot': [
            'Rampa Entrada Descascadeira Charriot L02',
            'Descascadeira Charriot L02',
            'Corrente Transporte Desc. - Charriot L02',
            'Redler Charriot L02',
            'Rampa Entrada Charriot L02',
            'Charriot L02',
            'Cabine Comando Charriot L02',
            'Tapete Desperdicio Charriot L02',
            'Rampa Descarga Charriot L02',
            'Rampa Carga-Descarga Charriot L02',
            'Rolos tra√ß√£o Charriot - Multiserra L02',
            'Mesa entrada Multiserra L02',
            'Cabine Comando Multiserra L02',
            'Tapete Saida Multiserra L02',
            'Mesa Escolha do Paletizador L02',
            'Tapete inferior Escolha Paletizador L02',
            'Retestadeira L02',
            'Rolos Entrada Retestadeira L02',
            'L02 - Charriot - Outros'
        ],
        'Destro√ßador': [
            'Quadro El√©ctrico/Automato',
            'Tapete  Desperdicio',
            'Tapete Entrada',
            'Destro√ßador',
            'Tapete Saida Destro√ßador',
            'Crivos',
            'Tapete Finos',
            'Tapete Estilha',
            'Destro√ßador - Outros'
        ],
        'Aspira√ß√£o': [
            'Tubagem Aspira√ß√£o',
            'Ventilador',
            'Ciclones',
            'Aspira√ß√£o - Outros'
        ],
        'Redlers Interiores': [
            'Redler Dupla L01',
            'Redler 3/4 Face',
            'Redler Dupla-3/4 Face',
            'Redler Retestadeira L01-Alinh. L03',
            'Redler Multiserra L01',
            'Redler Retest. L01-Multis.L01',
            'Redler Linha Principal - Silo',
            'Redler L03',
            'Redler Destro√ßador - Charriot',
            'Redler Charriot-Silo'
        ],
        'Empilhadores': [
            'Nissan',
            'Linde',
            'Caterpillar'
        ],
        'P√°s Carregadoras': [
            'Caterpillar 1',
            'Caterpillar 2',
            'Case'
        ],
        'High-Liflts': [
            'Volvo C',
            'Volvo D',
            'Volvo E'
        ],
        'Tinas Tratamento': [
            'Tina 1',
            'Tina 2',
            'Tina 3'
        ],
        'Bomba Gas√≥leo': [
            'Bomba Gas√≥leo'
        ],
        'Estufa': [
            'Estufa Secagem'
        ],
        'Caldeiras': [
            'Caldeira 1',
            'Caldeira 2'
        ],
        'Rede Ar comprimido': [
            'Compressor 1',
            'Compressor 2',
            'Compressor 3',
            'Secador 1',
            'Secador 2',
            'Rede Distribui√ß√£o Ar Comprimido'
        ],
        'Edificio': [
            'Electricidade',
            'Canaliza√ß√£o √Ågua',
            'Saneamento',
            'Rede Inform√°tica',
            'Estrutura',
            'Edificio - Outros'
        ],
        'MCF': [
            'MCF - Outros'
        ]
    }
};

// ================================================
// FUN√á√ÉO DE FALLBACK PARA LOGOS
// ================================================
let logoAttempts = 0;

function handleLogoError(imgElement) {
    console.error('üö® ERRO ao carregar logo:', imgElement.src);
    logoAttempts++;
    
    // Tentar pr√≥ximo path da lista
    if (logoAttempts < CONFIG.LOGO_PATHS.length) {
        const nextPath = CONFIG.LOGO_PATHS[logoAttempts];
        console.log(`üîÑ Tentando path alternativo (${logoAttempts + 1}/${CONFIG.LOGO_PATHS.length}):`, nextPath);
        imgElement.src = nextPath;
        return;
    }
    
    // Se todos os paths falharam, usar SVG como fallback
    console.warn('‚ö†Ô∏è Todos os paths de imagem falharam. Usando SVG fallback.');
    
    const svgLogo = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: ${imgElement.classList.contains('login-logo') ? '140px' : '32px'}; height: ${imgElement.classList.contains('login-logo') ? '140px' : '32px'}; color: #667eea;">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v12M6 12h12"/>
            <circle cx="12" cy="12" r="3"/>
        </svg>
    `;
    
    imgElement.outerHTML = svgLogo;
}

// Testar caminhos dos logos ao carregar
function testLogoPaths() {
    console.log('üîç Testando paths dos logos...');
    console.log('üìÅ Base URL:', window.location.href);
    console.log('üìÅ Paths configurados:', CONFIG.LOGO_PATHS);
    
    CONFIG.LOGO_PATHS.forEach((path, index) => {
        const testImg = new Image();
        testImg.onload = () => {
            console.log(`‚úÖ Path ${index + 1} FUNCIONA:`, path, `(${testImg.naturalWidth}x${testImg.naturalHeight}px)`);
        };
        testImg.onerror = () => {
            console.error(`‚ùå Path ${index + 1} FALHOU:`, path);
        };
        testImg.src = path;
    });
}

// Executar teste ao carregar
window.addEventListener('DOMContentLoaded', testLogoPaths);

// ESTADO DA APLICA√á√ÉO
const AppState = {
    requests: [],
    filteredRequests: [],
    sortOrder: 'desc',
    currentFilters: { tipo: [], prioridade: [], estado: ['Novo', 'Em curso'], empresa: [], tipoIntervencao: [], urgente: [], paragemProducao: [] },
    isOnline: navigator.onLine,
    planning: { 
        tasks: {},  // ‚úÖ v3.7.0.8: { pedidoId: { responsavel, horasEstimadas, diasAlocados: [] } }
        allocations: {},  // üîÑ Mantido por compatibilidade (ser√° migrado)
        startDate: null, 
        endDate: null 
    },
    artigos: [],
    movimentos: [],
    utilizadores: [],  // ‚úÖ NOVO: Lista de utilizadores para dropdown
    equipamentos: [],  // ‚úÖ v3.7.0.9: Lista de equipamentos do Supabase
    artigoSelecionado: null,
    currentUser: null  // { username, nomeCompleto, departamento, role, podeEditarPlaneamento, token }
};

// ‚úÖ v3.6.8: App migrado para SUPABASE
// Artigos, movimentos e pedidos s√£o carregados do Supabase
// Se n√£o houver dados, app mostra erro (n√£o usa dados falsos)

let currentMachine = null;

// ============================================
// SISTEMA DE AUTENTICA√á√ÉO
// ============================================

async function checkAuthentication() {
    console.log('üîê checkAuthentication() chamado');
    
    if (AppState.currentUser) {
        console.log('‚úÖ User j√° em mem√≥ria:', AppState.currentUser.username);
        showUserInterface();
        return true;
    }
    
    let savedSession = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_SESSION);
    let savedToken = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_TOKEN);
    
    console.log('üì¶ localStorage:', {
        session: savedSession ? 'EXISTE' : 'VAZIO',
        token: savedToken ? 'EXISTE' : 'VAZIO'
    });
    
    // Se localStorage vazio, tentar restaurar dos cookies
    if (!savedSession || !savedToken) {
        const cookieSession = getCookie('maintenance_user_session');
        const cookieToken = getCookie('maintenance_user_token');
        
        if (cookieSession && cookieToken) {
            localStorage.setItem(CONFIG.STORAGE_KEYS.USER_SESSION, cookieSession);
            localStorage.setItem(CONFIG.STORAGE_KEYS.USER_TOKEN, cookieToken);
            savedSession = cookieSession;
            savedToken = cookieToken;
        }
    }
    
    if (savedSession && savedToken) {
        try {
            const userData = JSON.parse(savedSession);
            console.log('‚úÖ Sess√£o restaurada:', userData.username);
            console.log('üö® [DEBUG] userData completo:', userData);
            AppState.currentUser = userData;
            console.log('üö® [DEBUG] AppState.currentUser definido:', AppState.currentUser);
            showUserInterface();
            return true;
        } catch (e) {
            console.error('‚ùå Erro ao parsear sess√£o:', e);
            clearSession();
        }
    } else {
        console.log('‚ùå Sem sess√£o guardada - mostrar login');
    }
    
    showLoginModal();
    return false;
}

function showLoginModal() {
    const modal = document.getElementById('loginModal');
    const mainContent = document.querySelector('.app-main');
    const header = document.querySelector('.app-header');
    
    if (modal) {
        modal.style.display = 'flex'; // Inline sobrescreve tudo
        modal.classList.add('show');
    }
    if (mainContent) mainContent.style.display = 'none';
    if (header) header.style.opacity = '0.5';
    
    console.log('üîì Modal de login mostrado');
}

function hideLoginModal() {
    const modal = document.getElementById('loginModal');
    const mainContent = document.querySelector('.app-main');
    const header = document.querySelector('.app-header');
    
    if (modal) {
        modal.style.display = 'none'; // Inline garante esconder
        modal.classList.remove('show');
    }
    if (mainContent) mainContent.style.display = 'block';
    if (header) header.style.opacity = '1';
    
    console.log('üîí Modal de login escondido');
}

async function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    const submitBtn = event.target.querySelector('button[type="submit"]');
    
    if (!username || !password) {
        showLoginError('Por favor, preencha todos os campos');
        return;
    }
    
    try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'A validar...';
        errorDiv.style.display = 'none';
        
        console.log('üîê A tentar login:', username);
        
        // üî• LOGIN COM SUPABASE v3.6.8
        const user = await window.SupabaseAPI.loginUtilizador(username, password);
        
        console.log('üî• DEBUG LOGIN - Dados do utilizador:', user);
        console.log('üî• DEBUG LOGIN - Pode editar valor:', user.pode_editar_planeamento, 'Tipo:', typeof user.pode_editar_planeamento);
        console.log('üî• DEBUG LOGIN - Role valor:', user.role, 'Tipo:', typeof user.role);
        
        // Criar sess√£o local
        const sessionData = {
            username: user.username,
            nomeCompleto: user.nome_completo,
            departamento: user.departamento,
            role: user.role,
            // ‚úÖ v3.7.2.13: Usar underscores (Supabase padr√£o)
            podeEditarPlaneamento: user.pode_editar_planeamento === true || 
                                  user.pode_editar_planeamento === 'true',
            ativo: true, // Sempre ativo se fez login
            token: 'supabase_' + Date.now()
        };
        
        console.log('üî• DEBUG LOGIN - Sess√£o criada:', sessionData);
        console.log('üî• DEBUG LOGIN - podeEditarPlaneamento final:', sessionData.podeEditarPlaneamento);
        
        AppState.currentUser = sessionData;
        localStorage.setItem(CONFIG.STORAGE_KEYS.USER_SESSION, JSON.stringify(sessionData));
        localStorage.setItem(CONFIG.STORAGE_KEYS.USER_TOKEN, sessionData.token);
        setCookie('maintenance_user_session', JSON.stringify(sessionData), 30);
        setCookie('maintenance_user_token', sessionData.token, 30);
        
        showToast(`Bem-vindo, ${sessionData.nomeCompleto}!`, 'success');
        
        hideLoginModal();
        showUserInterface();
        
        setTimeout(() => {
            applyUserAutoFill();
            applyPermissions();
        }, 200);
        
        // üî• CARREGAR DADOS DO SUPABASE
        if (AppState.isOnline) await loadDataFromSupabase();
        renderRequestsList();
        
    } catch (e) {
        console.error('‚ùå Erro ao fazer login:', e);
        showLoginError('Erro ao conectar ao servidor. Verifique a liga√ß√£o √† internet.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<svg style="width: 20px; height: 20px; margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/></svg>Entrar';
    }
}

// üî• NOVA FUN√á√ÉO v3.6.8: Carregar dados do Supabase
async function loadDataFromSupabase() {
    try {
        console.log('üì• A carregar dados do Supabase...');
        
        // Carregar pedidos
        const pedidos = await window.SupabaseAPI.getPedidos();
        
        // üîé DEBUG: Ver estrutura dos dados
        console.log('üîé PEDIDOS RECEBIDOS DO SUPABASE:');
        console.log('Total:', pedidos.length);
        if (pedidos.length > 0) {
            console.log('Primeiro pedido:', JSON.stringify(pedidos[0], null, 2));
        }
        
        // Converter formato Supabase ‚Üí formato da app
        AppState.requests = pedidos.map(p => ({
            id: p.ID,
            dataHora: p['Data/hora'],           // ‚úÖ Corrigido: era timestamp
            tipo: p.Tipo,                       // ‚úÖ Corrigido: era type
            frequencia: p.frequencia || '',     // ‚úÖ v3.7.0.8: snake_case
            dataPrimeiraIntervencao: p.data_primeira_intervencao || '',  // ‚úÖ v3.7.0.8: snake_case
            prioridade: p.Prioridade,           // ‚úÖ Corrigido: era priority
            departamento: p.Departamento,       // ‚úÖ Corrigido: era department
            descricao: p.Descri√ß√£o,             // ‚úÖ Corrigido: era description
            nome: p['Registado por'],           // ‚úÖ Corrigido: era registeredBy
            estado: p.Estado,                   // ‚úÖ Corrigido: era status
            foto: p.Foto || '',                 // ‚úÖ OK
            artigos: p.Artigos ? (typeof p.Artigos === 'string' ? JSON.parse(p.Artigos) : p.Artigos) : [],
            empresa: p.Empresa,                 // ‚úÖ Corrigido: era company
            tipoIntervencao: p['Tipo Interven√ß√£o'] || '', // ‚úÖ Corrigido: era interventionType
            areaEquipamento: p['√Årea/Equipamento'] || '', // ‚úÖ Corrigido: era areaEquipment
            componente: p.Componente || '',     // ‚úÖ Corrigido: era component
            urgente: p.Urgente === 'TRUE' || p.Urgente === true,
            paragemProducao: p['Paragem Produ√ß√£o'] === 'TRUE' || p['Paragem Produ√ß√£o'] === true,
            responsavel: p.Respons√°vel || '',   // ‚úÖ ADICIONADO v3.6.21
            horasEstimadas: parseFloat(p['Horas Estimadas']) || 0  // ‚úÖ ADICIONADO v3.6.21
        }));
        
        // ‚úÖ Ordenar por data (mais recentes primeiro) - ordem no JavaScript
        AppState.requests.sort((a, b) => {
            const dateA = new Date(a.dataHora);  // ‚úÖ Corrigido: era timestamp
            const dateB = new Date(b.dataHora);  // ‚úÖ Corrigido: era timestamp
            return dateB - dateA; // DESC
        });
        
        // Guardar localmente
        localStorage.setItem(CONFIG.STORAGE_KEYS.REQUESTS, JSON.stringify(AppState.requests));
        
        console.log(`‚úÖ ${AppState.requests.length} ordens de trabalho carregadas do Supabase`);
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar dados do Supabase:', error);
        showToast('Erro ao carregar dados', 'error');
        
        // Em caso de erro, carregar do localStorage
        const cached = localStorage.getItem(CONFIG.STORAGE_KEYS.REQUESTS);
        if (cached) {
            AppState.requests = JSON.parse(cached);
            console.log('üì¶ Dados carregados do cache local');
        }
    }
}

async function validateSession(username, token) {
    // üî• v3.6.8: Simplificado - valida√ß√£o local apenas
    try {
        console.log('üîê validateSession() - Validando sess√£o para:', username);
        console.log('üîê validateSession() - Token existe?', token ? 'SIM' : 'N√ÉO');
        
        // Verificar se existe sess√£o local v√°lida
        const sessionData = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_SESSION);
        const sessionToken = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_TOKEN);
        
        if (sessionData && sessionToken === token) {
            const userData = JSON.parse(sessionData);
            
            if (userData.username === username) {
                console.log('‚úÖ validateSession() - Sess√£o V√ÅLIDA (local)');
                AppState.currentUser = userData;
                return true;
            }
        }
        
        console.warn('‚ö†Ô∏è validateSession() - Sess√£o INV√ÅLIDA');
        return false;
        
    } catch (e) {
        console.error('‚ùå validateSession() - ERRO:', e);
        return false;
    }
}

function showLoginError(message) {
    const errorDiv = document.getElementById('loginError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function showUserInterface() {
    if (!AppState.currentUser) return;
    
    // ‚úÖ v3.7.2.13: Validar campos obrigat√≥rios
    if (!AppState.currentUser.username || !AppState.currentUser.nomeCompleto) {
        console.error('‚ùå Dados do utilizador incompletos:', AppState.currentUser);
        showLoginError('Erro ao carregar dados do utilizador. Tenta fazer login novamente.');
        return;
    }
    
    hideLoginModal();
    
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (userInfo) {
        userInfo.querySelector('.user-name').textContent = AppState.currentUser.nomeCompleto;
        userInfo.querySelector('.user-dept').textContent = AppState.currentUser.departamento || 'N/A';
        userInfo.style.display = 'flex';
    }
    
    if (logoutBtn) {
        logoutBtn.style.display = 'flex';
    }
    
    // üß™ Mostrar bot√µes de teste para Marco e Gon√ßalo
    const testarAlertasBtn = document.getElementById('testarAlertasBtn');
    const processarManualBtn = document.getElementById('processarManualBtn');
    
    const utilizadorNormalizado = AppState.currentUser.username.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    const isMarcoOuGoncalo = utilizadorNormalizado === 'marco' || utilizadorNormalizado === 'goncalo';
    
    if (isMarcoOuGoncalo) {
        if (testarAlertasBtn) {
            testarAlertasBtn.style.display = 'block';
            console.log('üß™ [DEBUG] Bot√£o de alertas ativado para', AppState.currentUser.username);
        }
        
        if (processarManualBtn) {
            processarManualBtn.style.display = 'flex';
            console.log('üìö [DEBUG] Bot√£o de processar manual ativado para', AppState.currentUser.username);
        }
    }
    
    applyUserAutoFill();
    applyPermissions();
    
    // üìä Mostrar info de armazenamento (s√≥ para admins)
    if (AppState.currentUser.role === 'admin' || AppState.currentUser.role === 'Administrador') {
        showStorageInfo();
    }
}

// Mostrar informa√ß√£o de armazenamento (para admins)
function showStorageInfo() {
    setTimeout(() => {
        const storageInfo = getLocalStorageInfo();
        if (parseFloat(storageInfo.usagePercent) > 50) {
            console.warn(`‚ö†Ô∏è [ADMIN] LocalStorage: ${storageInfo.totalMB} MB (${storageInfo.usagePercent}% usado)`);
            
            if (storageInfo.isNearLimit) {
                showToast(`‚ö†Ô∏è Cache pr√≥ximo do limite (${storageInfo.usagePercent}%). Auto-limpeza ativa.`, 'warning');
            }
        }
    }, 2000);
}

function applyUserAutoFill() {
    if (!AppState.currentUser) return;
    
    const nomeInput = document.getElementById('nome');
    if (nomeInput) {
        nomeInput.value = AppState.currentUser.nomeCompleto;
        nomeInput.readOnly = true;
        nomeInput.style.background = '#F5F5F7';
        nomeInput.style.cursor = 'not-allowed';
    }
    
    const departamentoInput = document.getElementById('departamento');
    if (departamentoInput) {
        departamentoInput.value = AppState.currentUser.departamento;
        departamentoInput.readOnly = true;
        departamentoInput.style.background = '#F5F5F7';
        departamentoInput.style.cursor = 'not-allowed';
    }
    
    const movimentoResponsavel = document.getElementById('movimentoResponsavel');
    if (movimentoResponsavel) {
        movimentoResponsavel.value = AppState.currentUser.nomeCompleto;
    }
}

function applyPermissions() {
    if (!AppState.currentUser) return;
    
    const role = AppState.currentUser.role;
    const podeEditarPlaneamento = AppState.currentUser.podeEditarPlaneamento;
    const username = AppState.currentUser.username.toLowerCase();
    
    // üîí v3.7.4.1: Mostrar aba Manuais apenas para admins e Gon√ßalo
    const tabManuaisBtn = document.getElementById('tabManuaisBtn');
    if (tabManuaisBtn) {
        // Normalizar nome (remover acentos/cedilhas)
        const usernameNormalizado = username.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
        const isAdmin = role === 'admin' || role === 'Administrador';
        const isGoncalo = usernameNormalizado === 'goncalo' || username === 'gon√ßalo';
        
        if (isAdmin || isGoncalo) {
            tabManuaisBtn.style.display = 'flex';
            console.log('‚úÖ Aba Manuais habilitada para:', username);
        } else {
            tabManuaisBtn.style.display = 'none';
            console.log('üîí Aba Manuais oculta para:', username);
        }
    }
    
    // Controlo de acesso ao Planeamento
    if (!podeEditarPlaneamento && role !== 'admin') {
        const planningTab = document.querySelector('.tab-content[data-tab="planeamento"]');
        if (planningTab) {
            const allInputs = planningTab.querySelectorAll('input, select, button, textarea');
            allInputs.forEach(input => {
                input.disabled = true;
                input.style.opacity = '0.6';
                input.title = 'Sem permiss√£o para editar o planeamento';
            });
            
            // Adicionar aviso
            const warningDiv = document.createElement('div');
            warningDiv.className = 'permission-warning';
            warningDiv.style.cssText = 'background: #FFF4E5; border: 1px solid #FF9500; padding: 12px; border-radius: 8px; margin-bottom: 16px; color: #1D1D1F; font-size: 14px;';
            warningDiv.innerHTML = '<strong>‚ö†Ô∏è Visualiza√ß√£o apenas:</strong> N√£o tem permiss√£o para editar o planeamento.';
            planningTab.insertBefore(warningDiv, planningTab.firstChild);
        }
    }
    
    console.log('üîí Permiss√µes aplicadas - Role:', role, '| Editar Planeamento:', podeEditarPlaneamento);
}

// ============================================
// FUN√á√ïES DE COOKIES (BACKUP PERSISTENTE)
// ============================================

function setCookie(name, value, days = 30) {
    try {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + date.toUTCString();
        
        // Tentar com SameSite=None para PWA (precisa Secure em HTTPS)
        if (window.location.protocol === 'https:') {
            document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/;SameSite=None;Secure";
        } else {
            // HTTP ou file:// - usar Lax (mais compat√≠vel)
            document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/;SameSite=Lax";
        }
        
        // BACKUP: Sempre salvar no localStorage tamb√©m (iOS pode bloquear cookies)
        try {
            localStorage.setItem('cookie_' + name, value);
            localStorage.setItem('cookie_' + name + '_expires', date.getTime().toString());
        } catch (e) {
            console.warn('localStorage backup falhou:', e);
        }
    } catch (e) {
        console.error('Erro ao definir cookie:', e);
    }
}

function getCookie(name) {
    // Tentar ler do cookie primeiro
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) {
            return decodeURIComponent(c.substring(nameEQ.length, c.length));
        }
    }
    
    // BACKUP: Se cookie n√£o existe, tentar localStorage (iOS pode bloquear cookies)
    try {
        const backupValue = localStorage.getItem('cookie_' + name);
        const backupExpires = localStorage.getItem('cookie_' + name + '_expires');
        
        if (backupValue && backupExpires) {
            const expiresTime = parseInt(backupExpires);
            if (Date.now() < expiresTime) {
                return backupValue;
            } else {
                // Expirado - limpar
                localStorage.removeItem('cookie_' + name);
                localStorage.removeItem('cookie_' + name + '_expires');
            }
        }
    } catch (e) {
        console.warn('localStorage backup read falhou:', e);
    }
    
    return null;
}

function deleteCookie(name) {
    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;";
}

function logout() {
    clearSession();
    AppState.currentUser = null;
    
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (userInfo) userInfo.style.display = 'none';
    if (logoutBtn) logoutBtn.style.display = 'none';
    
    showToast('Sess√£o terminada', 'info');
    showLoginModal();
    
    document.getElementById('loginForm').reset();
    document.getElementById('loginError').style.display = 'none';
}

function clearSession() {
    localStorage.removeItem(CONFIG.STORAGE_KEYS.USER_SESSION);
    localStorage.removeItem(CONFIG.STORAGE_KEYS.USER_TOKEN);
    deleteCookie('maintenance_user_session');
    deleteCookie('maintenance_user_token');
    APP_INITIALIZED = false;
}

// ============================================
// PROTE√á√ÉO CONTRA REINICIALIZA√á√ïES
// ============================================

// Flag global para evitar m√∫ltiplas inicializa√ß√µes
let APP_INITIALIZED = false;

// Verificar se j√° existe sess√£o ativa ANTES do DOMContentLoaded
(function checkExistingSession() {
    const savedSession = localStorage.getItem('maintenance_user_session');
    const savedToken = localStorage.getItem('maintenance_user_token');
    const cookieSession = getCookie('maintenance_user_session');
    const cookieToken = getCookie('maintenance_user_token');
    
    if ((savedSession && savedToken) || (cookieSession && cookieToken)) {
        APP_INITIALIZED = true;
        console.log('üîê Sess√£o detectada ANTES do DOM - modal permanecer√° escondido');
        
        // ESCONDER MODAL IMEDIATAMENTE ao carregar DOM
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('‚úÖ Modal escondido imediatamente');
            }
        }, { once: true, capture: true });
    }
})();

// üîç DEBUG: Fun√ß√£o para testar equipamentos e atualizar painel visual
async function testarEquipamentos() {
    const statusEl = document.getElementById('debugEquipStatus');
    const totalEl = document.getElementById('debugEquipTotal');
    const areasEl = document.getElementById('debugEquipAreas');
    const firstEl = document.getElementById('debugEquipFirst');
    
    try {
        statusEl.textContent = 'üîÑ Carregando...';
        statusEl.style.color = '#ff9800';
        
        const resultado = await window.SupabaseAPI.getEquipamentos();
        AppState.equipamentos = resultado || [];
        
        const total = AppState.equipamentos.length;
        const areasUnicas = [...new Set(AppState.equipamentos.map(e => e.area))];
        const primeiro = AppState.equipamentos[0] || null;
        
        totalEl.textContent = total;
        totalEl.style.color = total > 0 ? '#4CAF50' : '#f44336';
        areasEl.textContent = areasUnicas.length;
        areasEl.style.color = areasUnicas.length > 0 ? '#4CAF50' : '#f44336';
        
        if (primeiro) {
            firstEl.textContent = `${primeiro.area} ‚Üí ${primeiro.componente}`;
            firstEl.style.color = '#4CAF50';
        } else {
            firstEl.textContent = '‚ùå Nenhum equipamento encontrado';
            firstEl.style.color = '#f44336';
        }
        
        if (total > 0) {
            statusEl.textContent = `‚úÖ ${total} equipamentos carregados!`;
            statusEl.style.color = '#4CAF50';
            
            // ‚úÖ N√ÉO popular equipamentos automaticamente
            // Aguardar utilizador selecionar empresa primeiro
            const areaSelect = document.getElementById('areaEquipamento');
            if (areaSelect) {
                areaSelect.innerHTML = '<option value="">Escolha primeiro a empresa</option>';
                areaSelect.disabled = true;
            }
            
            populateEquipamentoFilter();
        } else {
            statusEl.textContent = '‚ùå ERRO: Supabase retornou 0 equipamentos!';
            statusEl.style.color = '#f44336';
        }
    } catch (error) {
        statusEl.textContent = `‚ùå ${error.message}`;
        statusEl.style.color = '#f44336';
        totalEl.textContent = '0';
        areasEl.textContent = '0';
        firstEl.textContent = error.message;
    }
}

function atualizarPainelDebug() {
    const totalEl = document.getElementById('debugEquipTotal');
    if (!totalEl) return;
    
    const total = AppState.equipamentos.length;
    const areasUnicas = [...new Set(AppState.equipamentos.map(e => e.area))];
    const primeiro = AppState.equipamentos[0] || null;
    
    totalEl.textContent = total;
    totalEl.style.color = total > 0 ? '#4CAF50' : '#f44336';
    document.getElementById('debugEquipAreas').textContent = areasUnicas.length;
    
    if (primeiro) {
        document.getElementById('debugEquipFirst').textContent = `${primeiro.area} ‚Üí ${primeiro.componente}`;
        document.getElementById('debugEquipFirst').style.color = '#4CAF50';
    } else {
        document.getElementById('debugEquipFirst').textContent = 'Vazio';
        document.getElementById('debugEquipFirst').style.color = '#999';
    }
    
    document.getElementById('debugEquipStatus').textContent = total > 0 ? '‚úÖ OK' : '‚ö†Ô∏è Vazio';
    document.getElementById('debugEquipStatus').style.color = total > 0 ? '#4CAF50' : '#ff9800';
}

// INICIALIZA√á√ÉO
document.addEventListener('DOMContentLoaded', () => { 
    // üî• FIX TEMPOR√ÅRIO: For√ßar tab inicial para "novo"
    localStorage.setItem('activeTab', 'novo');
    console.log('üîß FIX: Tab inicial for√ßada para "novo"');
    initializeApp(); 
});

window.addEventListener('pageshow', (event) => {
    console.log('üîÑ pageshow event - verificando sess√£o...');
    setTimeout(() => {
        if (!AppState.currentUser) {
            checkAuthentication();
        }
    }, 100);
});

async function initializeApp() {
    // Se j√° est√° inicializado e tem sess√£o v√°lida, apenas restaurar UI
    if (APP_INITIALIZED && AppState.currentUser) {
        showUserInterface();
        renderRequestsList();
        return;
    }
    
    // üßπ LIMPEZA AUTOM√ÅTICA DI√ÅRIA (primeiro que tudo!)
    cleanOldDataFromLocalStorage();
    
    await unregisterServiceWorkers();
    setupEventListeners();
    setupOnlineOfflineListeners();
    
    const isAuthenticated = await checkAuthentication();
    
    if (!isAuthenticated) {
        APP_INITIALIZED = false;
        return;
    }
    
    APP_INITIALIZED = true;
    
    console.log('üì• Carregando dados do localStorage...');
    loadFromLocalStorage();
    console.log('üìä Pedidos do localStorage:', AppState.requests?.length || 0);
    
    loadSavedUserName();
    
    // üî• AGUARDAR sincroniza√ß√£o ANTES de restaurar aba
    if (AppState.isOnline) {
        console.log('üåê Online - sincronizando com Supabase...');
        await syncWithGoogleSheets();  // üî• Nome legacy, usa Supabase internamente
        console.log('‚úÖ Sincroniza√ß√£o completa - Pedidos:', AppState.requests?.length || 0);
    } else {
        console.warn('üìµ Offline - usando apenas localStorage');
    }
    
    renderRequestsList();
    // await initializePlanning();  // ‚ùå REMOVIDO v3.7.2.4: Tab Planeamento foi removida
    // initializeAutonomousMaintenance(); // ‚ùå REMOVIDO v3.7.2.2: Tab Aut√≥nomas foi removida
    initializeStockModule();
    
    // ‚úÖ v3.7.2.4: Carregar zonas do Supabase
    await carregarZonas();
    
    // üìö Carregar manuais em background (para chatbot)
    // carregarManuaisBackground(); // ‚ùå REMOVIDO v3.7.2.2: Tab Manuais foi removida
    
    // ‚úÖ CORRE√á√ÉO: Restaurar aba ativa DEPOIS dos dados carregarem
    restoreActiveTab();
    
    // ‚ùå REMOVIDO v3.7.2.4: Alertas de produtividade (Marco/Gon√ßalo)
}

// ‚ùå REMOVIDO v3.7.2.4: Todo o sistema de alertas de produtividade (Marco/Gon√ßalo)

// ===========================================
// üìö PROCESSAMENTO DE MANUAIS (PDF)
// ===========================================

/**
    
    // üîí Apenas para Marco e Gon√ßalo (com ou sem cedilha)
    // Usar 'username' em vez de 'name'
    const utilizadorAtual = AppState.currentUser?.username || '';
    console.log('üö® [DEBUG] Utilizador atual:', utilizadorAtual);
    
    // Normalizar nome (remover acentos para compara√ß√£o)
    const utilizadorNormalizado = utilizadorAtual.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    const isMarcoOuGoncalo = utilizadorNormalizado === 'marco' || utilizadorNormalizado === 'goncalo';
    
    if (!isMarcoOuGoncalo) {
        console.log('üö® [DEBUG] Utilizador n√£o √© Marco/Gon√ßalo - SEM ALERTAS');
        return; // N√£o mostrar alertas para outros utilizadores
    }
    
    console.log('‚úÖ [DEBUG] Utilizador √© Marco ou Gon√ßalo - CONTINUAR VERIFICA√á√ÉO');
    
    // üìÖ Calcular √∫ltimo dia √∫til
    const ultimoDiaUtil = calcularUltimoDiaUtil();
    console.log('üö® [DEBUG] √öltimo dia √∫til calculado:', ultimoDiaUtil);
    
    if (!ultimoDiaUtil) {
        console.log('üö® [DEBUG] Hoje √© Domingo - SEM VERIFICA√á√ÉO');
        return; // Domingo - sem verifica√ß√£o
    }
    
    // üîÑ Verificar se j√° foi alertado HOJE
    const hoje = new Date().toISOString().split('T')[0];
    const ultimaVerificacao = localStorage.getItem('ultima_verificacao_alertas');
    
    if (ultimaVerificacao === hoje) {
        console.log('‚úÖ Alertas j√° verificados hoje');
        return; // J√° foi alertado hoje
    }
    
    // üïê Definir hor√°rio do dia √∫til (00:00:00 at√© 23:59:59)
    const inicioDia = new Date(ultimoDiaUtil);
    inicioDia.setHours(0, 0, 0, 0);
    
    const fimDia = new Date(ultimoDiaUtil);
    fimDia.setHours(23, 59, 59, 999);
    
    console.log(`üìä Verificar OTs fechadas entre ${inicioDia.toLocaleString('pt-PT')} e ${fimDia.toLocaleString('pt-PT')}`);
    
    // üîç PRIMEIRO: Buscar TODOS os pedidos do Supabase
    console.log('üîç [DEBUG] Buscando todos os pedidos do Supabase...');
    const todosPedidos = await window.SupabaseAPI.getPedidos();
    
    if (todosPedidos && todosPedidos.length > 0) {
        const responsaveisUnicos = [...new Set(todosPedidos.map(p => p['Respons√°vel']).filter(r => r))].sort();
        console.log('üîç [DEBUG] Respons√°veis encontrados no Supabase:', responsaveisUnicos);
    }
    
    // üë• T√©cnicos a monitorizar
    const tecnicos = ['V√≠tor', 'Alan', 'Paulo'];
    console.log('üë• [DEBUG] T√©cnicos a verificar:', tecnicos);
    const tecnicosSemProducao = [];
    
    // üîç Verificar cada t√©cnico
    for (const tecnico of tecnicos) {
        try {
            console.log(`üîé [DEBUG] Verificando t√©cnico: "${tecnico}"...`);
            
            // Filtrar pedidos do t√©cnico, estado Resolvido e no per√≠odo
            const pedidosFiltrados = todosPedidos.filter(p => {
                const dataPedido = new Date(p['Data/hora']);
                return p['Respons√°vel'] === tecnico &&
                       p.Estado === 'Resolvido' &&
                       dataPedido >= inicioDia &&
                       dataPedido <= fimDia;
            });
            
            const data = pedidosFiltrados;
            const error = null;
            
            if (error) {
                console.error(`‚ùå Erro ao verificar OTs de ${tecnico}:`, error);
                continue;
            }
            
            const totalOTsFechadas = data?.length || 0;
            console.log(`üìã ${tecnico}: ${totalOTsFechadas} OT(s) fechadas`);
            
            // üêõ [DEBUG] Mostrar OTs encontradas
            if (data && data.length > 0) {
                console.log(`   ‚Ü≥ OTs de ${tecnico}:`, data.map(ot => ({
                    id: ot.ID,
                    responsavel: ot['Respons√°vel'],
                    estado: ot.Estado,
                    data: new Date(ot['Data/hora']).toLocaleString('pt-PT')
                })));
            } else {
                console.log(`   ‚Ü≥ ${tecnico}: NENHUMA OT fechada no per√≠odo!`);
            }
            
            // üö® Se ZERO OTs fechadas, adicionar √† lista
            if (totalOTsFechadas === 0) {
                tecnicosSemProducao.push(tecnico);
            }
            
        } catch (err) {
            console.error(`‚ùå Erro na verifica√ß√£o de ${tecnico}:`, err);
        }
    }
    
    // üéØ Mostrar banner se houver t√©cnicos sem produ√ß√£o
    if (tecnicosSemProducao.length > 0) {
        console.log('üö® T√©cnicos sem produ√ß√£o:', tecnicosSemProducao);
        mostrarBannerAlerta(tecnicosSemProducao, ultimoDiaUtil);
        
        // üíæ Guardar alertas pendentes
        localStorage.setItem('alertas_pendentes', JSON.stringify({
            tecnicos: tecnicosSemProducao,
            data: ultimoDiaUtil.toISOString(),
            timestamp: new Date().toISOString()
        }));
    } else {
        console.log('‚úÖ Todos os t√©cnicos produziram OTs');
    }
    
    // üóìÔ∏è Marcar como verificado HOJE
    localStorage.setItem('ultima_verificacao_alertas', hoje);
}

/**
 * Mostrar banner de alerta no topo da p√°gina
 * @param {string[]} tecnicos - Lista de t√©cnicos sem produ√ß√£o
 * @param {Date} dataReferencia - Data do √∫ltimo dia √∫til
 */
function mostrarBannerAlerta(tecnicos, dataReferencia) {
    // üóëÔ∏è Remover banner antigo (se existir)
    const bannerAntigo = document.getElementById('bannerAlertaProducao');
    if (bannerAntigo) {
        bannerAntigo.remove();
    }
    
    // üìÖ Formatar data
    const dataFormatada = dataReferencia.toLocaleDateString('pt-PT', {
        weekday: 'long',
        day: 'numeric',
        month: 'long'
    });
    
    // üé® Criar HTML do banner
    const banner = document.createElement('div');
    banner.id = 'bannerAlertaProducao';
    banner.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        color: white;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        z-index: 10000;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        animation: slideDown 0.3s ease-out;
    `;
    
    // Adicionar anima√ß√£o CSS
    if (!document.getElementById('alertaAnimationStyle')) {
        const style = document.createElement('style');
        style.id = 'alertaAnimationStyle';
        style.textContent = `
            @keyframes slideDown {
                from {
                    transform: translateY(-100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    // üìù Texto do alerta
    const tecnicosTexto = tecnicos.length === 1 
        ? tecnicos[0] 
        : tecnicos.slice(0, -1).join(', ') + ' e ' + tecnicos[tecnicos.length - 1];
    
    const mensagem = tecnicos.length === 1
        ? `${tecnicosTexto} n√£o fechou nenhuma Ordem de Trabalho em ${dataFormatada}.`
        : `${tecnicosTexto} n√£o fecharam nenhuma Ordem de Trabalho em ${dataFormatada}.`;
    
    banner.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
            <div style="font-size: 24px;">‚ö†Ô∏è</div>
            <div>
                <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">
                    Alerta de Produtividade
                </div>
                <div style="font-size: 13px; opacity: 0.95;">
                    ${mensagem}
                </div>
            </div>
        </div>
        <button 
            onclick="fecharAlerta()" 
            style="
                background: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s;
                backdrop-filter: blur(10px);
            "
            onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"
            onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
        >
            Entendido
        </button>
    `;
    
    // üìç Inserir no in√≠cio do body
    document.body.insertBefore(banner, document.body.firstChild);
    
    // ‚¨áÔ∏è Ajustar padding do conte√∫do principal
    const mainContent = document.querySelector('.app-wrapper') || document.body;
    const bannerHeight = banner.offsetHeight;
    mainContent.style.paddingTop = `${bannerHeight + 20}px`;
    
    console.log('üö® Banner de alerta exibido');
}

/**
 * Fechar banner de alerta
 */
window.fecharAlerta = function() {
    const banner = document.getElementById('bannerAlertaProducao');
    if (banner) {
        // Anima√ß√£o de sa√≠da
        banner.style.animation = 'slideDown 0.3s ease-out reverse';
        setTimeout(() => {
            banner.remove();
            // ‚¨ÜÔ∏è Remover padding do conte√∫do principal
            const mainContent = document.querySelector('.app-wrapper') || document.body;
            mainContent.style.paddingTop = '';
        }, 300);
        
        console.log('‚úÖ Banner fechado');
    }
};

/**
 * Mostrar alertas pendentes (ao clicar no bot√£o)
 */
window.mostrarAlertasPendentes = async function() {
    console.log('üö® Verificando alertas pendentes...');
    
    // Verificar se h√° alertas guardados
    const alertasPendentes = localStorage.getItem('alertas_pendentes');
    
    if (alertasPendentes) {
        try {
            const alertasData = JSON.parse(alertasPendentes);
            const dataAlerta = new Date(alertasData.data);
            
            console.log('üö® Alertas pendentes encontrados:', alertasData);
            
            // Mostrar banner com alertas guardados
            mostrarBannerAlerta(alertasData.tecnicos, dataAlerta);
            
        } catch (e) {
            console.error('‚ùå Erro ao ler alertas pendentes:', e);
        }
    } else {
        // Se n√£o h√° alertas, for√ßar nova verifica√ß√£o
        console.log('üîÑ Sem alertas pendentes - for√ßando nova verifica√ß√£o...');
        
        // Limpar flag de verifica√ß√£o para for√ßar nova checagem
        localStorage.removeItem('ultima_verificacao_alertas');
        
        // Fechar banner existente (se houver)
        const bannerAntigo = document.getElementById('bannerAlertaProducao');
        if (bannerAntigo) {
            bannerAntigo.remove();
        }
        
        // For√ßar nova verifica√ß√£o
        await verificarAlertasDiarios();
    }
};

// ===========================================
// üìö PROCESSAMENTO DE MANUAIS (PDF)
// ===========================================

/**
 * Processar manual: extrair texto do PDF e dividir em sec√ß√µes
 * @param {string} manualId - UUID do manual na BD
 */
// ‚ùå FUN√á√ÉO ANTIGA REMOVIDA - Usava manualId em vez de dados do formul√°rio
// A nova fun√ß√£o processarManual est√° abaixo (linha ~6894)

/**
 * Extrair texto de um PDF usando PDF.js
 * @param {string} pdfUrl - URL do PDF
 * @returns {Promise<{textoCompleto: string, numPaginas: number}>}
 */
async function extrairTextoDoPDF(pdfUrl) {
    if (typeof pdfjsLib === 'undefined') {
        throw new Error('PDF.js n√£o est√° carregado');
    }
    
    // Carregar PDF
    const loadingTask = pdfjsLib.getDocument(pdfUrl);
    const pdf = await loadingTask.promise;
    const numPaginas = pdf.numPages;
    
    let textoCompleto = '';
    
    // Extrair texto de cada p√°gina
    for (let i = 1; i <= numPaginas; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        
        textoCompleto += `\n\n--- P√ÅGINA ${i} ---\n${pageText}`;
        
        // Log de progresso a cada 10 p√°ginas
        if (i % 10 === 0) {
            console.log(`  üìÑ Processadas ${i}/${numPaginas} p√°ginas...`);
        }
    }
    
    return { textoCompleto, numPaginas };
}

/**
 * Dividir texto em sec√ß√µes baseado em keywords e estrutura
 * @param {string} texto - Texto completo do manual
 * @param {number} numPaginas - N√∫mero total de p√°ginas
 * @returns {Array} Array de sec√ß√µes
 */
function dividirEmSeccoes(texto, numPaginas) {
    const seccoes = [];
    const linhas = texto.split('\n');
    
    // Definir keywords para identificar sec√ß√µes
    const keywordsSeccoes = {
        'Especifica√ß√µes T√©cnicas': ['especifica√ß√µes', 'caracter√≠sticas t√©cnicas', 'dados t√©cnicos', 'technical data'],
        'Opera√ß√£o': ['opera√ß√£o', 'funcionamento', 'operation', 'como usar'],
        'Manuten√ß√£o Preventiva': ['manuten√ß√£o preventiva', 'preventive maintenance', 'manuten√ß√£o programada'],
        'Troubleshooting': ['troubleshooting', 'resolu√ß√£o de problemas', 'problemas', 'falhas'],
        'Calibra√ß√£o': ['calibra√ß√£o', 'ajuste', 'calibration', 'afina√ß√£o'],
        'Seguran√ßa': ['seguran√ßa', 'safety', 'avisos', 'precau√ß√µes'],
        'Pe√ßas': ['pe√ßas', 'componentes', 'parts', 'spare parts'],
        'Diagramas': ['diagrama', 'esquema', 'desenho t√©cnico']
    };
    
    // Estrat√©gia simples: dividir em blocos de ~200 linhas ou por keywords
    let secaoAtual = {
        titulo: 'Introdu√ß√£o e Informa√ß√µes Gerais',
        texto: '',
        paginaInicio: 1,
        paginaFim: 10,
        palavrasChave: ['geral', 'introdu√ß√£o']
    };
    
    let linhasProcessadas = 0;
    const linhasPorSecao = Math.ceil(linhas.length / 8); // ~8 sec√ß√µes
    
    for (let i = 0; i < linhas.length; i++) {
        const linha = linhas[i];
        secaoAtual.texto += linha + '\n';
        linhasProcessadas++;
        
        // Verificar se encontramos um t√≠tulo de sec√ß√£o
        let tituloEncontrado = false;
        for (const [titulo, keywords] of Object.entries(keywordsSeccoes)) {
            if (keywords.some(kw => linha.toLowerCase().includes(kw))) {
                // Salvar sec√ß√£o atual (se tiver conte√∫do)
                if (secaoAtual.texto.length > 100) {
                    secaoAtual.paginaFim = Math.min(secaoAtual.paginaInicio + 15, numPaginas);
                    seccoes.push(secaoAtual);
                }
                
                // Iniciar nova sec√ß√£o
                secaoAtual = {
                    titulo: titulo,
                    texto: '',
                    paginaInicio: secaoAtual.paginaFim + 1,
                    paginaFim: Math.min(secaoAtual.paginaFim + 15, numPaginas),
                    palavrasChave: keywords
                };
                
                tituloEncontrado = true;
                break;
            }
        }
        
        // Se n√£o encontrou t√≠tulo e j√° processou muitas linhas, criar nova sec√ß√£o
        if (!tituloEncontrado && linhasProcessadas >= linhasPorSecao && secaoAtual.texto.length > 500) {
            secaoAtual.paginaFim = Math.min(secaoAtual.paginaInicio + 10, numPaginas);
            seccoes.push(secaoAtual);
            
            secaoAtual = {
                titulo: `Sec√ß√£o ${seccoes.length + 1}`,
                texto: '',
                paginaInicio: secaoAtual.paginaFim + 1,
                paginaFim: Math.min(secaoAtual.paginaFim + 10, numPaginas),
                palavrasChave: []
            };
            
            linhasProcessadas = 0;
        }
    }
    
    // Adicionar √∫ltima sec√ß√£o
    if (secaoAtual.texto.length > 100) {
        secaoAtual.paginaFim = numPaginas;
        seccoes.push(secaoAtual);
    }
    
    // Limitar tamanho do texto de cada sec√ß√£o (m√°x 5000 chars para performance)
    return seccoes.map(s => ({
        ...s,
        texto: s.texto.substring(0, 5000)
    }));
}

// ========================================
// üìö SISTEMA DE MANUAIS - PROCESSAMENTO PDF
// ========================================

// ============================================================================
// üé® PR√â-PROCESSAMENTO DE IMAGEM PARA OCR (v3.7.5.0)
// ============================================================================

/**
 * Aumentar contraste da imagem
 * @param {ImageData} imageData - Dados da imagem
 * @param {number} factor - Fator de contraste (1.0 = sem mudan√ßa, 2.0 = dobro)
 * @returns {ImageData} - Imagem com contraste aumentado
 */
function enhanceContrast(imageData, factor = 1.5) {
    const data = imageData.data;
    const contrastFactor = (259 * (factor * 255 + 255)) / (255 * (259 - factor * 255));
    
    for (let i = 0; i < data.length; i += 4) {
        data[i] = contrastFactor * (data[i] - 128) + 128;         // R
        data[i + 1] = contrastFactor * (data[i + 1] - 128) + 128; // G
        data[i + 2] = contrastFactor * (data[i + 2] - 128) + 128; // B
    }
    
    return imageData;
}

/**
 * Aplicar sharpening (nitidez) √† imagem
 * @param {CanvasRenderingContext2D} ctx - Contexto do canvas
 * @param {number} width - Largura
 * @param {number} height - Altura
 */
function sharpenImage(ctx, width, height) {
    const imageData = ctx.getImageData(0, 0, width, height);
    const data = imageData.data;
    const output = new Uint8ClampedArray(data);
    
    // Kernel de sharpening 3x3
    const kernel = [
        0, -1,  0,
       -1,  5, -1,
        0, -1,  0
    ];
    
    for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
            for (let c = 0; c < 3; c++) { // RGB (sem alpha)
                let sum = 0;
                for (let ky = -1; ky <= 1; ky++) {
                    for (let kx = -1; kx <= 1; kx++) {
                        const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                        const kernelIdx = (ky + 1) * 3 + (kx + 1);
                        sum += data[idx] * kernel[kernelIdx];
                    }
                }
                output[(y * width + x) * 4 + c] = sum;
            }
        }
    }
    
    for (let i = 0; i < data.length; i++) {
        data[i] = output[i];
    }
    
    ctx.putImageData(imageData, 0, 0);
}

/**
 * Remover ru√≠do (denoising) da imagem
 * @param {ImageData} imageData - Dados da imagem
 * @returns {ImageData} - Imagem sem ru√≠do
 */
function denoiseImage(imageData) {
    const data = imageData.data;
    const width = imageData.width;
    const height = imageData.height;
    const output = new Uint8ClampedArray(data);
    
    // Median filter 3x3 (simples mas eficaz)
    for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
            for (let c = 0; c < 3; c++) { // RGB
                const values = [];
                for (let ky = -1; ky <= 1; ky++) {
                    for (let kx = -1; kx <= 1; kx++) {
                        const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                        values.push(data[idx]);
                    }
                }
                values.sort((a, b) => a - b);
                output[(y * width + x) * 4 + c] = values[4]; // Mediana
            }
        }
    }
    
    for (let i = 0; i < data.length; i++) {
        data[i] = output[i];
    }
    
    return imageData;
}

/**
 * Binariza√ß√£o (preto/branco puro) - melhor para OCR
 * @param {ImageData} imageData - Dados da imagem
 * @param {number} threshold - Limiar (0-255, padr√£o: 128)
 * @returns {ImageData} - Imagem binarizada
 */
function binarizeImage(imageData, threshold = 128) {
    const data = imageData.data;
    
    for (let i = 0; i < data.length; i += 4) {
        // Converter para escala de cinza
        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
        
        // Aplicar threshold
        const value = gray > threshold ? 255 : 0;
        
        data[i] = value;     // R
        data[i + 1] = value; // G
        data[i + 2] = value; // B
    }
    
    return imageData;
}

/**
 * Pipeline completo de pr√©-processamento
 * @param {Canvas} canvas - Canvas com a imagem
 * @param {Object} options - Op√ß√µes de processamento
 * @returns {Canvas} - Canvas processado
 */
function preprocessImageForOCR(canvas, options = {}) {
    const {
        contrast = true,
        sharpen = true,
        denoise = true,
        binarize = false, // Opcional: pode piorar se o PDF for colorido
        contrastFactor = 1.5
    } = options;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    console.log('üé® Pr√©-processando imagem para OCR...');
    
    // 1. Aumentar contraste
    if (contrast) {
        let imageData = ctx.getImageData(0, 0, width, height);
        imageData = enhanceContrast(imageData, contrastFactor);
        ctx.putImageData(imageData, 0, 0);
        console.log('  ‚úÖ Contraste aumentado');
    }
    
    // 2. Remover ru√≠do
    if (denoise) {
        let imageData = ctx.getImageData(0, 0, width, height);
        imageData = denoiseImage(imageData);
        ctx.putImageData(imageData, 0, 0);
        console.log('  ‚úÖ Ru√≠do removido');
    }
    
    // 3. Aplicar sharpening
    if (sharpen) {
        sharpenImage(ctx, width, height);
        console.log('  ‚úÖ Nitidez aplicada');
    }
    
    // 4. Binariza√ß√£o (opcional)
    if (binarize) {
        let imageData = ctx.getImageData(0, 0, width, height);
        imageData = binarizeImage(imageData);
        ctx.putImageData(imageData, 0, 0);
        console.log('  ‚úÖ Binariza√ß√£o aplicada');
    }
    
    console.log('‚úÖ Pr√©-processamento conclu√≠do');
    return canvas;
}

// ============================================================================
// üìÑ CONVERS√ÉO E EXTRA√á√ÉO
// ============================================================================

/**
 * Converter p√°gina PDF em imagem (Canvas) para OCR
 * @param {Object} page - P√°gina do PDF.js
 * @param {number} scale - Escala de renderiza√ß√£o (padr√£o: 3.0 para melhor qualidade)
 * @returns {Promise<Canvas>} - Canvas com a imagem
 */
async function pdfPageToImage(page, scale = 3.0) {
    const viewport = page.getViewport({ scale });
    
    // Criar canvas tempor√°rio
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    
    // Renderizar p√°gina no canvas
    const renderContext = {
        canvasContext: context,
        viewport: viewport
    };
    
    await page.render(renderContext).promise;
    
    // üé® v3.7.5.0: Aplicar pr√©-processamento para melhorar OCR
    preprocessImageForOCR(canvas, {
        contrast: true,
        sharpen: true,
        denoise: true,
        binarize: false, // Mant√©m cores (pode ajudar em diagramas)
        contrastFactor: 1.5
    });
    
    // Retornar Canvas (Tesseract aceita Canvas diretamente)
    return canvas;
}

/**
 * Detectar regi√µes com imagens/tabelas em uma p√°gina
 * v3.7.6.0: Detec√ß√£o melhorada com scoring e classifica√ß√£o
 * @param {Canvas} canvas - Canvas com a p√°gina renderizada
 * @returns {Array} - Array de regi√µes detectadas {x, y, width, height, type, score}
 */
function detectImageRegions(canvas) {
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    const width = canvas.width;
    const height = canvas.height;
    
    // Detectar √°reas com alta densidade de conte√∫do n√£o-textual
    // (tabelas, diagramas, imagens t√©cnicas)
    const regions = [];
    const gridSize = 25; // üÜï v3.7.6.2: Blocos AINDA MENORES para tabelas pequenas (40‚Üí25)
    console.log(`üî¨ v3.7.6.7: GridSize=${gridSize}px, Adjac√™ncia=${1.5*gridSize}px (CORRE√á√ÉO: sobreposi√ß√£o de regi√µes), MinArea=3500px¬≤, tableScore>18, MinSize=80x80`);
    
    for (let y = 0; y < height; y += gridSize) {
        for (let x = 0; x < width; x += gridSize) {
            let edgeCount = 0;
            let horizontalLines = 0;
            let verticalLines = 0;
            let varianceSum = 0;
            let darkPixels = 0;
            
            // Analisar bloco
            for (let by = y; by < Math.min(y + gridSize, height); by++) {
                for (let bx = x; bx < Math.min(x + gridSize, width); bx++) {
                    const idx = (by * width + bx) * 4;
                    const gray = 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];
                    
                    if (gray < 100) darkPixels++;
                    
                    // Detectar bordas horizontais
                    if (bx < width - 1) {
                        const nextIdx = (by * width + (bx + 1)) * 4;
                        const nextGray = 0.299 * data[nextIdx] + 0.587 * data[nextIdx + 1] + 0.114 * data[nextIdx + 2];
                        const diff = Math.abs(gray - nextGray);
                        if (diff > 30) {
                            edgeCount++;
                            horizontalLines++;
                        }
                        varianceSum += diff;
                    }
                    
                    // Detectar bordas verticais
                    if (by < height - 1) {
                        const belowIdx = ((by + 1) * width + bx) * 4;
                        const belowGray = 0.299 * data[belowIdx] + 0.587 * data[belowIdx + 1] + 0.114 * data[belowIdx + 2];
                        if (Math.abs(gray - belowGray) > 30) verticalLines++;
                    }
                }
            }
            
            // Calcular scores
            const avgVariance = varianceSum / (gridSize * gridSize);
            const darkRatio = darkPixels / (gridSize * gridSize);
            const lineBalance = Math.min(horizontalLines, verticalLines) / Math.max(horizontalLines, verticalLines, 1);
            
            // Score de tabela: linhas cruzadas + equil√≠brio H/V
            const tableScore = (edgeCount * 0.3) + (avgVariance * 0.3) + (lineBalance * 40);
            
            // Score de diagrama: bordas + contraste
            const diagramScore = (edgeCount * 0.4) + (avgVariance * 0.4) + (darkRatio * 20);
            
            // üÜï v3.7.6.5: Thresholds MUITO RESTRITIVOS (evitar falsos positivos)
            // Classificar com valida√ß√£o RIGOROSA
            const isTable = tableScore > 18 && lineBalance > 0.35; // +50% no score, +40% no balance
            const isDiagram = diagramScore > 15 && darkRatio > 0.1 && darkRatio < 0.75; // +50% no score
            
            // üÜï DEBUG: Log das primeiras 5 regi√µes com score alto
            if ((tableScore > 10 || diagramScore > 10) && regions.length < 5) {
                console.log(`  [DEBUG] Regi√£o em (${x},${y}): tableScore=${tableScore.toFixed(1)}, diagramScore=${diagramScore.toFixed(1)}, lineBalance=${lineBalance.toFixed(2)}, darkRatio=${darkRatio.toFixed(2)}`);
            }
            
            if (isTable || isDiagram) {
                regions.push({
                    x: x,
                    y: y,
                    width: gridSize,
                    height: gridSize,
                    edgeCount: edgeCount,
                    avgVariance: avgVariance,
                    tableScore: tableScore,
                    diagramScore: diagramScore,
                    type: isTable ? 'table' : 'diagram',
                    score: Math.max(tableScore, diagramScore)
                });
            }
        }
    }
    
    // Mesclar regi√µes adjacentes
    let mergedRegions = []; // üîß v3.7.6.4: 'let' em vez de 'const' (permite reatribui√ß√£o no limite)
    const processed = new Set();
    
    for (let i = 0; i < regions.length; i++) {
        if (processed.has(i)) continue;
        
        let merged = { ...regions[i] };
        let typeCount = { table: 0, diagram: 0 };
        typeCount[merged.type]++;
        processed.add(i);
        
        // Procurar regi√µes adjacentes
        for (let j = i + 1; j < regions.length; j++) {
            if (processed.has(j)) continue;
            
            const r2 = regions[j];
            // üÜï v3.7.6.7: CORRE√á√ÉO CR√çTICA - Verificar sobreposi√ß√£o/proximidade de QUALQUER parte
            // Antes: comparava apenas cantos superiores esquerdos (falha com regi√µes crescentes)
            // Agora: verifica se qualquer parte de r2 est√° pr√≥xima de merged (raio 37.5px)
            const isAdjacent = 
                (r2.x <= merged.x + merged.width + 1.5 * gridSize && 
                 r2.x + r2.width >= merged.x - 1.5 * gridSize) &&
                (r2.y <= merged.y + merged.height + 1.5 * gridSize && 
                 r2.y + r2.height >= merged.y - 1.5 * gridSize);
            
            if (isAdjacent) {
                merged.x = Math.min(merged.x, r2.x);
                merged.y = Math.min(merged.y, r2.y);
                merged.width = Math.max(merged.x + merged.width, r2.x + r2.width) - merged.x;
                merged.height = Math.max(merged.y + merged.height, r2.y + r2.height) - merged.y;
                merged.score = Math.max(merged.score, r2.score);
                typeCount[r2.type]++;
                processed.add(j);
            }
        }
        
        // Determinar tipo final baseado na maioria
        merged.type = typeCount.table > typeCount.diagram ? 'table' : 'diagram';
        
        // S√≥ adicionar se a regi√£o for significativa
        const area = merged.width * merged.height;
        const minArea = 3500; // üÜï v3.7.6.6: √Årea m√≠nima REDUZIDA (5000‚Üí3500, ~59x59 px)
        const aspectRatio = merged.width / merged.height;
        
        // üÜï v3.7.6.6: Valida√ß√£o MODERADA de aspect ratio
        const isValidAspectRatio = aspectRatio > 0.5 && aspectRatio < 2.0; // Mais pr√≥ximo de quadrado
        
        // üÜï v3.7.6.6: Dimens√µes m√≠nimas REDUZIDAS (100‚Üí80px)
        const isValidSize = merged.width >= 80 && merged.height >= 80; // M√≠nimo 80x80px
        
        // üÜï v3.7.6.5: DEBUG - Log de regi√µes mescladas
        if (area > minArea && merged.score > 18 && isValidAspectRatio && isValidSize) { // Score 12‚Üí18
            console.log(`  [DEBUG-MERGE] Regi√£o v√°lida: (${merged.x},${merged.y}) ${merged.width}x${merged.height} = ${area}px¬≤ (score: ${merged.score.toFixed(1)}, tipo: ${merged.type}, aspect: ${aspectRatio.toFixed(2)})`);
            mergedRegions.push(merged);
        } else if (area > 2000) { // S√≥ log se for razoavelmente grande
            const rejectReasons = [];
            if (area <= minArea) rejectReasons.push(`√°rea=${area}px¬≤<${minArea}`);
            if (merged.score <= 18) rejectReasons.push(`score=${merged.score.toFixed(1)}<18`);
            if (!isValidAspectRatio) rejectReasons.push(`aspect=${aspectRatio.toFixed(2)} fora de 0.5-2.0`);
            if (!isValidSize) rejectReasons.push(`tamanho=${merged.width}x${merged.height}<100x100`);
            console.log(`  [DEBUG-REJECT] Regi√£o rejeitada: ${rejectReasons.join(', ')}`);
        }
    }
    
    // Ordenar por score (mais confiante primeiro)
    mergedRegions.sort((a, b) => b.score - a.score);
    
    // üÜï v3.7.6.4: LIMITE M√ÅXIMO de 10 tabelas/p√°gina (previne explos√£o)
    if (mergedRegions.length > 10) {
        console.warn(`‚ö†Ô∏è ALERTA: ${mergedRegions.length} tabelas detectadas! Limitando a 10 (top scores).`);
        mergedRegions = mergedRegions.slice(0, 10);
    }
    
    console.log(`üìä Total de regi√µes v√°lidas: ${mergedRegions.length}`);
    return mergedRegions;
}

/**
 * Extrair imagem de uma regi√£o espec√≠fica
 * @param {Canvas} sourceCanvas - Canvas original
 * @param {Object} region - Regi√£o {x, y, width, height}
 * @returns {Canvas} - Canvas com a regi√£o extra√≠da
 */
function extractImageRegion(sourceCanvas, region) {
    const canvas = document.createElement('canvas');
    canvas.width = region.width;
    canvas.height = region.height;
    const ctx = canvas.getContext('2d');
    
    ctx.drawImage(
        sourceCanvas,
        region.x, region.y, region.width, region.height,
        0, 0, region.width, region.height
    );
    
    return canvas;
}

/**
 * Converter canvas para Blob (para upload)
 * @param {Canvas} canvas - Canvas
 * @param {string} type - Tipo MIME (padr√£o: 'image/png')
 * @returns {Promise<Blob>} - Blob da imagem
 */
function canvasToBlob(canvas, type = 'image/png') {
    return new Promise((resolve) => {
        canvas.toBlob(resolve, type, 0.95);
    });
}

/**
 * Upload de imagem extra√≠da para Supabase Storage
 * v3.7.6.0: Suporte para tabelas e diagramas
 * @param {Blob} imageBlob - Blob da imagem
 * @param {string} manualId - ID do manual
 * @param {number} pageNum - N√∫mero da p√°gina
 * @param {string} type - Tipo da imagem ('table' ou 'diagram')
 * @param {number} index - √çndice da imagem na p√°gina (para m√∫ltiplas imagens)
 * @returns {Promise<string>} - URL p√∫blica da imagem
 */
async function uploadExtractedImage(imageBlob, manualId, pageNum, type, index = 0) {
    try {
        // Nome do arquivo: manual_id/page_XX_type_YY.png
        const fileName = `${manualId}/page_${String(pageNum).padStart(3, '0')}_${type}_${String(index).padStart(2, '0')}.png`;
        
        console.log(`üì§ Uploading ${type} image: ${fileName} (${(imageBlob.size / 1024).toFixed(1)} KB)`);
        
        // Upload via FormData (como no uploadManualPDF)
        const formData = new FormData();
        formData.append('file', imageBlob, fileName);
        
        const uploadUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/manuais/${fileName}`;
        
        const response = await fetch(uploadUrl, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_CONFIG.ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`,
                'x-upsert': 'true' // Sobrescrever se j√° existir
            },
            body: formData
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            console.error('‚ùå Erro ao fazer upload da imagem:', errorData);
            throw new Error(`Erro no upload: ${response.status}`);
        }
        
        // URL p√∫blica da imagem
        const publicUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/public/manuais/${fileName}`;
        
        console.log(`‚úÖ Imagem uploaded: ${publicUrl}`);
        return publicUrl;
        
    } catch (error) {
        console.error('‚ùå Erro ao fazer upload da imagem:', error);
        throw error;
    }
}

/**
 * Extrair texto de uma imagem usando Tesseract.js OCR
 * @param {ImageData|Canvas|string} image - Imagem para OCR
 * @param {string} lang - Idioma (padr√£o: 'por' = Portugu√™s)
 * @returns {Promise<string>} - Texto extra√≠do
 */
async function extractTextFromImage(image, lang = 'por') {
    try {
        const result = await Tesseract.recognize(
            image,
            lang,
            {
                logger: (m) => {
                    // Log de progresso opcional
                    if (m.status === 'recognizing text') {
                        console.log(`OCR: ${Math.round(m.progress * 100)}%`);
                    }
                }
            }
        );
        
        return result.data.text.trim();
    } catch (error) {
        console.error('‚ùå Erro no OCR:', error);
        return '';
    }
}

/**
 * Extrair texto completo de um ficheiro PDF usando PDF.js + OCR (fallback)
 * @param {File} file - Ficheiro PDF
 * @param {Function} progressCallback - Callback para atualizar progresso (opcional)
 * @returns {Promise<Object>} - { textoCompleto, numPaginas, secoes }
 */
async function extractTextFromPDF(file, progressCallback = null) {
    try {
        console.log('üìÑ A extrair texto do PDF:', file.name);
        
        // Converter File para ArrayBuffer
        const arrayBuffer = await file.arrayBuffer();
        
        // Carregar PDF com PDF.js
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        console.log(`üìÑ PDF carregado: ${pdf.numPages} p√°ginas`);
        
        let textoCompleto = '';
        const secoes = [];
        let textosPorPagina = {}; // Guardar texto de cada p√°gina
        let usouOCR = false;
        
        // PASSO 1: Tentar extrair texto normal (r√°pido)
        console.log('üîç Tentando extrair texto nativo do PDF...');
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const textContent = await page.getTextContent();
            
            // Juntar todos os items de texto
            const textoPage = textContent.items
                .map(item => item.str)
                .join(' ')
                .trim();
            
            textosPorPagina[pageNum] = textoPage;
            textoCompleto += textoPage + '\n\n';
        }
        
        // PASSO 2: Se n√£o encontrou texto (PDF escaneado), usar OCR PREMIUM
        // üî¥ v3.7.6.2: FOR√áAR OCR EM TODOS OS PDFs para testar detec√ß√£o de tabelas
        // Threshold: 999999 caracteres (FOR√áAR OCR sempre)
        if (textoCompleto.length < 999999) { // üî¥ TESTE: Era 500, agora 999999
            console.log('üî¥ MODO TESTE: OCR FOR√áADO em TODOS os PDFs (threshold: 999999)');
            console.log(`üìä Texto nativo encontrado: ${textoCompleto.length} caracteres`);
            console.log('üî¨ Iniciando OCR ULTRA (v3.7.6.2) com Tesseract.js...');
            console.log('‚è±Ô∏è ATEN√á√ÉO: OCR de alta qualidade pode levar 10-15 minutos');
            console.log('üéØ Melhorias ativadas: Pr√©-processamento + Scale adaptativo (3.0-5.0) + Extra√ß√£o de imagens');
            console.log('üÜï v3.7.6.2: Thresholds ULTRA-AGRESSIVOS (gridSize 25px, tableScore>8, minArea 3000px¬≤)');
            
            if (typeof Tesseract === 'undefined') {
                console.error('‚ùå Tesseract.js n√£o est√° carregado! OCR n√£o dispon√≠vel.');
                throw new Error('OCR n√£o dispon√≠vel. PDF escaneado sem texto extra√≠vel.');
            }
            
            usouOCR = true;
            textoCompleto = '';
            textosPorPagina = {};
            const imagensPorPagina = {}; // üÜï Guardar imagens extra√≠das
            
            // Criar worker do Tesseract (reutiliz√°vel) com configura√ß√£o otimizada
            console.log('üîß Configurando Tesseract.js com detec√ß√£o de layout...');
            const worker = await Tesseract.createWorker('por', 1, {
                logger: (m) => {
                    if (m.status === 'recognizing text' && progressCallback) {
                        const progress = Math.round(m.progress * 100);
                        progressCallback(`OCR Premium: ${progress}%`);
                    }
                }
            });
            
            // üÜï Configurar par√¢metros do Tesseract para melhor qualidade
            await worker.setParameters({
                tessedit_pageseg_mode: Tesseract.PSM.AUTO_OSD, // Detectar orienta√ß√£o e layout
                preserve_interword_spaces: '1'
            });
            
            // üÜï v3.7.6.0: Passar primeiro r√°pido para detectar p√°ginas com tabelas
            console.log('üîç Passo 1/2: Detectando p√°ginas com tabelas...');
            const paginasComTabelas = new Set();
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const canvas = await pdfPageToImage(page, 3.5); // üÜï v3.7.6.2: Scale AUMENTADO para melhor detec√ß√£o (2.0‚Üí3.5)
                const imageRegions = detectImageRegions(canvas);
                
                if (imageRegions.length > 0) {
                    paginasComTabelas.add(pageNum);
                    console.log(`  üìä P√°gina ${pageNum}: ${imageRegions.length} tabela(s)/diagrama(s)`);
                }
            }
            
            console.log(`‚úÖ ${paginasComTabelas.size} p√°ginas com tabelas detectadas`);
            console.log('');
            console.log('üîç Passo 2/2: OCR com qualidade adaptativa...');
            
            // Processar cada p√°gina com OCR PREMIUM
            const manualId = crypto.randomUUID(); // ID tempor√°rio para imagens
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                if (progressCallback) {
                    progressCallback(`OCR Premium: P√°gina ${pageNum}/${pdf.numPages}`);
                }
                
                const temTabelas = paginasComTabelas.has(pageNum);
                const scale = temTabelas ? 5.0 : 3.0; // üÜï Scale maior para p√°ginas com tabelas
                
                console.log(`üî¨ OCR Premium - P√°gina ${pageNum}/${pdf.numPages}... ${temTabelas ? 'üìä (COM TABELAS - Scale 5.0)' : '(Scale 3.0)'}`);
                
                const page = await pdf.getPage(pageNum);
                
                // üÜï Usar scale adaptativo + pr√©-processamento otimizado
                const canvas = await pdfPageToImage(page, scale);
                
                // üÜï Para p√°ginas com tabelas, aplicar binariza√ß√£o
                if (temTabelas) {
                    preprocessImageForOCR(canvas, {
                        contrast: true,
                        sharpen: true,
                        denoise: true,
                        binarize: true, // üÜï Binariza√ß√£o para tabelas
                        contrastFactor: 2.0 // üÜï Contraste maior
                    });
                    console.log('  üé® Pr√©-processamento agressivo aplicado');
                }
                
                // üÜï Detectar e extrair imagens/tabelas
                const imageRegions = detectImageRegions(canvas);
                const imagensExtraidas = [];
                
                if (imageRegions.length > 0) {
                    console.log(`  üìä Extraindo ${imageRegions.length} imagem(ns)...`);
                    
                    for (let idx = 0; idx < imageRegions.length; idx++) {
                        const region = imageRegions[idx];
                        
                        // Extrair regi√£o como imagem
                        const regionCanvas = extractImageRegion(canvas, region);
                        const regionBlob = await canvasToBlob(regionCanvas);
                        
                        // Upload para Supabase Storage
                        try {
                            const imageUrl = await uploadExtractedImage(regionBlob, manualId, pageNum, region.type, idx);
                            imagensExtraidas.push({
                                url: imageUrl,
                                type: region.type,
                                score: region.score
                            });
                            console.log(`    ‚úÖ ${region.type} ${idx + 1} uploaded`);
                        } catch (uploadError) {
                            console.error(`    ‚ùå Erro ao fazer upload da ${region.type} ${idx + 1}:`, uploadError);
                        }
                    }
                    
                    imagensPorPagina[pageNum] = imagensExtraidas;
                }
                
                // Extrair texto com OCR (alta qualidade)
                const { data: { text, confidence } } = await worker.recognize(canvas);
                const textoPage = text.trim();
                
                textosPorPagina[pageNum] = textoPage;
                textoCompleto += textoPage + '\n\n';
                
                const confIcon = confidence > 90 ? '‚úÖ' : confidence > 75 ? '‚ö†Ô∏è' : '‚ùå';
                console.log(`  ${confIcon} P√°gina ${pageNum}: ${textoPage.length} chars (confian√ßa: ${Math.round(confidence)}%)`);
            }
            
            // Terminar worker
            await worker.terminate();
            console.log('‚úÖ OCR Premium conclu√≠do!');
            console.log(`üìä Estat√≠sticas finais:`);
            console.log(`   - Texto extra√≠do: ${textoCompleto.length} caracteres`);
            console.log(`   - P√°ginas com imagens/tabelas: ${Object.keys(imagensPorPagina).length}`);
            
            // üÜï v3.7.6.0: Adicionar refer√™ncias a imagens no texto (para contexto do chatbot)
            for (const [pageNum, images] of Object.entries(imagensPorPagina)) {
                if (images && images.length > 0) {
                    const pageText = textosPorPagina[pageNum] || '';
                    let imageRefs = '\n\n';
                    
                    images.forEach((img, idx) => {
                        const emoji = img.type === 'table' ? 'üìä' : 'üñºÔ∏è';
                        imageRefs += `${emoji} [${img.type.toUpperCase()} ${idx + 1}]: ${img.url}\n`;
                    });
                    
                    textosPorPagina[pageNum] = pageText + imageRefs;
                }
            }
            
        } else {
            console.log('‚úÖ Texto nativo extra√≠do com sucesso (PDF n√£o escaneado)');
        }
        
        // PASSO 3: Criar sec√ß√µes (cada 3 p√°ginas)
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            if (pageNum % 3 === 0 || pageNum === pdf.numPages) {
                const inicio = Math.max(1, pageNum - 2);
                const fim = pageNum;
                const tituloSecao = `P√°ginas ${inicio}-${fim}`;
                
                // Juntar texto das p√°ginas desta sec√ß√£o
                let textoSecao = '';
                for (let p = inicio; p <= fim; p++) {
                    if (textosPorPagina[p]) {
                        textoSecao += textosPorPagina[p] + '\n\n';
                    }
                }
                
                if (textoSecao.trim()) {
                    secoes.push({
                        pagina_inicio: inicio,
                        pagina_fim: fim,
                        secao: tituloSecao,
                        conteudo: textoSecao.trim(),
                        ordem: secoes.length + 1
                    });
                }
            }
        }
        
        console.log(`‚úÖ Texto extra√≠do: ${textoCompleto.length} caracteres, ${secoes.length} sec√ß√µes`);
        console.log(`üìä M√©todo usado: ${usouOCR ? 'OCR (Tesseract.js)' : 'Texto nativo (PDF.js)'}`);
        
        return {
            textoCompleto,
            numPaginas: pdf.numPages,
            secoes,
            usouOCR  // Informar se usou OCR
        };
        
    } catch (error) {
        console.error('‚ùå Erro ao extrair texto do PDF:', error);
        throw error;
    }
}

/**
 * Processar e fazer upload de manual completo
 */
async function processarManual(equipamento, titulo, descricao, file) {
    try {
        // 1. Extrair texto do PDF (com callback de progresso)
        setProgress('A extrair texto do PDF...', 10);
        const { textoCompleto, numPaginas, secoes, usouOCR } = await extractTextFromPDF(file, (msg) => {
            setProgress(msg, 10 + Math.random() * 20); // 10-30%
        });
        
        if (usouOCR) {
            console.log('üî¨ Texto extra√≠do via OCR (Tesseract.js)');
        }
        
        // 2. Upload do PDF para Storage PRIMEIRO (para ter URL)
        setProgress('A fazer upload do PDF...', 30);
        // Criar ID tempor√°rio para o ficheiro
        const tempId = crypto.randomUUID();
        const pdfUrl = await window.SupabaseAPI.uploadManualPDF(tempId, file);
        console.log('‚úÖ PDF enviado:', pdfUrl);
        
        // 3. Criar registo do manual no Supabase (agora com URL)
        setProgress('A criar registo do manual...', 50);
        
        // Extrair √°rea e nome do equipamento
        // Ex: "Alinhadeira L03" ‚Üí area: "L03", nome: "Alinhadeira"
        // Ex: "Destro√ßador" ‚Üí area: "Triagem", nome: "Destro√ßador"
        let equipamentoArea = 'Geral';
        let equipamentoNome = equipamento;
        
        console.log('üîç [DEBUG] equipamento original:', equipamento);
        
        // Tentar detectar √°rea (L01, L02, L03, etc)
        const matchArea = equipamento.match(/L0[123]|Triagem|Silo/i);
        if (matchArea) {
            equipamentoArea = matchArea[0];
            equipamentoNome = equipamento.replace(matchArea[0], '').trim();
        }
        
        console.log('üîç [DEBUG] equipamentoArea:', equipamentoArea);
        console.log('üîç [DEBUG] equipamentoNome:', equipamentoNome);
        
        const manualData = {
            equipamento_area: equipamentoArea,
            equipamento_nome: equipamentoNome || equipamento,
            titulo: titulo,
            descricao: descricao || '',
            empresa: 'MCF', // Default MCF (pode ser alterado depois)
            ficheiro_url: pdfUrl,
            ficheiro_nome: file.name,
            tamanho_kb: Math.round(file.size / 1024),
            num_paginas: numPaginas,
            processado: false,
            ativo: true
        };
        
        console.log('üîç [DEBUG] manualData a enviar:', JSON.stringify(manualData, null, 2));
        
        const [manual] = await window.SupabaseAPI.addManual(manualData);
        console.log('‚úÖ Manual criado:', manual);
        
        // 5. Inserir sec√ß√µes de conte√∫do
        setProgress('A processar conte√∫do...', 70);
        for (const secao of secoes) {
            await window.SupabaseAPI.addConteudoManual({
                manual_id: manual.id,
                ...secao
            });
        }
        
        // 6. Marcar como processado
        setProgress('A finalizar...', 90);
        await window.SupabaseAPI.updateManual(manual.id, {
            processado: true
        });
        
        setProgress('‚úÖ Conclu√≠do!', 100);
        
        return manual;
        
    } catch (error) {
        console.error('‚ùå Erro ao processar manual:', error);
        throw error;
    }
}

/**
 * Atualizar barra de progresso
 */
function setProgress(label, percent) {
    const progressDiv = document.getElementById('uploadProgress');
    const progressLabel = document.getElementById('uploadProgressLabel');
    const progressPercent = document.getElementById('uploadProgressPercent');
    const progressBar = document.getElementById('uploadProgressBar');
    
    if (progressDiv) progressDiv.style.display = 'block';
    if (progressLabel) progressLabel.textContent = label;
    if (progressPercent) progressPercent.textContent = percent + '%';
    if (progressBar) progressBar.style.width = percent + '%';
}

/**
 * Carregar manuais em background (para uso no chatbot)
 */
async function carregarManuaisBackground() {
    try {
        console.log('üìö A carregar manuais em background...');
        const manuais = await window.SupabaseAPI.getManuais();
        AppState.manuais = manuais;
        console.log(`üìö ${manuais.length} manuais carregados em background`);
        
        // Carregar conte√∫do dos primeiros 5 manuais para cache
        if (manuais.length > 0) {
            AppState.manuaisConteudo = {};
            for (let i = 0; i < Math.min(5, manuais.length); i++) {
                const m = manuais[i];
                const conteudo = await window.SupabaseAPI.getConteudoManual(m.id);
                AppState.manuaisConteudo[m.id] = conteudo;
            }
            console.log(`üìö Conte√∫do de ${Object.keys(AppState.manuaisConteudo).length} manuais carregado`);
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar manuais em background:', error);
        AppState.manuais = [];
        AppState.manuaisConteudo = {};
    }
}

/**
 * Carregar lista de manuais
 */
async function carregarManuais() {
    try {
        const lista = document.getElementById('manuaisLista');
        const emptyState = document.getElementById('manuaisEmptyState');
        
        lista.innerHTML = '<div class="loading-spinner">A carregar manuais...</div>';
        
        const manuais = await window.SupabaseAPI.getManuais();
        
        // ‚úÖ Guardar no AppState para uso no chatbot
        AppState.manuais = manuais;
        
        if (manuais.length === 0) {
            lista.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }
        
        emptyState.style.display = 'none';
        
        lista.innerHTML = manuais.map(m => `
            <div class="manual-card">
                <div class="manual-card-header">
                    <div>
                        <div class="manual-card-equipment">üìò ${m.equipamento_nome || 'Sem equipamento'}</div>
                        <h3 class="manual-card-title">${m.titulo || 'Sem t√≠tulo'}</h3>
                    </div>
                    <span class="manual-status-badge ${m.processado ? 'manual-status-processado' : 'manual-status-pendente'}">
                        ${m.processado ? '‚úÖ Processado' : '‚è≥ A processar'}
                    </span>
                </div>
                
                ${m.descricao ? `<p class="manual-card-description">${m.descricao}</p>` : ''}
                
                <div class="manual-card-meta">
                    <span>üìÑ ${m.num_paginas || 0} p√°ginas</span>
                    <span>üì¶ ${m.tamanho_kb ? Math.round(m.tamanho_kb / 1024) + ' MB' : 'N/D'}</span>
                    <span>üìÖ ${m.data_upload ? new Date(m.data_upload).toLocaleDateString('pt-PT') : 'N/D'}</span>
                </div>
                
                <div class="manual-card-actions">
                    <button class="btn btn-secondary btn-sm" onclick="window.open('${m.ficheiro_url}', '_blank')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; margin-right: 4px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        Ver PDF
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="verConteudoManual('${m.id}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; margin-right: 4px;">
                            <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                        </svg>
                        Ver Conte√∫do
                    </button>
                </div>
            </div>
        `).join('');
        
        console.log(`‚úÖ ${manuais.length} manuais carregados`);
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar manuais:', error);
        const lista = document.getElementById('manuaisLista');
        lista.innerHTML = '<div class="empty-state-small">‚ùå Erro ao carregar manuais</div>';
    }
}

/**
 * Ver conte√∫do de um manual (sec√ß√µes extra√≠das)
 */
async function verConteudoManual(manualId) {
    try {
        const conteudo = await window.SupabaseAPI.getConteudoManual(manualId);
        
        let html = `
            <div style="padding: var(--spacing-lg); max-width: 800px;">
                <h3 style="margin-bottom: var(--spacing-md);">üìñ Conte√∫do do Manual</h3>
        `;
        
        conteudo.forEach((secao, i) => {
            html += `
                <div style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: var(--color-background); border-radius: 8px;">
                    <h4 style="color: var(--color-blue); margin-bottom: var(--spacing-sm);">
                        ${secao.secao || `Sec√ß√£o ${i + 1}`}
                    </h4>
                    <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">
                        P√°ginas ${secao.pagina_inicio} - ${secao.pagina_fim}
                    </p>
                    <p style="line-height: 1.6; color: var(--color-text-primary); max-height: 200px; overflow-y: auto;">
                        ${secao.conteudo.substring(0, 500)}${secao.conteudo.length > 500 ? '...' : ''}
                    </p>
                </div>
            `;
        });
        
        html += '</div>';
        
        showToast(html, 'info', 0);  // Duration 0 = manual close
        
    } catch (error) {
        console.error('‚ùå Erro ao ver conte√∫do:', error);
        showToast('‚ùå Erro ao carregar conte√∫do do manual', 'error');
    }
}

// EVENT LISTENERS
function setupEventListeners() {
    // Login e Logout
    document.getElementById('loginForm')?.addEventListener('submit', handleLogin);
    document.getElementById('logoutBtn')?.addEventListener('click', logout);
    
    // Tab navega√ß√£o e formul√°rios principais
    document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', handleTabChange));
    document.getElementById('maintenanceForm')?.addEventListener('submit', handleFormSubmit);
    document.getElementById('clearBtn')?.addEventListener('click', clearForm);
    document.getElementById('foto')?.addEventListener('change', handlePhotoUpload);
    
    // ‚ö° NOVO: Mostrar/ocultar campo Frequ√™ncia baseado no tipo de manuten√ß√£o
    const tipoSelect = document.getElementById('tipo');
    const frequenciaGroup = document.getElementById('frequenciaGroup');
    const frequenciaSelect = document.getElementById('frequencia');
    const dataPrimeiraIntervencaoGroup = document.getElementById('dataPrimeiraIntervencaoGroup');
    const dataPrimeiraIntervencaoInput = document.getElementById('dataPrimeiraIntervencao');
    const prioridadeGroup = document.getElementById('prioridadeGroup');
    const prioridadeInputs = document.querySelectorAll('input[name="prioridade"]');
    
    if (tipoSelect && frequenciaGroup && frequenciaSelect) {
        tipoSelect.addEventListener('change', () => {
            if (tipoSelect.value === 'Preventiva') {
                // Mostrar campos de preventiva
                frequenciaGroup.style.display = 'block';
                frequenciaSelect.required = true;
                // ‚úÖ v3.7.0.8: Mostrar Data 1¬™ Interven√ß√£o
                if (dataPrimeiraIntervencaoGroup && dataPrimeiraIntervencaoInput) {
                    dataPrimeiraIntervencaoGroup.style.display = 'block';
                    dataPrimeiraIntervencaoInput.required = true;
                }
                // üÜï Ocultar prioridade em Preventivas
                if (prioridadeGroup) {
                    prioridadeGroup.style.display = 'none';
                    prioridadeInputs.forEach(input => {
                        input.required = false;
                        input.checked = false;
                    });
                }
            } else {
                // Ocultar campos de preventiva
                frequenciaGroup.style.display = 'none';
                frequenciaSelect.required = false;
                frequenciaSelect.value = '';
                // ‚úÖ v3.7.0.8: Ocultar Data 1¬™ Interven√ß√£o
                if (dataPrimeiraIntervencaoGroup && dataPrimeiraIntervencaoInput) {
                    dataPrimeiraIntervencaoGroup.style.display = 'none';
                    dataPrimeiraIntervencaoInput.required = false;
                    dataPrimeiraIntervencaoInput.value = '';
                }
                // üÜï Mostrar prioridade em Corretivas/Melhorias
                if (prioridadeGroup) {
                    prioridadeGroup.style.display = 'block';
                    prioridadeInputs.forEach(input => {
                        input.required = true;
                    });
                }
            }
        });
    }
    
    document.querySelectorAll('.filter-tipo, .filter-prioridade, .filter-estado, .filter-empresa, .filter-tipoIntervencao, .filter-urgente, .filter-paragemProducao').forEach(checkbox => checkbox.addEventListener('change', handleFilterChange));
    
    // ‚ö° NOVO: Event listener para filtro de equipamento (SELECT, n√£o checkbox!)
    const filterEquipamento = document.getElementById('filterEquipamento');
    if (filterEquipamento) {
        filterEquipamento.addEventListener('change', () => {
            console.log('üîß Filtro de Equipamento mudou:', filterEquipamento.value);
            renderRequestsList(); // ‚úÖ For√ßar re-render quando muda
        });
        populateEquipamentoFilter(); // Popular dropdown ao carregar
    }
    
    // ‚úÖ v3.7.0.9: Event listener para filtro de respons√°vel
    const filterResponsavel = document.getElementById('filterResponsavel');
    if (filterResponsavel) {
        filterResponsavel.addEventListener('change', () => {
            console.log('üë§ Filtro de Respons√°vel mudou:', filterResponsavel.value);
            renderRequestsList();
        });
        // Nota: populateResponsavelFilter() √© chamado em initializePlanning()
    }
    
    document.getElementById('clearFilters')?.addEventListener('click', clearFilters);
    document.getElementById('sortBtn')?.addEventListener('click', toggleSortOrder);
    document.getElementById('closeModal')?.addEventListener('click', closeModal);
    document.querySelector('.modal-overlay')?.addEventListener('click', closeModal);
    
    // ‚ùå REMOVIDO v3.7.2.10: Eventos da tab Planeamento (removida)
    // document.getElementById('prevWeekBtn')?.addEventListener('click', () => movePlanningWeek(-1));
    // document.getElementById('nextWeekBtn')?.addEventListener('click', () => movePlanningWeek(1));
    // document.getElementById('todayBtn')?.addEventListener('click', resetPlanningToToday);
    // document.getElementById('savePlanningBtn')?.addEventListener('click', savePlanning);
    // document.getElementById('exportPlanningBtn')?.addEventListener('click', exportPlanningToExcel);
    
    // ‚ö° NOVO: Event listener para resumo de preventivas
    const atualizarPreventivasBtn = document.getElementById('atualizarPreventivasBtn');
    if (atualizarPreventivasBtn) {
        atualizarPreventivasBtn.addEventListener('click', renderPreventivasList);
    }
    
    // ‚úÖ v3.7.0.9: Event listeners para filtros do planeamento
    document.querySelectorAll('.planning-filter-tipo, .planning-filter-prioridade, .planning-filter-estado, .planning-filter-empresa, .planning-filter-tipoIntervencao, .planning-filter-urgente, .planning-filter-paragemProducao').forEach(cb => {
        cb.addEventListener('change', renderPlanningGrid);
    });
    
    const planningFilterEquipamento = document.getElementById('planningFilterEquipamento');
    if (planningFilterEquipamento) {
        planningFilterEquipamento.addEventListener('change', renderPlanningGrid);
    }
    
    const planningFilterResponsavel = document.getElementById('planningFilterResponsavel');
    if (planningFilterResponsavel) {
        planningFilterResponsavel.addEventListener('change', renderPlanningGrid);
    }
    
    const clearPlanningFilters = document.getElementById('clearPlanningFilters');
    if (clearPlanningFilters) {
        clearPlanningFilters.addEventListener('click', clearPlanningFiltersFunc);
    }
    
    // üìö Event listener para formul√°rio de upload de manuais
    const uploadManualForm = document.getElementById('uploadManualForm');
    if (uploadManualForm) {
        uploadManualForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const equipamento = document.getElementById('manualEquipamento').value;
                const titulo = document.getElementById('manualTitulo').value;
                const descricao = document.getElementById('manualDescricao').value;
                const fileInput = document.getElementById('manualPDF');
                const file = fileInput.files[0];
                
                if (!file) {
                    showToast('‚ùå Por favor selecione um ficheiro PDF', 'error');
                    return;
                }
                
                // Validar tamanho (50MB max)
                if (file.size > 50 * 1024 * 1024) {
                    showToast('‚ùå Ficheiro muito grande! M√°ximo: 50MB', 'error');
                    return;
                }
                
                // Validar tipo
                if (file.type !== 'application/pdf') {
                    showToast('‚ùå Apenas ficheiros PDF s√£o permitidos', 'error');
                    return;
                }
                
                console.log('üìö A processar manual:', { equipamento, titulo, file: file.name });
                
                // Processar manual
                await processarManual(equipamento, titulo, descricao, file);
                
                showToast('‚úÖ Manual processado com sucesso!', 'success');
                
                // Limpar formul√°rio
                uploadManualForm.reset();
                document.getElementById('uploadProgress').style.display = 'none';
                
                // Recarregar lista
                await carregarManuais();
                
            } catch (error) {
                console.error('‚ùå Erro ao processar manual:', error);
                showToast('‚ùå Erro ao processar manual: ' + error.message, 'error');
                document.getElementById('uploadProgress').style.display = 'none';
            }
        });
    }
    
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
    
    // ‚ö° Event listeners para Equipamentos/Componentes
    const areaSelect = document.getElementById('areaEquipamento');
    const componenteSelect = document.getElementById('componente');
    const empresaSelect = document.getElementById('empresa');
    
    if (areaSelect) {
        areaSelect.addEventListener('change', handleAreaEquipamentoChange);
        // ‚ö†Ô∏è N√ÉO popular aqui! Ser√° populado DEPOIS de carregar do Supabase em syncWithSupabase()
    }
    
    // ‚úÖ Event listener para EMPRESA ‚Üí Filtrar equipamentos
    if (empresaSelect) {
        empresaSelect.addEventListener('change', (e) => {
            const empresaSelecionada = e.target.value;
            console.log('üè¢ Empresa selecionada:', empresaSelecionada);
            
            if (empresaSelecionada) {
                // Popular e habilitar dropdown de √°reas/equipamentos
                populateAreaEquipamento(empresaSelecionada);
                if (areaSelect) {
                    areaSelect.disabled = false;
                }
            } else {
                // Se n√£o houver empresa, limpar e desabilitar equipamentos
                if (areaSelect) {
                    areaSelect.innerHTML = '<option value="">Escolha primeiro a empresa</option>';
                    areaSelect.disabled = true;
                }
                if (componenteSelect) {
                    componenteSelect.innerHTML = '<option value="">Escolha primeiro a √°rea/equipamento</option>';
                    componenteSelect.disabled = true;
                }
            }
        });
    }
}

// ‚ö° EQUIPAMENTOS - Popular dropdown de √Åreas/Equipamentos (filtrado por empresa)
function populateAreaEquipamento(empresaFiltro = null) {
    const areaSelect = document.getElementById('areaEquipamento');
    if (!areaSelect) {
        console.error('‚ùå Elemento areaEquipamento n√£o encontrado!');
        return;
    }
    
    console.log('üîÑ populateAreaEquipamento chamado - Empresa filtro:', empresaFiltro);
    console.log('üìä AppState.equipamentos:', AppState.equipamentos.length, 'registos');
    
    // Limpar op√ß√µes existentes (exceto a primeira)
    areaSelect.innerHTML = '<option value="">Selecione a √°rea/equipamento</option>';
    
    if (AppState.equipamentos.length === 0) {
        console.error('‚ö†Ô∏è AppState.equipamentos est√° vazio! N√£o h√° √°reas para popular.');
        return;
    }
    
    // üîç Log primeiro equipamento para ver estrutura
    if (AppState.equipamentos.length > 0) {
        console.log('üìã Exemplo de equipamento:', AppState.equipamentos[0]);
    }
    
    // ‚úÖ Filtrar por empresa (se especificada)
    let equipamentosFiltrados = AppState.equipamentos;
    if (empresaFiltro) {
        equipamentosFiltrados = AppState.equipamentos.filter(e => e.empresa === empresaFiltro);
        console.log(`üè¢ Equipamentos filtrados para ${empresaFiltro}:`, equipamentosFiltrados.length);
    }
    
    // ‚úÖ Obter √°reas √∫nicas
    const areasUnicas = [...new Set(equipamentosFiltrados.map(e => e.area))].sort();
    console.log('üìã √Åreas √∫nicas extra√≠das:', areasUnicas);
    
    areasUnicas.forEach(area => {
        const option = document.createElement('option');
        option.value = area;
        option.textContent = area;
        areaSelect.appendChild(option);
    });
    
    console.log('‚úÖ √Åreas/Equipamentos populadas:', areasUnicas.length);
    
    // Limpar componente tamb√©m
    const componenteSelect = document.getElementById('componente');
    if (componenteSelect) {
        componenteSelect.innerHTML = '<option value="">Escolha primeiro a √°rea/equipamento</option>';
        componenteSelect.disabled = true;
    }
}

// ‚ö° EQUIPAMENTOS - Filtrar componentes ao escolher √°rea
function handleAreaEquipamentoChange(e) {
    const areaSelected = e.target.value;
    const componenteSelect = document.getElementById('componente');
    const empresaSelect = document.getElementById('empresa');
    
    if (!componenteSelect) return;
    
    // Limpar e desabilitar se n√£o houver √°rea selecionada
    if (!areaSelected) {
        componenteSelect.innerHTML = '<option value="">Escolha primeiro a √°rea/equipamento</option>';
        componenteSelect.disabled = true;
        return;
    }
    
    // Obter empresa selecionada
    const empresaSelecionada = empresaSelect?.value || null;
    
    // ‚úÖ Filtrar por √°rea E empresa
    let componentes = AppState.equipamentos.filter(e => e.area === areaSelected);
    
    // Se houver empresa selecionada, filtrar tamb√©m por ela
    if (empresaSelecionada) {
        componentes = componentes.filter(e => e.empresa === empresaSelecionada);
    }
    
    componentes.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));
    
    // Limpar e popular dropdown de componentes
    componenteSelect.innerHTML = '<option value="">Selecione o componente</option>';
    
    componentes.forEach(equip => {
        const option = document.createElement('option');
        option.value = equip.componente;
        option.textContent = equip.componente;
        componenteSelect.appendChild(option);
    });
    
    // Habilitar dropdown
    componenteSelect.disabled = false;
    
    console.log(`‚ö° Componentes filtrados para "${areaSelected}" (Empresa: ${empresaSelecionada}):`, componentes.length);
}

function handleTabChange(e) {
    const tab = e.currentTarget.dataset.tab;
    
    // ‚ùå REMOVIDO v3.7.2.2: Verifica√ß√£o de permiss√£o para tab "Manuais" (removida)
    
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    e.currentTarget.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    
    // ‚úÖ CORRE√á√ÉO 1: Guardar aba ativa no localStorage
    try {
        localStorage.setItem('activeTab', tab);
        console.log('üíæ Aba ativa guardada:', tab);
    } catch (e) {
        console.warn('Erro ao guardar aba:', e);
    }
    
    if (tab === 'planeamento') renderPlanningGrid();
    
    // ‚úÖ NOVO: Renderizar alertas de stock m√≠nimo ao abrir tab Stock
    if (tab === 'stock') {
        renderStockMinimo();
        // renderMovimentos() - removido, agora usa pesquisa
    }
    
    // ‚úÖ v3.7.2.10: Renderizar documentos ao abrir tab Documentos
    if (tab === 'analise') {
        renderizarDocumentos();
    }
    
    // ‚ùå REMOVIDO v3.7.2.2: Carregar manuais (tab removida)
    
    // Re-aplicar auto-preenchimento quando mudar de tab
    if (tab === 'novo') {
        setTimeout(() => applyUserAutoFill(), 100);
    }
}

// ‚úÖ CORRE√á√ÉO 1: Restaurar aba ativa ao carregar (SEM FLASH)
function restoreActiveTab() {
    try {
        let activeTab = localStorage.getItem('activeTab');
        
        // ‚ùå REMOVIDO v3.7.2.2: Verifica√ß√£o de tabs removidas (manuais, autonomas)
        const removedTabs = ['manuais', 'autonomas'];
        if (removedTabs.includes(activeTab)) {
            console.warn('‚ö†Ô∏è Tab removida detectada:', activeTab, '- redirecionando para "novo"');
            activeTab = 'novo';
        }
        
        if (activeTab && activeTab !== 'novo') {
            console.log('üîÑ Restaurando aba:', activeTab);
            
            // ‚úÖ Ativar diretamente SEM click (evita anima√ß√£o/flash)
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const tabBtn = document.querySelector(`.tab-btn[data-tab="${activeTab}"]`);
            const tabContent = document.getElementById(`tab-${activeTab}`);
            
            if (tabBtn && tabContent) {
                tabBtn.classList.add('active');
                tabContent.classList.add('active');
                
                // ‚úÖ Renderizar conte√∫do se necess√°rio
                if (activeTab === 'stock') {
                    renderStockMinimo();
                    // renderMovimentos() - removido, agora usa pesquisa
                }
                
                // ‚úÖ v3.7.0: Atualizar an√°lises ao restaurar tab An√°lise
                if (activeTab === 'analise') {
                    setTimeout(() => {
                        if (typeof window.atualizarAnalises === 'function') {
                            console.log('üìä Chamando atualizarAnalises() - Pedidos:', AppState.requests?.length || 0);
                            window.atualizarAnalises();
                        } else {
                            console.error('‚ùå window.atualizarAnalises n√£o √© uma fun√ß√£o!');
                        }
                    }, 500); // Aumentado de 200ms para 500ms
                }
                
                // ‚ùå REMOVIDO v3.7.2.2: Carregar manuais (tab removida)
                
                console.log('‚úÖ Aba restaurada:', activeTab);
            }
        }
        
        // ‚úÖ CORRE√á√ÉO v3.6.22: Remover classe app-loading (mostrar conte√∫do)
        document.body.classList.remove('app-loading');
        
    } catch (e) {
        console.warn('Erro ao restaurar aba:', e);
        // ‚úÖ Remover classe mesmo em caso de erro
        document.body.classList.remove('app-loading');
    }
}

// FORMUL√ÅRIO
async function handleFormSubmit(e) {
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    try {
        // ‚úÖ v3.7.0.9: Gerar ID sequencial OT_XXXXX
        const pedidoId = await generateOTID();
        
        // ‚úÖ v3.7.2.18: Usar foto em Base64 (j√° comprimida)
        const fotoUrl = currentTarefaPhoto || null;
        
        const tipoValue = document.getElementById('tipo').value;
        const prioridadeValue = document.querySelector('input[name="prioridade"]:checked')?.value;
        
        // ‚úÖ Prioridade √© sempre obrigat√≥ria
        if (!prioridadeValue) {
            showToast('‚ùå Por favor, seleciona uma prioridade!', 'error');
            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
            return;
        }
        
        const formData = {
            id: pedidoId,
            tipo: tipoValue,
            prioridade: prioridadeValue || 'M√©dia',
            zona: document.getElementById('zona').value,  // ‚úÖ Campo "Zona"
            responsavel: document.getElementById('nome').value,  // ‚úÖ "Respons√°vel"
            descricao: document.getElementById('descricao').value,
            foto: fotoUrl,
            dataHora: new Date().toISOString(),
            estado: 'Novo'
        };
        
        localStorage.setItem(CONFIG.STORAGE_KEYS.USER_NAME, formData.responsavel);
        AppState.requests.unshift(formData);
        saveToLocalStorage();
        
        if (AppState.isOnline) {
            await sendToGoogleSheets(formData);  // üî• Nome legacy, usa Supabase internamente
        } else {
            addToOfflineQueue(formData);
            showToast('Pedido salvo offline. Ser√° sincronizado quando estiver online.', 'info');
        }
        
        clearForm();
        showToast('Pedido criado com sucesso!', 'success');
        document.querySelector('.tab-btn[data-tab="lista"]').click();
        renderRequestsList();
        
    } catch (error) {
        console.error('Erro ao criar pedido:', error);
        showToast('Erro ao criar pedido. Tente novamente.', 'error');
    } finally {
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
    }
}

function clearForm() {
    document.getElementById('maintenanceForm').reset();
    
    // ‚úÖ v3.7.2.18: Limpar preview de foto de tarefa
    clearTarefaPreview();
    
    // ‚ö° Resetar campos de Equipamento/Componente
    const componenteSelect = document.getElementById('componente');
    if (componenteSelect) {
        componenteSelect.innerHTML = '<option value="">Escolha primeiro a √°rea/equipamento</option>';
        componenteSelect.disabled = true;
    }
}

// Manter compatibilidade com c√≥digo antigo
function clearImagePreview() {
    clearTarefaPreview();
}

function loadSavedUserName() {
    const savedName = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_NAME);
    if (savedName) document.getElementById('nome').value = savedName;
}

// üì∏ v3.6.18: Vari√°vel global para guardar o File original
let currentPhotoFile = null;

// UPLOAD DE IMAGENS
async function handlePhotoUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > CONFIG.MAX_IMAGE_SIZE) {
        showToast('A imagem deve ter no m√°ximo 5MB.', 'error');
        e.target.value = '';
        return;
    }
    if (!file.type.startsWith('image/')) {
        showToast('Por favor, selecione uma imagem v√°lida.', 'error');
        e.target.value = '';
        return;
    }
    try {
        // ‚úÖ Guardar File original para upload posterior
        currentPhotoFile = file;
        
        // Criar preview comprimido (s√≥ para visualiza√ß√£o)
        const compressedImage = await compressImage(file);
        showImagePreview(compressedImage);
        document.getElementById('fileName').textContent = file.name;
        
        console.log('üì∏ Foto selecionada:', file.name, (file.size / 1024 / 1024).toFixed(2) + ' MB');
    } catch (error) {
        console.error('Erro ao processar imagem:', error);
        showToast('Erro ao processar imagem.', 'error');
        e.target.value = '';
        currentPhotoFile = null;
    }
}

function compressImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width, height = img.height;
                if (width > CONFIG.MAX_IMAGE_WIDTH || height > CONFIG.MAX_IMAGE_HEIGHT) {
                    if (width > height) {
                        height = (height / width) * CONFIG.MAX_IMAGE_WIDTH;
                        width = CONFIG.MAX_IMAGE_WIDTH;
                    } else {
                        width = (width / height) * CONFIG.MAX_IMAGE_HEIGHT;
                        height = CONFIG.MAX_IMAGE_HEIGHT;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                const compressedDataUrl = canvas.toDataURL('image/jpeg', CONFIG.IMAGE_QUALITY);
                resolve(compressedDataUrl);
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function showImagePreview(dataUrl) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = `<img src="${dataUrl}" alt="Preview"><button type="button" class="remove-image" onclick="clearImagePreview()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>`;
    preview.classList.add('active');
}

function clearImagePreview() {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    preview.classList.remove('active');
    document.getElementById('foto').value = '';
    document.getElementById('fileName').textContent = 'Escolher imagem';
    currentPhotoFile = null;  // ‚úÖ Limpar File guardado
}

// üì∏ v3.6.18: Retornar File original em vez de base64
async function getImageData() {
    return currentPhotoFile;  // Retorna File ou null
}

// LISTAGEM
function renderRequestsList() {
    applyFilters();
    applySorting();
    const container = document.getElementById('requestsList');
    const emptyState = document.getElementById('emptyState');
    const listCount = document.getElementById('listCount');
    const count = AppState.filteredRequests.length;
    listCount.textContent = `${count} ${count === 1 ? 'pedido' : 'pedidos'}`;
    if (AppState.filteredRequests.length === 0) {
        container.innerHTML = '';
        emptyState.classList.add('active');
        return;
    }
    emptyState.classList.remove('active');
    container.innerHTML = AppState.filteredRequests.map(request => {
        // ‚úÖ VERIFICA√á√ïES DE SEGURAN√áA para evitar erros de undefined
        const tipo = request.tipo || 'N/A';
        const frequencia = request.frequencia || '-';
        const prioridade = request.prioridade || 'Media';
        const estado = request.estado || 'Novo';
        // Remover acentos para classe CSS
        const prioridadeClass = prioridade.toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, ''); // Remove acentos
        const estadoClass = estado.toLowerCase().replace(' ', '');
        const descricao = request.descricao || '';
        const nome = request.nome || 'Desconhecido';
        const departamento = request.departamento || '-';
        const areaEquipamento = request.areaEquipamento || '';
        const componente = request.componente || '';
        
        return `<div class="request-card" onclick="openRequestDetails('${request.id}')">
            <div class="request-header">
                <div class="request-badges">
                    <span class="badge" style="background: #2c3e50; color: white; font-size: 11px; font-weight: 600; letter-spacing: 0.5px;">üÜî ${request.id}</span>
                    <span class="badge badge-tipo">${tipo}</span>
                    ${tipo === 'Preventiva' && frequencia !== '-' ? `<span class="badge" style="background: #4CAF50; color: white; font-size: 11px;">‚è±Ô∏è ${frequencia}</span>` : ''}
                    ${tipo !== 'Preventiva' ? `<span class="badge badge-prioridade ${prioridadeClass}">${prioridade}</span>` : ''}
                    <span class="badge badge-estado ${estadoClass}">${estado}</span>
                    ${areaEquipamento && areaEquipamento !== '-' ? `<span class="badge" style="background: #667eea; color: white; font-size: 11px;">üîß ${areaEquipamento}</span>` : ''}
                    ${componente && componente !== '-' ? `<span class="badge" style="background: #9b59b6; color: white; font-size: 11px;">‚öôÔ∏è ${componente}</span>` : ''}
                </div>
                <span class="request-date">${formatDate(request.dataHora)}</span>
            </div>
            <div class="request-body">
                <h4>${tipo}</h4>
                <p>${descricao}</p>
            </div>
            <div class="request-footer">
                <div class="request-meta">
                    <span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>${nome}</span>
                    ${departamento !== '-' ? `<span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>${departamento}</span>` : ''}
                </div>
                <div class="request-actions" onclick="event.stopPropagation()">
                    ${estado !== 'Resolvido' ? `<button class="btn-icon" onclick="changeRequestState('${request.id}')" title="Mudar estado"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></button>` : ''}
                    <button class="btn-icon" onclick="deleteRequest('${request.id}')" title="Eliminar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function applyFilters() {
    AppState.filteredRequests = AppState.requests.filter(request => {
        // ‚ö° NORMALIZAR valores para evitar problemas com espa√ßos/mai√∫sculas
        const estadoPedido = (request.estado || '').trim();
        const tipoPedido = (request.tipo || '').trim();
        const prioridadePedido = (request.prioridade || '').trim();
        
        // Filtros
        const passaTipo = AppState.currentFilters.tipo.length === 0 || AppState.currentFilters.tipo.includes(tipoPedido);
        const passaPrioridade = AppState.currentFilters.prioridade.length === 0 || AppState.currentFilters.prioridade.includes(prioridadePedido);
        const passaEstado = AppState.currentFilters.estado.length === 0 || AppState.currentFilters.estado.includes(estadoPedido);
        
        const empresaPedido = request.empresa || 'MCF';
        const passaEmpresa = AppState.currentFilters.empresa.length === 0 || AppState.currentFilters.empresa.includes(empresaPedido);
        
        // ‚ö° v3.6.15: Filtro de Equipamento CORRIGIDO
        const filterEquipamento = document.getElementById('filterEquipamento')?.value || '';
        const areaEquipamentoPedido = (request.areaEquipamento || '').trim();
        const passaEquipamento = !filterEquipamento || areaEquipamentoPedido === filterEquipamento;
        
        // ‚úÖ Filtro de Respons√°vel (do PLANEAMENTO)
        const filterResponsavel = document.getElementById('filterResponsavel')?.value || '';
        const task = AppState.planning.tasks[request.id];
        const responsavelPedido = (task?.responsavel || '').trim();
        const passaResponsavel = !filterResponsavel || responsavelPedido === filterResponsavel;
        
        // Novos filtros
        const tipoIntervencaoPedido = request.tipoIntervencao || '-';
        const passaTipoIntervencao = AppState.currentFilters.tipoIntervencao.length === 0 || 
                                     (tipoIntervencaoPedido !== '-' && AppState.currentFilters.tipoIntervencao.includes(tipoIntervencaoPedido));
        
        const passaUrgente = AppState.currentFilters.urgente.length === 0 || 
                            (AppState.currentFilters.urgente.includes('true') && request.urgente === true);
        
        const passaParagem = AppState.currentFilters.paragemProducao.length === 0 || 
                            (AppState.currentFilters.paragemProducao.includes('true') && request.paragemProducao === true);
        
        return passaTipo && passaPrioridade && passaEstado && passaEmpresa && passaEquipamento && passaResponsavel && passaTipoIntervencao && passaUrgente && passaParagem;
    });
    
    console.log(`‚úÖ Filtros aplicados: ${AppState.filteredRequests.length} de ${AppState.requests.length} pedidos`);
}

function applySorting() {
    AppState.filteredRequests.sort((a, b) => {
        const dateA = new Date(a.dataHora), dateB = new Date(b.dataHora);
        return AppState.sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
    });
}

function handleFilterChange(e) {
    const filterType = e.target.classList[0].replace('filter-', '');
    const value = e.target.value;
    if (e.target.checked) {
        AppState.currentFilters[filterType].push(value);
    } else {
        const index = AppState.currentFilters[filterType].indexOf(value);
        if (index > -1) AppState.currentFilters[filterType].splice(index, 1);
    }
    renderRequestsList();
}

// ‚ö° EQUIPAMENTOS - Popular filtro de equipamento
function populateEquipamentoFilter() {
    const select = document.getElementById('filterEquipamento');
    if (!select) return;
    
    // Limpar op√ß√µes existentes (exceto a primeira "Todos")
    select.innerHTML = '<option value="">Todos os equipamentos</option>';
    
    // ‚úÖ v3.7.0.9: Obter √°reas √∫nicas do Supabase com contagem
    const areaMap = {};
    AppState.equipamentos.forEach(e => {
        if (!areaMap[e.area]) areaMap[e.area] = 0;
        areaMap[e.area]++;
    });
    
    const areas = Object.keys(areaMap).sort();
    
    areas.forEach(area => {
        const componentesCount = areaMap[area];
        const option = document.createElement('option');
        option.value = area;
        option.textContent = `${area} (${componentesCount})`;
        select.appendChild(option);
    });
    
    console.log('‚ö° Filtro de Equipamento populado com', areas.length, '√°reas');
}

// ‚úÖ v3.7.0.9: NOVO - Popular filtro de Respons√°vel
function populateResponsavelFilter() {
    const select = document.getElementById('filterResponsavel');
    if (!select) {
        console.warn('‚ùå Elemento #filterResponsavel n√£o encontrado');
        return;
    }
    
    console.log('üîÑ Populando filtro de respons√°vel...');
    console.log('üìä Total de ordens de trabalho:', AppState.requests?.length || 0);
    console.log('üìä Total de tasks no planeamento:', Object.keys(AppState.planning.tasks || {}).length);
    
    // Limpar op√ß√µes existentes (exceto a primeira "Todos")
    select.innerHTML = '<option value="">Todos os respons√°veis</option>';
    
    // Obter lista √∫nica de respons√°veis do PLANEAMENTO (n√£o das ordens de trabalho)
    const responsaveis = new Set();
    AppState.requests.forEach(request => {
        // Buscar respons√°vel do planeamento
        const task = AppState.planning.tasks[request.id];
        const resp = (task?.responsavel || '').trim();
        if (resp && resp !== '') {
            console.log(`‚úÖ Pedido ${request.id.substring(0, 8)}... tem respons√°vel: ${resp}`);
            responsaveis.add(resp);
        }
    });
    
    console.log('üìã Respons√°veis √∫nicos encontrados:', Array.from(responsaveis));
    
    // Converter para array, ordenar e adicionar ao select
    const responsaveisArray = Array.from(responsaveis).sort();
    
    responsaveisArray.forEach(responsavel => {
        // Contar pedidos deste respons√°vel (do planeamento)
        const count = AppState.requests.filter(r => {
            const task = AppState.planning.tasks[r.id];
            return task?.responsavel === responsavel;
        }).length;
        const option = document.createElement('option');
        option.value = responsavel;
        option.textContent = `${responsavel} (${count})`;
        select.appendChild(option);
    });
    
    console.log('‚úÖ Filtro de Respons√°vel populado com', responsaveisArray.length, 'utilizadores');
}

// ‚úÖ v3.7.0.9: Popular filtros do planeamento
function populatePlanningFilters() {
    // Popular dropdown de Equipamento
    const planningFilterEquipamento = document.getElementById('planningFilterEquipamento');
    if (planningFilterEquipamento) {
        const areasUnicas = [...new Set(AppState.equipamentos.map(e => e.area))].sort();
        planningFilterEquipamento.innerHTML = '<option value="">Todos os equipamentos</option>';
        areasUnicas.forEach(area => {
            const option = document.createElement('option');
            option.value = area;
            option.textContent = area;
            planningFilterEquipamento.appendChild(option);
        });
    }
    
    // Popular dropdown de Respons√°vel
    const planningFilterResponsavel = document.getElementById('planningFilterResponsavel');
    if (planningFilterResponsavel) {
        const responsaveis = new Set();
        AppState.requests.forEach(request => {
            const task = AppState.planning.tasks[request.id];
            const resp = (task?.responsavel || '').trim();
            if (resp && resp !== '') {
                responsaveis.add(resp);
            }
        });
        
        const responsaveisArray = Array.from(responsaveis).sort();
        planningFilterResponsavel.innerHTML = '<option value="">Todos os respons√°veis</option>';
        responsaveisArray.forEach(responsavel => {
            const count = AppState.requests.filter(r => {
                const task = AppState.planning.tasks[r.id];
                return task?.responsavel === responsavel;
            }).length;
            const option = document.createElement('option');
            option.value = responsavel;
            option.textContent = `${responsavel} (${count})`;
            planningFilterResponsavel.appendChild(option);
        });
        
        console.log('‚úÖ Filtros de Planeamento populados');
    }
}

// ‚úÖ v3.7.0.9: Limpar filtros do planeamento
function clearPlanningFiltersFunc() {
    // Marcar todas as checkboxes
    document.querySelectorAll('.planning-filter-tipo, .planning-filter-prioridade, .planning-filter-tipoIntervencao, .planning-filter-empresa').forEach(cb => cb.checked = true);
    
    // Estado: marcar apenas Novo e Em curso
    document.querySelectorAll('.planning-filter-estado').forEach(cb => {
        cb.checked = (cb.value === 'Novo' || cb.value === 'Em curso');
    });
    
    // Desmarcar Especiais
    document.querySelectorAll('.planning-filter-urgente, .planning-filter-paragemProducao').forEach(cb => cb.checked = false);
    
    // Limpar dropdowns
    const planningFilterEquipamento = document.getElementById('planningFilterEquipamento');
    if (planningFilterEquipamento) planningFilterEquipamento.value = '';
    
    const planningFilterResponsavel = document.getElementById('planningFilterResponsavel');
    if (planningFilterResponsavel) planningFilterResponsavel.value = '';
    
    // Re-renderizar grid
    renderPlanningGrid();
    showToast('Filtros do planeamento limpos', 'success');
}

function clearFilters() {
    AppState.currentFilters = { tipo: [], prioridade: [], estado: ['Novo', 'Em curso'], empresa: [], tipoIntervencao: [], urgente: [], paragemProducao: [] };
    document.querySelectorAll('.filter-tipo, .filter-prioridade, .filter-estado, .filter-empresa, .filter-tipoIntervencao, .filter-urgente, .filter-paragemProducao').forEach(checkbox => checkbox.checked = false);
    document.querySelectorAll('.filter-estado').forEach(checkbox => {
        if (checkbox.value === 'Novo' || checkbox.value === 'Em curso') checkbox.checked = true;
    });
    
    // ‚ö° NOVO: Limpar filtros de equipamento e respons√°vel
    const filterEquipamento = document.getElementById('filterEquipamento');
    if (filterEquipamento) {
        filterEquipamento.value = '';
    }
    
    const filterResponsavel = document.getElementById('filterResponsavel');
    if (filterResponsavel) {
        filterResponsavel.value = '';
    }
    
    renderRequestsList();
}

function toggleSortOrder() {
    AppState.sortOrder = AppState.sortOrder === 'desc' ? 'asc' : 'desc';
    renderRequestsList();
    showToast(`Ordena√ß√£o: ${AppState.sortOrder === 'desc' ? 'Mais recentes primeiro' : 'Mais antigos primeiro'}`, 'info');
}

// DETALHES
function openRequestDetails(id) {
    const request = AppState.requests.find(r => r.id === id);
    if (!request) return;
    
    const modal = document.getElementById('detailsModal');
    const modalBody = document.getElementById('modalBody');
    
    let html = `
        <div class="detail-group">
            <div class="detail-label">ID da Ordem</div>
            <div class="detail-value">${request.id}</div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Data e Hora</div>
            <div class="detail-value">${formatDateLong(request.dataHora)}</div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Tipo</div>
            <div class="detail-badges"><span class="badge badge-tipo">${request.tipo}</span></div>
        </div>`;
    
    // üÜï Prioridade s√≥ aparece se N√ÉO for Preventiva
    if (request.tipo !== 'Preventiva') {
        html += `
        <div class="detail-group">
            <div class="detail-label">Prioridade</div>
            <div class="detail-priority-selector">
                <label class="priority-option-inline ${request.prioridade === 'Alta' ? 'active' : ''}" onclick="changePriority('${request.id}', 'Alta')">
                    <input type="radio" name="priority-${request.id}" value="Alta" ${request.prioridade === 'Alta' ? 'checked' : ''}>
                    <span class="priority-badge priority-alta">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                            <path d="M12 2L2 12h3v8h14v-8h3L12 2z"/>
                        </svg>
                        Alta
                    </span>
                </label>
                <label class="priority-option-inline ${request.prioridade === 'M√©dia' ? 'active' : ''}" onclick="changePriority('${request.id}', 'M√©dia')">
                    <input type="radio" name="priority-${request.id}" value="M√©dia" ${request.prioridade === 'M√©dia' ? 'checked' : ''}>
                    <span class="priority-badge priority-media">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                        M√©dia
                    </span>
                </label>
                <label class="priority-option-inline ${request.prioridade === 'Baixa' ? 'active' : ''}" onclick="changePriority('${request.id}', 'Baixa')">
                    <input type="radio" name="priority-${request.id}" value="Baixa" ${request.prioridade === 'Baixa' ? 'checked' : ''}>
                    <span class="priority-badge priority-baixa">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                            <path d="M12 22L22 12h-3V4H5v8H2l10 10z"/>
                        </svg>
                        Baixa
                    </span>
                </label>
            </div>
        </div>`;
    }
    
    html += `
        <div class="detail-group">
            <div class="detail-label">Estado</div>
            <div class="detail-badges"><span class="badge badge-estado ${(request.estado || 'Novo').toLowerCase().replace(' ', '')}">${request.estado || 'Novo'}</span></div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Empresa</div>
            <div class="detail-value">${request.empresa || 'MCF'}</div>
        </div>`;
    
    // ‚úÖ v3.7.0.8: Mostrar Frequ√™ncia e Data Pr√≥xima Interven√ß√£o para Preventivas
    if (request.tipo === 'Preventiva') {
        if (request.frequencia && request.frequencia !== '-') {
            html += `
        <div class="detail-group">
            <div class="detail-label">Frequ√™ncia</div>
            <div class="detail-value"><strong>${request.frequencia}</strong></div>
        </div>`;
        }
        
        if (request.dataPrimeiraIntervencao) {
            const proximaData = calcularProximaIntervencao(request.dataPrimeiraIntervencao, request.frequencia);
            if (proximaData) {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                const diasRestantes = Math.ceil((proximaData - hoje) / (1000 * 60 * 60 * 24));
                
                let indicador = '';
                if (diasRestantes === 0) indicador = '<span style="color: #2ecc71; font-weight: bold;">üìÖ HOJE</span>';
                else if (diasRestantes > 0) indicador = `<span style="color: #f39c12; font-weight: bold;">‚ö° Em ${diasRestantes} dias</span>`;
                else indicador = `<span style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è Atrasada ${Math.abs(diasRestantes)} dias</span>`;
                
                html += `
        <div class="detail-group">
            <div class="detail-label">Data 1¬™ Interven√ß√£o</div>
            <div class="detail-value">${new Date(request.dataPrimeiraIntervencao).toLocaleDateString('pt-PT')}</div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Pr√≥xima Interven√ß√£o</div>
            <div class="detail-value">
                <strong>${proximaData.toLocaleDateString('pt-PT')}</strong>
                <br>${indicador}
            </div>
        </div>`;
            }
        }
    }
    
    // Tipo de Interven√ß√£o
    if (request.tipoIntervencao && request.tipoIntervencao !== '-') {
        html += `
        <div class="detail-group">
            <div class="detail-label">Tipo de Interven√ß√£o</div>
            <div class="detail-value">${request.tipoIntervencao}</div>
        </div>`;
    }
    
    // ‚ö° NOVO: √Årea/Equipamento
    if (request.areaEquipamento && request.areaEquipamento !== '-') {
        html += `
        <div class="detail-group">
            <div class="detail-label">√Årea/Equipamento</div>
            <div class="detail-value"><strong>${request.areaEquipamento}</strong></div>
        </div>`;
    }
    
    // ‚ö° NOVO: Componente
    if (request.componente && request.componente !== '-') {
        html += `
        <div class="detail-group">
            <div class="detail-label">Componente</div>
            <div class="detail-value">${request.componente}</div>
        </div>`;
    }
    
    // Urgente e Paragem Produ√ß√£o
    if (request.urgente || request.paragemProducao) {
        html += `<div class="detail-group"><div class="detail-label">Especiais</div><div class="detail-badges">`;
        if (request.urgente) html += `<span class="badge" style="background: #ff4757; color: white;">üî¥ Urgente</span>`;
        if (request.paragemProducao) html += `<span class="badge" style="background: #ffa502; color: white;">‚ö†Ô∏è Paragem Produ√ß√£o</span>`;
        html += `</div></div>`;
    }
    
    if (request.departamento !== '-') {
        html += `
        <div class="detail-group">
            <div class="detail-label">Departamento</div>
            <div class="detail-value">${request.departamento}</div>
        </div>`;
    }
    
    html += `
        <div class="detail-group">
            <div class="detail-label">Descri√ß√£o</div>
            <div class="detail-value">${request.descricao}</div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Registado por</div>
            <div class="detail-value">${request.nome}</div>
        </div>`;
    
    // üì∏ v3.6.18: Suportar fotos do Storage E base64 (legacy)
    if (request.foto) {
        // Se for URL do Storage ou base64, mostrar normalmente
        const fotoSrc = request.foto.startsWith('http') || request.foto.startsWith('data:') 
            ? request.foto 
            : window.SupabaseAPI.getFotoUrl(request.id);  // Fallback: tentar gerar URL
        
        html += `
        <div class="detail-group">
            <div class="detail-label">Fotografia</div>
            <img src="${fotoSrc}" 
                 alt="Foto da ordem de trabalho" 
                 class="detail-image"
                 onerror="this.style.display='none'; this.parentElement.innerHTML='<p style=color:red>‚ö†Ô∏è Foto n√£o dispon√≠vel</p>'">
        </div>`;
    }
    
    // üÜï MATERIAIS USADOS (sempre vis√≠vel)
    const materiaisUsados = AppState.movimentos.filter(m => m.pedidoId === request.id);
    if (materiaisUsados.length > 0) {
        let custoTotal = 0;
        html += `
        <div class="detail-group" style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-top: 20px;">
            <div class="detail-label" style="font-size: 16px; margin-bottom: 12px;">üí∞ Materiais Usados</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">`;
        
        materiaisUsados.forEach(mov => {
            const artigo = AppState.artigos.find(a => a.id === mov.artigoId);
            if (artigo) {
                const custo = Math.abs(mov.quantidade) * artigo.preco;
                custoTotal += custo;
                const dataFormatada = new Date(mov.dataHora).toLocaleString('pt-PT', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'});
                html += `
                <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px; border: 1px solid #dee2e6;">
                    <div>
                        <strong>${artigo.designacao}</strong><br>
                        <small style="color: #6c757d;">${Math.abs(mov.quantidade)} ${artigo.unidade || 'un'} √ó ‚Ç¨${artigo.preco.toFixed(2)} | ${dataFormatada} | ${mov.responsavel}</small>
                    </div>
                    <div style="font-weight: 600; color: #dc3545;">‚Ç¨${custo.toFixed(2)}</div>
                </div>`;
            }
        });
        
        html += `
            </div>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid #dee2e6; text-align: right; font-size: 18px; font-weight: 700; color: #dc3545;">
                Total: ‚Ç¨${custoTotal.toFixed(2)}
            </div>
        </div>`;
    }
    
    html += `<div class="modal-actions">`;
    html += `
        <button class="btn btn-secondary" onclick="printRequest('${request.id}');" style="background: #2196F3; color: white;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                <rect x="6" y="14" width="12" height="8"/>
            </svg>
            Imprimir
        </button>
        <button class="btn btn-secondary" onclick="openBaixaMultiplaModal('${request.id}')" style="background: #28a745; color: white;">
            + Movimento
        </button>`;
    if (request.estado !== 'Resolvido') {
        html += `
        <button class="btn btn-primary" onclick="changeRequestState('${request.id}'); closeModal();">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
            ${request.estado === 'Novo' ? 'Iniciar' : 'Marcar como Resolvido'}
        </button>`;
    }
    html += `
        <button class="btn btn-secondary" onclick="deleteRequest('${request.id}'); closeModal();">Eliminar</button>
    </div>`;
    
    modalBody.innerHTML = html;
    modal.classList.add('active');
}

function closeModal() {
    document.getElementById('detailsModal').classList.remove('active');
}

// ‚úÖ v3.7.0.9: Imprimir Ordem de Trabalho (M√âTODO SIMPLES - SEM BLOQUEIOS)
function printRequest(id) {
    const request = AppState.requests.find(r => r.id === id);
    if (!request) {
        alert('Ordem de trabalho n√£o encontrada!');
        return;
    }
    
    const container = document.getElementById('printContainer');
    
    // Montar HTML de impress√£o
    let html = '<h1>PEDIDO DE MANUTEN√á√ÉO</h1>';
    html += '<div class="print-header">';
    html += '<p><strong>ID:</strong> ' + request.id + '</p>';
    html += '<p><strong>Data:</strong> ' + formatDate(request.dataHora) + '</p>';
    html += '</div>';
    
    html += '<div class="print-section">';
    html += '<h2>Informa√ß√µes Gerais</h2>';
    html += '<table>';
    html += '<tr><td>Tipo:</td><td>' + (request.tipo || '-') + '</td></tr>';
    html += '<tr><td>Prioridade:</td><td>' + (request.prioridade || '-') + '</td></tr>';
    html += '<tr><td>Estado:</td><td>' + (request.estado || '-') + '</td></tr>';
    html += '<tr><td>Empresa:</td><td>' + (request.empresa || 'MCF') + '</td></tr>';
    if (request.areaEquipamento) html += '<tr><td>√Årea/Equipamento:</td><td>' + request.areaEquipamento + '</td></tr>';
    if (request.componente) html += '<tr><td>Componente:</td><td>' + request.componente + '</td></tr>';
    if (request.departamento) html += '<tr><td>Departamento:</td><td>' + request.departamento + '</td></tr>';
    if (request.responsavel) html += '<tr><td>Respons√°vel:</td><td>' + request.responsavel + '</td></tr>';
    if (request.horasEstimadas) html += '<tr><td>Horas Estimadas:</td><td>' + request.horasEstimadas + 'h</td></tr>';
    if (request.urgente === 'Sim') html += '<tr><td>Urgente:</td><td>‚ö†Ô∏è SIM</td></tr>';
    if (request.paragemProducao === 'Sim') html += '<tr><td>Paragem Produ√ß√£o:</td><td>üõë SIM</td></tr>';
    html += '<tr><td>Registado por:</td><td>' + (request.nome || '-') + '</td></tr>';
    html += '</table>';
    html += '</div>';
    
    html += '<div class="print-section">';
    html += '<h2>Descri√ß√£o</h2>';
    html += '<p class="description">' + (request.descricao || '-').replace(/\n/g, '<br>') + '</p>';
    html += '</div>';
    
    if (request.foto) {
        html += '<div class="print-section photo-section">';
        html += '<h2>Fotografia</h2>';
        html += '<img src="' + request.foto + '" alt="Foto da ordem de trabalho">';
        html += '</div>';
    }
    
    html += '<div class="print-footer">';
    html += '<p><strong>MCF + PSY - Sistema de Gest√£o de Manuten√ß√£o</strong></p>';
    html += '<p>Impresso em ' + new Date().toLocaleDateString('pt-PT') + ' √†s ' + new Date().toLocaleTimeString('pt-PT') + '</p>';
    html += '</div>';
    
    container.innerHTML = html;
    
    // Fechar modal e imprimir
    closeModal();
    setTimeout(function() {
        window.print();
        // Limpar ap√≥s impress√£o
        setTimeout(function() {
            container.innerHTML = '';
        }, 100);
    }, 300);
}

// A√á√ïES
async function changeRequestState(id) {
    const request = AppState.requests.find(r => r.id === id);
    if (!request) return;
    
    const stateTransitions = { 'Novo': 'Em curso', 'Em curso': 'Resolvido', 'Resolvido': 'Resolvido' };
    const newState = stateTransitions[request.estado];
    
    // ‚úÖ v3.7.0.9: Registar respons√°vel ao iniciar pedido
    if (newState === 'Em curso' && request.estado === 'Novo') {
        if (AppState.currentUser && !request.responsavel) {
            request.responsavel = AppState.currentUser.nomeCompleto;
            console.log('‚úÖ Respons√°vel registado:', request.responsavel);
        }
    }
    
    // ‚úÖ CORRE√á√ÉO 4: Se est√° a fechar (Resolvido), pedir observa√ß√µes
    if (newState === 'Resolvido' && request.estado !== 'Resolvido') {
        const observacoes = prompt('Observa√ß√µes ao fechar o pedido (opcional):');
        
        if (observacoes !== null) {  // null significa que cancelou
            // ‚úÖ Adicionar observa√ß√µes com timestamp no formato original
            if (observacoes.trim()) {
                const timestamp = new Date().toLocaleString('pt-PT');
                request.descricao = (request.descricao || '').trim() + ' [' + timestamp + '] Fechado: ' + observacoes.trim();
            }
            
            request.estado = newState;
            saveToLocalStorage();
            if (AppState.isOnline) await updateInGoogleSheets(request);  // üî• Nome legacy, usa Supabase
            renderRequestsList();
            showToast(`Estado alterado para: ${newState}`, 'success');
        }
    } else {
        // Estados normais (Novo ‚Üí Em curso)
        request.estado = newState;
        saveToLocalStorage();
        if (AppState.isOnline) await updateInGoogleSheets(request);  // üî• Nome legacy, usa Supabase
        renderRequestsList();
        showToast(`Estado alterado para: ${newState}`, 'success');
    }
}

async function deleteRequest(id) {
    if (!confirm('Tem a certeza que deseja eliminar esta ordem de trabalho?')) return;
    const index = AppState.requests.findIndex(r => r.id === id);
    if (index === -1) return;
    AppState.requests.splice(index, 1);
    saveToLocalStorage();
    if (AppState.isOnline) await deleteFromGoogleSheets(id);  // üî• Nome legacy, usa Supabase
    renderRequestsList();
    showToast('Ordem de trabalho eliminada com sucesso.', 'success');
}

// ‚úÖ v3.7.0.9: Alterar Prioridade do Pedido
async function changePriority(id, novaPrioridade) {
    console.log(`üîÑ Alterando prioridade da ordem ${id}: ${novaPrioridade}`);
    
    const request = AppState.requests.find(r => r.id === id);
    if (!request) {
        console.error('‚ùå Ordem de trabalho n√£o encontrada:', id);
        return;
    }
    
    // Se j√° est√° na mesma prioridade, n√£o fazer nada
    if (request.prioridade === novaPrioridade) {
        console.log('‚úÖ Prioridade j√° √©', novaPrioridade);
        return;
    }
    
    const prioridadeAnterior = request.prioridade;
    console.log(`üìù Prioridade anterior: ${prioridadeAnterior} ‚Üí Nova: ${novaPrioridade}`);
    
    request.prioridade = novaPrioridade;
    
    // Atualizar localStorage
    saveToLocalStorage();
    console.log('‚úÖ Prioridade atualizada no localStorage');
    
    // Atualizar Supabase
    if (AppState.isOnline) {
        try {
            console.log('üîÑ Atualizando prioridade no Supabase...');
            await updateInGoogleSheets(request);  // üî• Nome legacy, usa Supabase
            console.log('‚úÖ Prioridade atualizada no Supabase com sucesso!');
            showToast(`‚úÖ Prioridade alterada: ${prioridadeAnterior} ‚Üí ${novaPrioridade}`, 'success');
        } catch (error) {
            console.error('‚ùå Erro ao atualizar prioridade no Supabase:', error);
            showToast('‚ùå Erro ao atualizar prioridade no servidor', 'error');
            // Reverter mudan√ßa em caso de erro
            request.prioridade = prioridadeAnterior;
            saveToLocalStorage();
            console.log('‚Ü©Ô∏è Prioridade revertida devido a erro');
        }
    } else {
        console.log('‚ö†Ô∏è App offline - prioridade guardada apenas localmente');
        showToast(`Prioridade alterada: ${prioridadeAnterior} ‚Üí ${novaPrioridade} (offline)`, 'info');
    }
    
    // Atualizar lista de ordens de trabalho
    renderRequestsList();
    console.log('‚úÖ Lista de ordens de trabalho atualizada');
    
    // Reabrir modal com dados atualizados
    openRequestDetails(id);
    console.log('‚úÖ Modal reaberto com dados atualizados');
}

// ===================================
// SINCRONIZA√á√ÉO COM SUPABASE
// ===================================
// üî• v3.6.8: Migrado para Supabase (fun√ß√µes mant√™m nomes antigos para compatibilidade)
// üî• v3.7.0.8: Adicionados campos Frequencia e Data 1¬™ Interven√ß√£o

async function sendToGoogleSheets(data) {
    try {
        console.log('üî• DEBUG: ID gerado no JavaScript:', data.id);
        
        // ‚úÖ v3.7.2.14: Converter formato da app ‚Üí formato Supabase DOM√âSTICO
        const supabaseData = {
            pedido_id: data.id,              // OT_00001, OT_00002, etc.
            tipo: data.tipo,                 // Casa, Jardim, Carro, etc.
            zona: data.zona || null,         // Cozinha, Sala, Quarto, etc.
            descricao: data.descricao,       // Texto da tarefa
            prioridade: data.prioridade,     // Alta, M√©dia, Baixa
            estado: data.estado || 'Novo',   // Novo, Em curso, Resolvido
            responsavel: data.responsavel || data.nome || 'N√£o atribu√≠do',
            foto_url: data.foto || null      // URL da foto (opcional)
        };
        
        console.log('üî• DEBUG: Dados enviados para Supabase:', JSON.stringify(supabaseData, null, 2));
        
        const result = await window.SupabaseAPI.addPedido(supabaseData);
        console.log('‚úÖ Pedido guardado no Supabase');
        console.log('üî• DEBUG: Resposta do Supabase:', result);
        
    } catch (error) {
        console.error('‚ùå Erro ao enviar para Supabase:', error);
        addToOfflineQueue(data);
        throw error;
    }
}

async function updateInGoogleSheets(data) {
    try {
        console.log('üì§ Preparando atualiza√ß√£o no Supabase para pedido:', data.id);
        
        // ‚úÖ v3.7.2.14: Converter formato da app ‚Üí formato Supabase DOM√âSTICO
        const supabaseData = {
            tipo: data.tipo,
            zona: data.zona || null,
            descricao: data.descricao,
            prioridade: data.prioridade,
            estado: data.estado,
            responsavel: data.responsavel || data.nome || 'N√£o atribu√≠do',
            foto_url: data.foto || null
        };
        
        console.log('üìä Dados a enviar para Supabase:', {
            pedido_id: data.id,
            prioridade: supabaseData.prioridade,
            estado: supabaseData.estado
        });
        
        await window.SupabaseAPI.updatePedido(data.id, supabaseData);
        console.log('‚úÖ Ordem de trabalho atualizada no Supabase com sucesso!');
        
    } catch (error) {
        console.error('‚ùå Erro ao atualizar Supabase:', error);
        console.error('‚ùå Detalhes do erro:', error.message);
        addToOfflineQueue({ action: 'update', data: data });
        throw error;
    }
}

async function deleteFromGoogleSheets(id) {
    try {
        await window.SupabaseAPI.deletePedido(id);
        console.log('‚úÖ Ordem de trabalho eliminada do Supabase');
        
    } catch (error) {
        console.error('‚ùå Erro ao eliminar do Supabase:', error);
        throw error;
    }
}

// üî• RENOMEADO v3.6.8: syncWithSupabase (era syncWithGoogleSheets)
async function syncWithGoogleSheets() {
    // ‚ö†Ô∏è Mant√©m o nome syncWithGoogleSheets para compatibilidade, mas usa Supabase
    await syncWithSupabase();
}

async function syncWithSupabase() {
    if (!AppState.isOnline) {
        console.log('üì° Offline - sync cancelado');
        return;
    }
    
    try {
        console.log('üîÑ A sincronizar com Supabase...');
        
        // Carregar PEDIDOS
        await loadDataFromSupabase();
        
        // ‚úÖ v3.7.2.20: Artigos e movimentos desativados (app dom√©stica n√£o usa stock)
        // Carregar ARTIGOS - DESATIVADO
        // const artigos = await window.SupabaseAPI.getArtigos();
        // AppState.artigos = artigos.map(a => ({
        //     id: a.ID,
        //     codigo: a.ID,
        //     familia: a.Fam√≠lia,
        //     designacao: a.Designa√ß√£o,
        //     referencia: a.Refer√™ncia,
        //     fornecedor: a.Fornecedor,
        //     preco: parseFloat(a['Pre√ßo Unit√°rio']) || 0,
        //     stockMinimo: parseInt(a['Stock M√≠nimo']) || 0,
        //     // ‚úÖ NOTA: Stock N√ÉO √© guardado na tabela! √â calculado via calcularStockAtual()
        //     empresa: a.Empresa,
        //     unidade: a.Unidade
        // }));
        // console.log(`‚úÖ ${AppState.artigos.length} artigos carregados`);
        // renderStockMinimo();
        
        // Carregar MOVIMENTOS - DESATIVADO
        // const movimentos = await window.SupabaseAPI.getMovimentos();
        // AppState.movimentos = movimentos.map(m => ({
        //     id: m.ID,
        //     dataHora: m['Data/Hora'],
        //     artigoId: m['Artigo ID'],
        //     tipo: m.Tipo,
        //     quantidade: parseInt(m.Quantidade) || 0,
        //     pedidoId: m['Pedido ID'],
        //     responsavel: m.Respons√°vel,
        //     observacoes: m.Observa√ß√µes,
        //     empresa: m.Empresa
        // }));
        
        // ‚úÖ Ordenar movimentos por data (mais recentes primeiro)
        // AppState.movimentos.sort((a, b) => {
        //     const dateA = new Date(a.dataHora);
        //     const dateB = new Date(b.dataHora);
        //     return dateB - dateA;
        // });
        
        // console.log(`‚úÖ ${AppState.movimentos.length} movimentos carregados`);
        
        // Carregar UTILIZADORES - DESATIVADO
        // const utilizadores = await window.SupabaseAPI.getUtilizadores();
        // AppState.utilizadores = utilizadores
        //     .filter(u => u.Ativo === 'Sim' || u.Ativo === true)
        //     .map(u => ({
        //         username: u.Username,
        //         nomeCompleto: u['Nome Completo'],
        //         departamento: u.Departamento,
        //         role: u.Role
        //     }));
        
        // ‚úÖ FALLBACK: Se n√£o houver utilizadores, usar lista padr√£o - DESATIVADO
        // if (AppState.utilizadores.length === 0) {
        //     console.warn('‚ö†Ô∏è Nenhum utilizador no Supabase. Usando lista padr√£o.');
        //     AppState.utilizadores = [
        //         { username: 'toni', nomeCompleto: 'Toni', departamento: 'Manuten√ß√£o', role: 'operador' },
        //         { username: 'jose', nomeCompleto: 'Jos√©', departamento: 'Manuten√ß√£o', role: 'operador' },
        //         { username: 'manuel', nomeCompleto: 'Manuel', departamento: 'Manuten√ß√£o', role: 'operador' },
        //         { username: 'carlos', nomeCompleto: 'Carlos', departamento: 'Manuten√ß√£o', role: 'operador' },
        //         { username: 'paulo', nomeCompleto: 'Paulo', departamento: 'Manuten√ß√£o', role: 'operador' },
        //         { username: 'pedro', nomeCompleto: 'Pedro', departamento: 'Manuten√ß√£o', role: 'operador' },
        //         { username: 'bruno', nomeCompleto: 'Bruno', departamento: 'Manuten√ß√£o', role: 'operador' },
        //         { username: 'miguel', nomeCompleto: 'Miguel', departamento: 'Manuten√ß√£o', role: 'operador' }
        //     ];
        // }
        
        // console.log(`‚úÖ ${AppState.utilizadores.length} utilizadores carregados`);
        
        // ‚úÖ v3.7.2.20: Carregar EQUIPAMENTOS - DESATIVADO (app dom√©stica n√£o usa)
        // console.log('üîÑ A carregar equipamentos do Supabase...');
        // const equipamentos = await window.SupabaseAPI.getEquipamentos();
        // console.log('üîç Equipamentos recebidos:', equipamentos);
        // AppState.equipamentos = equipamentos || [];
        // console.log(`‚úÖ ${AppState.equipamentos.length} equipamentos carregados do Supabase`);
        
        // if (AppState.equipamentos.length === 0) {
        //     console.error('‚ö†Ô∏è AVISO: Nenhum equipamento carregado! Verificar:');
        //     console.error('  1. Tabela lista_equipamentos existe no Supabase?');
        //     console.error('  2. Dados foram inseridos?');
        //     console.error('  3. RLS permite SELECT p√∫blico?');
        // }
        
        // üîç Atualizar painel de debug visual - DESATIVADO
        // atualizarPainelDebug();
        
        // ‚úÖ v3.7.0.9: Popular dropdowns DEPOIS de carregar equipamentos - DESATIVADO
        // ‚úÖ N√ÉO popular √°rea/equipamento automaticamente - aguardar empresa ser selecionada
        // const areaSelect = document.getElementById('areaEquipamento');
        // if (areaSelect) {
        //     areaSelect.innerHTML = '<option value="">Escolha primeiro a empresa</option>';
        //     areaSelect.disabled = true;
        // }
        
        // populateEquipamentoFilter();
        // console.log('‚úÖ Dropdowns de equipamentos configurados (aguardando sele√ß√£o de empresa)');
        
        // Guardar localmente
        saveToLocalStorage();
        
        showToast('Dados sincronizados', 'success');
        console.log('‚úÖ Sincroniza√ß√£o com Supabase completa');
        
        renderRequestsList();
        
    } catch (error) {
        console.error('‚ùå Erro ao sincronizar com Supabase:', error);
        console.warn('‚ö†Ô∏è Usando dados locais');
    }
}

// OFFLINE SUPPORT
function setupOnlineOfflineListeners() {
    window.addEventListener('online', async () => {
        AppState.isOnline = true;
        showToast('Conex√£o restaurada. Sincronizando...', 'info');
        await processOfflineQueue();
        await syncWithGoogleSheets();
        renderRequestsList();
    });
    window.addEventListener('offline', () => {
        AppState.isOnline = false;
        showToast('Sem conex√£o. Os dados ser√£o sincronizados quando a conex√£o for restaurada.', 'info');
    });
}

function addToOfflineQueue(item) {
    const queue = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.OFFLINE_QUEUE) || '[]');
    // Se item j√° tem action, usa-a; sen√£o default √© 'create'
    const queueItem = item.action ? item : { action: 'create', data: item, timestamp: Date.now() };
    if (!queueItem.timestamp) queueItem.timestamp = Date.now();
    queue.push(queueItem);
    localStorage.setItem(CONFIG.STORAGE_KEYS.OFFLINE_QUEUE, JSON.stringify(queue));
    console.log(`üì• Item adicionado √† fila offline: ${queueItem.action}`);
}

async function processOfflineQueue() {
    const queue = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.OFFLINE_QUEUE) || '[]');
    if (queue.length === 0) return;
    console.log(`üì§ Processando ${queue.length} itens da fila offline...`);
    for (const item of queue) {
        try {
            if (item.action === 'create') {
                await sendToGoogleSheets(item.data);
            } else if (item.action === 'update') {
                await updateInGoogleSheets(item.data);
            } else if (item.action === 'delete') {
                await deleteFromGoogleSheets(item.id || item.data.id);
            }
        } catch (error) {
            console.error('Erro ao processar item da fila:', error);
        }
    }
    localStorage.setItem(CONFIG.STORAGE_KEYS.OFFLINE_QUEUE, '[]');
    showToast('Dados sincronizados com sucesso!', 'success');
}

// ============================================
// LOCAL STORAGE - GEST√ÉO SUSTENT√ÅVEL
// ============================================

// Auto-limpeza di√°ria de dados antigos
function cleanOldDataFromLocalStorage() {
    try {
        const lastCleanup = localStorage.getItem('last_cleanup');
        const now = Date.now();
        const oneDayMs = 24 * 60 * 60 * 1000;
        
        // S√≥ limpar se passou mais de 1 dia
        if (!lastCleanup || (now - parseInt(lastCleanup)) > oneDayMs) {
            console.log('üß∫ Limpeza autom√°tica de dados antigos...');
            
            // Remover pedidos com mais de 7 dias
            const saved = localStorage.getItem(CONFIG.STORAGE_KEYS.REQUESTS);
            if (saved) {
                const requests = JSON.parse(saved);
                const sevenDaysAgo = now - (7 * oneDayMs);
                const recentRequests = requests.filter(req => {
                    const reqDate = new Date(req.dataHora).getTime();
                    return reqDate > sevenDaysAgo;
                });
                
                if (recentRequests.length < requests.length) {
                    console.log(`‚úÖ Removidos ${requests.length - recentRequests.length} pedidos antigos (>7 dias)`);
                    localStorage.setItem(CONFIG.STORAGE_KEYS.REQUESTS, JSON.stringify(recentRequests));
                }
            }
            
            // Limpar fila offline antiga
            localStorage.removeItem('maintenance_offline_queue');
            
            // Marcar √∫ltima limpeza
            localStorage.setItem('last_cleanup', now.toString());
            console.log('‚úÖ Limpeza conclu√≠da!');
        }
    } catch (error) {
        console.error('‚ùå Erro na limpeza autom√°tica:', error);
    }
}

// Verificar espa√ßo dispon√≠vel no localStorage
function getLocalStorageInfo() {
    try {
        const total = JSON.stringify(localStorage).length;
        const totalMB = (total / 1024 / 1024).toFixed(2);
        const limitMB = 5; // Limite aproximado
        const usagePercent = ((total / (limitMB * 1024 * 1024)) * 100).toFixed(1);
        
        return {
            totalBytes: total,
            totalMB: totalMB,
            usagePercent: usagePercent,
            isNearLimit: usagePercent > 70
        };
    } catch (error) {
        return { totalMB: '?', usagePercent: '?', isNearLimit: true };
    }
}

function saveToLocalStorage() {
    try {
        // üß∫ Auto-limpeza di√°ria
        cleanOldDataFromLocalStorage();
        
        // üìä Verificar espa√ßo
        const storageInfo = getLocalStorageInfo();
        console.log(`üìä LocalStorage: ${storageInfo.totalMB} MB (${storageInfo.usagePercent}% usado)`);
        
        if (storageInfo.isNearLimit) {
            console.warn('‚ö†Ô∏è LocalStorage pr√≥ximo do limite! For√ßando limpeza...');
            cleanOldDataFromLocalStorage();
        }
        
        // üõ°Ô∏è NUNCA guardar fotos base64!
        // üõ°Ô∏è Limitar a 30 pedidos mais recentes (7 dias de trabalho t√≠pico)
        let requestsToSave = AppState.requests
            .sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora))
            .slice(0, 30);
        
        // Remover TODAS as fotos (apenas URLs do Drive s√£o mantidas no Google Sheets)
        const requestsWithoutPhotos = requestsToSave.map(req => ({
            id: req.id,
            dataHora: req.dataHora,
            tipo: req.tipo,
            prioridade: req.prioridade,
            departamento: req.departamento,
            descricao: req.descricao,
            nome: req.nome,
            estado: req.estado,
            empresa: req.empresa,
            urgente: req.urgente,
            tipoIntervencao: req.tipoIntervencao,
            paragemProducao: req.paragemProducao
            // foto: REMOVIDO - Fotos s√≥ no Google Sheets!
            // artigos: REMOVIDO - Dados de stock sempre do servidor
        }));
        
        const dataToSave = JSON.stringify(requestsWithoutPhotos);
        const sizeKB = (dataToSave.length / 1024).toFixed(2);
        
        console.log(`üíæ Guardando ${requestsWithoutPhotos.length} pedidos (${sizeKB} KB - SEM fotos)`);
        
        // Verificar espa√ßo dispon√≠vel
        const testKey = 'test_quota_' + Date.now();
        try {
            localStorage.setItem(testKey, dataToSave);
            localStorage.removeItem(testKey);
            
            // Se chegou aqui, h√° espa√ßo suficiente
            localStorage.setItem(CONFIG.STORAGE_KEYS.REQUESTS, dataToSave);
            console.log('‚úÖ Dados guardados com sucesso!');
            
        } catch (quotaError) {
            console.error('‚ùå LocalStorage cheio! Limpeza de emerg√™ncia...');
            
            // LIMPEZA DE EMERG√äNCIA TOTAL
            localStorage.removeItem('maintenance_offline_queue');
            localStorage.removeItem('maintenance_planning');
            localStorage.removeItem('maintenance_user_session'); // For√ßar novo login (seguran√ßa)
            
            // Tentar novamente com apenas 10 pedidos
            const minimalRequests = requestsWithoutPhotos.slice(0, 10);
            try {
                localStorage.setItem(CONFIG.STORAGE_KEYS.REQUESTS, JSON.stringify(minimalRequests));
                console.log('‚úÖ Limpeza de emerg√™ncia conclu√≠da. Guardados 10 pedidos.');
            } catch (finalError) {
                // Se ainda assim falhar, limpar TUDO
                console.error('‚ùå Limpeza de emerg√™ncia falhou. Limpando TUDO...');
                localStorage.clear();
                showToast('‚ö†Ô∏è Cache limpo por falta de espa√ßo. Fa√ßa login novamente.', 'warning');
                setTimeout(() => location.reload(), 2000);
            }
        }
        
    } catch (error) {
        console.error('‚ùå Erro cr√≠tico ao guardar no localStorage:', error);
        // N√ÉO mostrar toast - modo silencioso para n√£o incomodar utilizador
        // App continua a funcionar s√≥ com dados do servidor
    }
}

function loadFromLocalStorage() {
    const saved = localStorage.getItem(CONFIG.STORAGE_KEYS.REQUESTS);
    if (saved) AppState.requests = JSON.parse(saved);
}

// EXPORTAR EXCEL
function exportToExcel() {
    if (AppState.requests.length === 0) {
        showToast('N√£o h√° pedidos para exportar.', 'info');
        return;
    }
    try {
        // Preparar dados para exporta√ß√£o
        const exportData = AppState.requests.map(request => ({
            'ID': request.id, 
            'Data/Hora': formatDateLong(request.dataHora), 
            'Tipo': request.tipo,
            'Prioridade': request.prioridade, 
            'Estado': request.estado, 
            'Departamento': request.departamento,
            'Descri√ß√£o': request.descricao,
            'Registado por': request.nome, 
            'Foto': request.foto ? 'Ver Foto' : 'Sem foto'
        }));
        
        // Criar worksheet
        const ws = XLSX.utils.json_to_sheet(exportData);
        
        // üì∏ ADICIONAR HIPERLINKS PARA FOTOS!
        // Percorrer cada linha e adicionar hiperlink se tiver foto
        AppState.requests.forEach((request, index) => {
            if (request.foto) {
                const cellAddress = XLSX.utils.encode_cell({ r: index + 1, c: 8 }); // Coluna I (Foto)
                
                // Criar hiperlink clic√°vel
                ws[cellAddress].l = { 
                    Target: request.foto, 
                    Tooltip: "Clique para ver a foto" 
                };
                
                // Estilo azul e sublinhado (como link)
                if (!ws[cellAddress].s) ws[cellAddress].s = {};
                ws[cellAddress].s = {
                    font: { color: { rgb: "0563C1" }, underline: true }
                };
            }
        });
        
        // Criar workbook e adicionar sheet
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Pedidos de Manuten√ß√£o");
        
        // Configurar largura das colunas
        ws['!cols'] = [
            { wch: 36 }, // ID
            { wch: 20 }, // Data/Hora
            { wch: 12 }, // Tipo
            { wch: 12 }, // Prioridade
            { wch: 12 }, // Estado
            { wch: 15 }, // Departamento
            { wch: 50 }, // Descri√ß√£o
            { wch: 20 }, // Registado por
            { wch: 15 }  // Foto (hiperlink)
        ];
        
        const fileName = `Manutencao_${formatDateForFilename()}.xlsx`;
        XLSX.writeFile(wb, fileName, { bookType: 'xlsx', type: 'binary' });
        
        showToast('‚úÖ Excel exportado com fotos clic√°veis!', 'success');
    } catch (error) {
        console.error('Erro ao exportar Excel:', error);
        showToast('Erro ao exportar ficheiro Excel.', 'error');
    }
}

// SERVICE WORKER - DESATIVADO (causa conflitos com login)
// async function registerServiceWorker() {
//     try {
//         const registration = await navigator.serviceWorker.register('./sw.js');
//         console.log('‚úÖ Service Worker registado:', registration);
//     } catch (error) {
//         console.error('‚ùå Erro ao registar Service Worker:', error);
//     }
// }

// DESATIVAR Service Workers existentes
async function unregisterServiceWorkers() {
    if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (let registration of registrations) {
            await registration.unregister();
            console.log('üóëÔ∏è Service Worker removido');
        }
    }
}

// TOAST
function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icons = {
        success: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>',
        error: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>',
        info: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'
    };
    toast.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${icons[type]}</svg><div class="toast-message">${message}</div>`;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// ‚ö° LOADING SPINNER - Feedback visual durante carregamento do Google Sheets
function showLoadingSpinner(message = 'Carregando...') {
    let spinner = document.getElementById('loadingSpinner');
    
    // Se n√£o existe, criar
    if (!spinner) {
        spinner = document.createElement('div');
        spinner.id = 'loadingSpinner';
        spinner.className = 'loading-spinner-overlay';
        spinner.innerHTML = `
            <div class="loading-spinner-content">
                <div class="spinner-circle"></div>
                <p class="spinner-message">${message}</p>
            </div>
        `;
        document.body.appendChild(spinner);
    } else {
        // Atualizar mensagem
        const messageEl = spinner.querySelector('.spinner-message');
        if (messageEl) messageEl.textContent = message;
    }
    
    // Mostrar com anima√ß√£o
    setTimeout(() => spinner.classList.add('active'), 10);
    console.log('‚ö° Loading spinner MOSTRADO:', message);
}

function hideLoadingSpinner() {
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) {
        spinner.classList.remove('active');
        setTimeout(() => {
            if (spinner.parentNode) {
                spinner.parentNode.removeChild(spinner);
            }
        }, 300); // Aguarda anima√ß√£o
        console.log('‚ö° Loading spinner ESCONDIDO');
    }
}

// UTILS
// ‚úÖ v3.7.0.9: Gerar ID sequencial para Ordens de Trabalho (OT_XXXXX)
async function generateOTID() {
    try {
        // Obter todas as OTs do Supabase para descobrir o pr√≥ximo n√∫mero
        const response = await window.SupabaseAPI.getPedidos();
        
        let nextNumber = 1;
        
        if (response && response.length > 0) {
            // Filtrar apenas IDs do formato OT_XXXXX e ordenar
            const otIDs = response
                .map(r => r.ID)
                .filter(id => id && id.startsWith('OT_') && !isNaN(parseInt(id.replace('OT_', ''))))
                .map(id => parseInt(id.replace('OT_', '')))
                .sort((a, b) => b - a); // Ordenar decrescente
            
            if (otIDs.length > 0) {
                nextNumber = otIDs[0] + 1;
            } else {
                // Se n√£o h√° OT_XXXXX, contar total de registros
                nextNumber = response.length + 1;
            }
        }
        
        // Formatar como OT_00001, OT_00002, etc.
        const otID = `OT_${String(nextNumber).padStart(5, '0')}`;
        console.log(`‚úÖ Novo ID gerado: ${otID} (pr√≥ximo ap√≥s ${nextNumber - 1})`);
        return otID;
        
    } catch (error) {
        console.error('‚ùå Erro ao gerar ID OT:', error);
        // Fallback: usar timestamp
        const fallbackID = `OT_${Date.now()}`;
        console.warn(`‚ö†Ô∏è Usando ID fallback: ${fallbackID}`);
        return fallbackID;
    }
}

// Manter generateUUID para compatibilidade (caso seja usado em outro lugar)
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

function formatDate(isoString) {
    const date = new Date(isoString), now = new Date(), diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000), diffHours = Math.floor(diffMs / 3600000), diffDays = Math.floor(diffMs / 86400000);
    if (diffMins < 1) return 'Agora';
    if (diffMins < 60) return `H√° ${diffMins}m`;
    if (diffHours < 24) return `H√° ${diffHours}h`;
    if (diffDays < 7) return `H√° ${diffDays}d`;
    return date.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function formatDateLong(isoString) {
    const date = new Date(isoString);
    return date.toLocaleString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function formatDateForFilename() {
    return new Date().toISOString().split('T')[0];
}

// ‚úÖ v3.7.0.8: Calcular pr√≥xima interven√ß√£o baseada na frequ√™ncia
function calcularProximaIntervencao(dataPrimeiraIntervencao, frequencia) {
    if (!dataPrimeiraIntervencao || !frequencia) return null;
    
    const dataBase = new Date(dataPrimeiraIntervencao);
    if (isNaN(dataBase.getTime())) return null;
    
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    
    // Mapeamento de frequ√™ncias para dias
    const diasPorFrequencia = {
        'Semanal': 7,
        'Quinzenal': 14,
        'Mensal': 30,
        'Trimestral': 90,
        'Semestral': 180,
        'Anual': 365,
        '2 anos': 730
    };
    
    const diasIntervalo = diasPorFrequencia[frequencia];
    if (!diasIntervalo) return null;
    
    let proximaData = new Date(dataBase);
    
    // Encontrar a pr√≥xima data no futuro
    while (proximaData <= hoje) {
        proximaData.setDate(proximaData.getDate() + diasIntervalo);
    }
    
    return proximaData;
}

// PLANEAMENTO
async function initializePlanning() {
    try {
        loadPlanningFromStorage(); 
        await loadPlanningFromSupabase();  // ‚úÖ v3.7.0.8: Carregar do Supabase
        resetPlanningToToday(); 
        renderPlanningGrid();
        
        // ‚úÖ Popular filtros DEPOIS de carregar planeamento
        populateResponsavelFilter();
        populatePlanningFilters();  // ‚úÖ v3.7.0.9: Popular filtros do planeamento
    } catch (error) {
        console.error('‚ùå Erro ao inicializar planeamento:', error);
        // ‚úÖ FALLBACK: Garantir que datas est√£o definidas
        resetPlanningToToday();
        renderPlanningGrid();
    }
}
function resetPlanningToToday() {
    const today = new Date(); today.setHours(0,0,0,0);
    AppState.planning.startDate = new Date(today);
    AppState.planning.endDate = new Date(today);
    AppState.planning.endDate.setDate(today.getDate() + (CONFIG.PLANNING_WEEKS * 7) - 1);
    renderPlanningGrid();
}
function movePlanningWeek(direction) {
    const daysToMove = 7 * direction;
    AppState.planning.startDate.setDate(AppState.planning.startDate.getDate() + daysToMove);
    AppState.planning.endDate.setDate(AppState.planning.endDate.getDate() + daysToMove);
    renderPlanningGrid();
}
function generateDateRange() {
    const dates = [], current = new Date(AppState.planning.startDate);
    while (current <= AppState.planning.endDate) {
        if (CONFIG.INCLUDE_WEEKENDS || (current.getDay() !== 0 && current.getDay() !== 6)) dates.push(new Date(current));
        else if (!CONFIG.INCLUDE_WEEKENDS && current.getDay() === 6) dates.push(new Date(current));
        current.setDate(current.getDate() + 1);
    }
    return dates;
}

// ‚úÖ NOVO: Renderizar lista de manuten√ß√µes preventivas
function renderPreventivasList() {
    console.log('üìã Renderizando preventivas...');
    
    const preventivasList = document.getElementById('preventivasList');
    const periodoFilter = document.getElementById('preventivaPeriodoFilter').value;
    const empresaFilter = document.getElementById('preventivaEmpresaFilter').value;
    const frequenciaFilter = document.getElementById('preventivaFrequenciaFilter').value;
    
    // Filtrar pedidos preventivos
    let preventivas = AppState.requests.filter(r => r.tipo === 'Preventiva');
    
    // Aplicar filtros
    if (empresaFilter !== 'todas') {
        preventivas = preventivas.filter(r => r.empresa === empresaFilter);
    }
    
    if (frequenciaFilter !== 'todas') {
        preventivas = preventivas.filter(r => r.frequencia === frequenciaFilter);
    }
    
    // Calcular data limite baseada no per√≠odo
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    let dataLimite = new Date();
    
    switch(periodoFilter) {
        case 'mes':
            dataLimite.setMonth(dataLimite.getMonth() + 1);
            break;
        case '3meses':
            dataLimite.setMonth(dataLimite.getMonth() + 3);
            break;
        case '6meses':
            dataLimite.setMonth(dataLimite.getMonth() + 6);
            break;
        case 'ano':
            dataLimite.setFullYear(dataLimite.getFullYear() + 1);
            break;
    }
    
    // ‚úÖ v3.7.0.8: Calcular pr√≥xima interven√ß√£o e ordenar por urg√™ncia
    preventivas = preventivas.map(p => {
        const proximaData = calcularProximaIntervencao(p.dataPrimeiraIntervencao, p.frequencia);
        const diasRestantes = proximaData ? Math.ceil((proximaData - hoje) / (1000 * 60 * 60 * 24)) : 999999;
        
        return {
            ...p,
            proximaData,
            diasRestantes
        };
    }).sort((a, b) => {
        // Ordenar por dias restantes (mais urgente primeiro)
        return a.diasRestantes - b.diasRestantes;
    });
    
    console.log(`üìä ${preventivas.length} preventivas encontradas (per√≠odo: ${periodoFilter})`);
    
    // Renderizar lista
    if (preventivas.length === 0) {
        preventivasList.innerHTML = `
            <div class="empty-state" style="padding: 40px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 64px; height: 64px; margin: 0 auto 16px;">
                    <path d="M9 11l3 3L22 4"/>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
                <h3>Nenhuma manuten√ß√£o preventiva encontrada</h3>
                <p style="color: #666;">Ajuste os filtros ou crie novas manuten√ß√µes preventivas</p>
            </div>
        `;
        return;
    }
    
    // Agrupar por frequ√™ncia
    const porFrequencia = {};
    preventivas.forEach(p => {
        const freq = p.frequencia || '-';
        if (!porFrequencia[freq]) porFrequencia[freq] = [];
        porFrequencia[freq].push(p);
    });
    
    // Gerar HTML
    let html = '';
    
    // Cards de resumo
    const vencidas = preventivas.filter(p => p.diasRestantes < 0).length;
    const proximas = preventivas.filter(p => p.diasRestantes >= 0 && p.diasRestantes <= 7).length;
    
    html += `
        <div class="stats-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;">
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${preventivas.length}</div>
                <div style="opacity: 0.9;">Total de Preventivas</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f5576c 0%, #e74c3c 100%); color: white; padding: 20px; border-radius: 8px;">
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${vencidas}</div>
                <div style="opacity: 0.9;">‚ö†Ô∏è Atrasadas</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f39c12 0%, #f093fb 100%); color: white; padding: 20px; border-radius: 8px;">
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${proximas}</div>
                <div style="opacity: 0.9;">‚ö° Pr√≥x. 7 dias</div>
            </div>
        </div>
    `;
    
    // ‚úÖ v3.7.0.8: Listar ORDENADO por pr√≥xima interven√ß√£o
    html += `
        <div style="margin-bottom: 20px;">
            <h3 style="color: #2196F3; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #2196F3;">
                üìã Preventivas Ordenadas por Urg√™ncia
            </h3>
            <div style="display: grid; gap: 10px;">
    `;
    
    preventivas.forEach(p => {
        const prioridadeClass = p.prioridade === 'Alta' ? 'priority-alta' : 
                               p.prioridade === 'M√©dia' ? 'priority-media' : 'priority-baixa';
        const estadoClass = p.estado === 'Resolvido' ? 'estado-resolvido' : 
                          p.estado === 'Em curso' ? 'estado-em-curso' : 'estado-novo';
        
        // ‚úÖ v3.7.0.8: Indicador visual de urg√™ncia
        let indicadorUrgencia = '';
        let borderColor = '#ddd';
        
        if (p.proximaData) {
            if (p.diasRestantes === 0) {
                indicadorUrgencia = '<span style="color: #2ecc71; font-weight: bold; font-size: 0.875rem;">üìÖ HOJE</span>';
                borderColor = '#2ecc71';
            } else if (p.diasRestantes > 0 && p.diasRestantes <= 7) {
                indicadorUrgencia = `<span style="color: #f39c12; font-weight: bold; font-size: 0.875rem;">‚ö° Em ${p.diasRestantes} dias</span>`;
                borderColor = '#f39c12';
            } else if (p.diasRestantes < 0) {
                indicadorUrgencia = `<span style="color: #e74c3c; font-weight: bold; font-size: 0.875rem;">‚ö†Ô∏è Atrasada ${Math.abs(p.diasRestantes)} dias</span>`;
                borderColor = '#e74c3c';
            } else {
                indicadorUrgencia = `<span style="color: #666; font-size: 0.875rem;">Em ${p.diasRestantes} dias</span>`;
            }
        }
        
        html += `
            <div class="request-card" style="background: white; border-left: 4px solid ${borderColor}; border: 1px solid #ddd; border-left: 4px solid ${borderColor}; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s;" 
                 onclick="openRequestDetails('${p.id}')">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div>
                        <span class="badge ${prioridadeClass}" style="font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; margin-right: 8px;">
                            ${p.prioridade}
                        </span>
                        <span class="badge ${estadoClass}" style="font-size: 0.75rem; padding: 4px 8px; border-radius: 4px;">
                            ${p.estado}
                        </span>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #666; font-size: 0.875rem;">${p.empresa}</div>
                        <div style="color: #666; font-size: 0.75rem;">üìÖ ${p.frequencia}</div>
                    </div>
                </div>
                <div style="font-weight: 600; margin-bottom: 8px;">
                    ${p.areaEquipamento}${p.componente && p.componente !== '-' ? ' - ' + p.componente : ''}
                </div>
                <div style="color: #666; font-size: 0.875rem; margin-bottom: 8px;">
                    ${p.descricao.substring(0, 100)}${p.descricao.length > 100 ? '...' : ''}
                </div>
                ${p.proximaData ? `
                <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                    <strong style="font-size: 0.875rem;">Pr√≥xima Interven√ß√£o: ${p.proximaData.toLocaleDateString('pt-PT')}</strong>
                    <br>${indicadorUrgencia}
                </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #999;">
                    <span>üìÖ Criado: ${new Date(p.dataHora).toLocaleDateString('pt-PT')}</span>
                    <span>üë§ ${p.nome}</span>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
    `;
    
    preventivasList.innerHTML = html;
}

// ‚úÖ v3.7.0.9: Obter filtros do planeamento
function getPlanningFilters() {
    const filters = {
        tipo: Array.from(document.querySelectorAll('.planning-filter-tipo:checked')).map(cb => cb.value),
        prioridade: Array.from(document.querySelectorAll('.planning-filter-prioridade:checked')).map(cb => cb.value),
        estado: Array.from(document.querySelectorAll('.planning-filter-estado:checked')).map(cb => cb.value),
        empresa: Array.from(document.querySelectorAll('.planning-filter-empresa:checked')).map(cb => cb.value),
        equipamento: document.getElementById('planningFilterEquipamento')?.value || '',
        responsavel: document.getElementById('planningFilterResponsavel')?.value || '',
        tipoIntervencao: Array.from(document.querySelectorAll('.planning-filter-tipoIntervencao:checked')).map(cb => cb.value),
        urgente: Array.from(document.querySelectorAll('.planning-filter-urgente:checked')).map(cb => cb.value),
        paragemProducao: Array.from(document.querySelectorAll('.planning-filter-paragemProducao:checked')).map(cb => cb.value)
    };
    return filters;
}

// ‚úÖ v3.7.0.9: Aplicar filtros aos pedidos do planeamento
function applyPlanningFilters(requests) {
    const filters = getPlanningFilters();
    
    return requests.filter(request => {
        // Tipo
        const passaTipo = filters.tipo.length === 0 || filters.tipo.includes(request.tipo);
        
        // Prioridade
        const passaPrioridade = filters.prioridade.length === 0 || filters.prioridade.includes(request.prioridade);
        
        // Estado
        const passaEstado = filters.estado.length === 0 || filters.estado.includes(request.estado);
        
        // Empresa
        const passaEmpresa = filters.empresa.length === 0 || filters.empresa.includes(request.empresa);
        
        // Equipamento
        const equipamentoPedido = request.areaEquipamento || '';
        const passaEquipamento = !filters.equipamento || equipamentoPedido === filters.equipamento;
        
        // Respons√°vel (do planeamento)
        const responsavelPedido = AppState.planning.tasks[request.id]?.responsavel || '';
        const passaResponsavel = !filters.responsavel || responsavelPedido === filters.responsavel;
        
        // Tipo de Interven√ß√£o
        const passaTipoIntervencao = filters.tipoIntervencao.length === 0 || filters.tipoIntervencao.includes(request.tipoIntervencao);
        
        // Urgente
        const passaUrgente = filters.urgente.length === 0 || (filters.urgente.includes('true') && request.urgente);
        
        // Paragem Produ√ß√£o
        const passaParagem = filters.paragemProducao.length === 0 || (filters.paragemProducao.includes('true') && request.paragemProducao);
        
        return passaTipo && passaPrioridade && passaEstado && passaEmpresa && 
               passaEquipamento && passaResponsavel && passaTipoIntervencao && 
               passaUrgente && passaParagem;
    });
}

function renderPlanningGrid() {
    const grid = document.getElementById('planningGrid');
    
    // ‚úÖ VALIDA√á√ÉO: Verificar se startDate e endDate existem
    if (!AppState.planning.startDate || !AppState.planning.endDate) {
        console.warn('‚ö†Ô∏è Planning dates n√£o definidas, a inicializar...');
        AppState.planning.startDate = new Date();
        AppState.planning.endDate = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000); // +2 semanas
    }
    
    const dates = generateDateRange();
    const rangeText = `${formatDateShort(AppState.planning.startDate)} - ${formatDateShort(AppState.planning.endDate)}`;
    document.getElementById('planningRange').textContent = rangeText;
    
    // ‚úÖ v3.7.0.9: Aplicar filtros
    const allRequests = AppState.requests.filter(r => r.estado !== 'Resolvido');
    const activeTasks = applyPlanningFilters(allRequests);
    if (activeTasks.length === 0) {
        grid.innerHTML = `<tr><td colspan="${dates.length + 1}" style="text-align: center; padding: var(--spacing-xl);"><p>N√£o h√° ordens de trabalho ativas para planear.</p><p style="color: var(--color-text-secondary); font-size: 0.875rem;">Crie novas ordens na tab "Nova Ordem"</p></td></tr>`;
        return;
    }
    let html = '<thead><tr><th class="task-header">Ordem / Tarefa</th><th class="responsible-header">Respons√°vel</th><th class="hours-header">Horas</th>';
    dates.forEach(date => {
        const isWeekend = date.getDay() === 0 || date.getDay() === 6, weekendClass = isWeekend ? 'weekend' : '';
        const dayName = date.toLocaleDateString('pt-PT', { weekday: 'short' }), dayNum = date.getDate();
        const monthName = date.toLocaleDateString('pt-PT', { month: 'short' });
        html += `<th class="date-header ${weekendClass}" title="${formatDateLong2(date)}"><div>${dayName}</div><div>${dayNum} ${monthName}</div></th>`;
    });
    html += '</tr></thead><tbody>';
    activeTasks.forEach(task => {
        html += '<tr>';
        html += `<td class="task-cell"><div class="task-info"><div class="task-title">${task.descricao}</div><div class="task-meta"><span class="badge badge-tipo">${task.tipo}</span><span class="badge badge-prioridade ${task.prioridade.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '')}">${task.prioridade}</span>`;
        if (task.responsavel && task.responsavel !== '-') html += `<span class="task-responsible"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>${task.responsavel}</span>`;
        html += `</div></div></td>`;
        
        // ‚úÖ v3.7.0.8: Ler dados do PLANEAMENTO (n√£o da ordem de trabalho)
        const planningData = AppState.planning.tasks[task.id] || { responsavel: '', horasEstimadas: 0, diasAlocados: [] };
        const taskResponsavel = planningData.responsavel || task.responsavel || '';  // Fallback: pedido se n√£o tiver no planeamento
        const taskHours = planningData.horasEstimadas || task.horasEstimadas || '';  // Fallback: pedido se n√£o tiver no planeamento
        
        html += `<td class="responsible-cell">`;
        html += `<select class="responsible-select" data-task-id="${task.id}" onchange="updateTaskResponsible('${task.id}', this.value)">`;
        html += `<option value="">-</option>`;
        AppState.utilizadores.forEach(user => {
            const selected = taskResponsavel === user.nomeCompleto ? 'selected' : '';
            html += `<option value="${user.nomeCompleto}" ${selected}>${user.nomeCompleto}</option>`;
        });
        html += `</select></td>`;
        html += `<td class="hours-cell"><input type="number" class="hours-input" value="${taskHours}" min="0" step="0.5" placeholder="0" data-task-id="${task.id}" onchange="updateTaskHours('${task.id}', this.value)"></td>`;
        dates.forEach(date => {
            const dateKey = formatDateKey(date), allocationKey = `${task.id}-${dateKey}`;
            const isAllocated = AppState.planning.allocations[allocationKey] === true, isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const classes = ['date-cell'];
            if (isAllocated) classes.push('allocated');
            if (isWeekend) classes.push('weekend');
            html += `<td class="${classes.join(' ')}" data-task="${task.id}" data-date="${dateKey}" onclick="toggleAllocation('${task.id}', '${dateKey}')" title="Clique para alocar/desalocar"></td>`;
        });
        html += '</tr>';
    });
    html += '</tbody>';
    grid.innerHTML = html;
}
// ‚úÖ v3.7.0.8: Alternar aloca√ß√£o de dia + guardar em diasAlocados
function toggleAllocation(taskId, dateKey) {
    const allocationKey = `${taskId}-${dateKey}`;
    
    // Toggle na estrutura antiga (compatibilidade)
    if (AppState.planning.allocations[allocationKey]) {
        delete AppState.planning.allocations[allocationKey];
    } else {
        AppState.planning.allocations[allocationKey] = true;
    }
    
    // ‚úÖ NOVO: Atualizar estrutura nova
    if (!AppState.planning.tasks[taskId]) {
        AppState.planning.tasks[taskId] = {
            responsavel: '',
            horasEstimadas: 0,
            diasAlocados: []
        };
    }
    
    const diasArray = AppState.planning.tasks[taskId].diasAlocados;
    const index = diasArray.indexOf(dateKey);
    
    if (index > -1) {
        // Remover dia
        diasArray.splice(index, 1);
    } else {
        // Adicionar dia
        diasArray.push(dateKey);
    }
    
    renderPlanningGrid();
    savePlanningToStorage();
}
// ‚úÖ v3.7.0.8: Atualizar horas NO PLANEAMENTO (n√£o na ordem de trabalho)
async function updateTaskHours(taskId, hours) {
    // Inicializar objeto do task se n√£o existir
    if (!AppState.planning.tasks[taskId]) {
        AppState.planning.tasks[taskId] = {
            responsavel: '',
            horasEstimadas: 0,
            diasAlocados: []
        };
    }
    
    // Atualizar horas NO PLANEAMENTO
    AppState.planning.tasks[taskId].horasEstimadas = hours ? parseFloat(hours) : 0;
    savePlanningToStorage();
    
    // ‚úÖ Sincronizar com Supabase (tabela PLANEAMENTO, n√£o PEDIDOS)
    if (AppState.isOnline) {
        try {
            await syncSingleTask(taskId);
            console.log('‚úÖ Horas sincronizadas na tabela planeamento');
        } catch (error) {
            console.error('‚ùå Erro ao sincronizar horas:', error);
        }
    }
    
    showToast(`Horas atualizadas: ${hours || 0}h`, 'success');
}

// ‚úÖ v3.7.0.8: Atualizar respons√°vel NO PLANEAMENTO (n√£o na ordem de trabalho)
async function updateTaskResponsible(taskId, responsavel) {
    // Inicializar objeto do task se n√£o existir
    if (!AppState.planning.tasks[taskId]) {
        AppState.planning.tasks[taskId] = {
            responsavel: '',
            horasEstimadas: 0,
            diasAlocados: []
        };
    }
    
    // Atualizar respons√°vel NO PLANEAMENTO
    AppState.planning.tasks[taskId].responsavel = responsavel || '';
    savePlanningToStorage();
    
    // ‚úÖ Sincronizar com Supabase (tabela PLANEAMENTO, n√£o PEDIDOS)
    if (AppState.isOnline) {
        try {
            await syncSingleTask(taskId);
            console.log('‚úÖ Respons√°vel sincronizado na tabela planeamento');
        } catch (error) {
            console.error('‚ùå Erro ao sincronizar respons√°vel:', error);
        }
    }
    
    renderPlanningGrid();
    showToast(`Respons√°vel atualizado: ${responsavel || 'Nenhum'}`, 'success');
}
async function savePlanning() {
    savePlanningToStorage();
    if (AppState.isOnline) await syncPlanningWithGoogleSheets();  // ‚úÖ v3.7.0.8: AWAIT para garantir sync
    showToast('Planeamento salvo com sucesso!', 'success');
}
function savePlanningToStorage() { localStorage.setItem(CONFIG.STORAGE_KEYS.PLANNING, JSON.stringify(AppState.planning)); }
// ‚úÖ v3.7.0.8: Carregar planeamento do Supabase
async function loadPlanningFromSupabase() {
    if (!AppState.isOnline) {
        console.log('üì° Offline - planeamento n√£o carregado do Supabase');
        return;
    }
    
    try {
        console.log('üì• Carregando planeamento do Supabase...');
        
        const planningData = await window.SupabaseAPI.getPlaneamento();
        
        if (!planningData || planningData.length === 0) {
            console.log('‚ÑπÔ∏è Nenhum planeamento encontrado no Supabase');
            return;
        }
        
        // Converter dados do Supabase ‚Üí AppState.planning.tasks
        AppState.planning.tasks = {};
        
        planningData.forEach(p => {
            const taskId = p['Pedido ID'];
            const diasAlocados = p['Dias Alocados'] ? JSON.parse(p['Dias Alocados']) : [];
            
            AppState.planning.tasks[taskId] = {
                responsavel: p['Respons√°vel'] || '',
                horasEstimadas: parseFloat(p['Horas Estimadas']) || 0,
                diasAlocados: diasAlocados
            };
            
            // ‚úÖ Tamb√©m popular a estrutura antiga (allocations) para compatibilidade
            diasAlocados.forEach(dateKey => {
                const allocationKey = `${taskId}-${dateKey}`;
                AppState.planning.allocations[allocationKey] = true;
            });
        });
        
        console.log(`‚úÖ ${planningData.length} tasks carregados do planeamento`);
        savePlanningToStorage();  // Guardar localmente
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar planeamento do Supabase:', error);
    }
}

function loadPlanningFromStorage() {
    const saved = localStorage.getItem(CONFIG.STORAGE_KEYS.PLANNING);
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            AppState.planning.allocations = parsed.allocations || {};
            if (parsed.startDate) {
                AppState.planning.startDate = new Date(parsed.startDate);
                AppState.planning.endDate = new Date(parsed.endDate);
            }
        } catch (error) { console.error('Erro ao carregar planeamento:', error); }
    }
}
// ‚úÖ v3.7.0.8: Sincronizar um √∫nico task (quando alterar respons√°vel/horas)
async function syncSingleTask(taskId) {
    if (!AppState.isOnline) {
        console.log('‚ö†Ô∏è Offline - task n√£o sincronizado');
        return;
    }
    
    try {
        const task = AppState.requests.find(r => r.id === taskId);
        const planningData = AppState.planning.tasks[taskId];
        
        if (!task || !planningData) {
            console.warn('‚ö†Ô∏è Task ou planning data n√£o encontrado:', taskId);
            return;
        }
        
        // Buscar se j√° existe registo para este pedido
        const existing = await window.SupabaseAPI.getPlaneamento();
        const existingTask = existing.find(p => p['Pedido ID'] === taskId);
        
        const supabaseData = {
            'Pedido ID': taskId,
            'Descri√ß√£o': task.descricao,
            'Tipo': task.tipo,
            'Prioridade': task.prioridade,
            'Empresa': task.empresa,
            'Respons√°vel': planningData.responsavel || '',
            'Horas Estimadas': planningData.horasEstimadas || 0,
            'Dias Alocados': JSON.stringify(planningData.diasAlocados || []),
            '√öltima Atualiza√ß√£o': new Date().toISOString()
        };
        
        if (existingTask) {
            // Atualizar existente
            await window.SupabaseAPI.updatePlaneamento(existingTask.ID, supabaseData);
            console.log('‚úÖ Task atualizado no Supabase:', taskId);
        } else {
            // Criar novo
            await window.SupabaseAPI.addPlaneamento(supabaseData);
            console.log('‚úÖ Task criado no Supabase:', taskId);
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao sincronizar task:', error);
        throw error;
    }
}

// üî• v3.7.0.8: Guardar planeamento completo no Supabase
async function syncPlanningWithGoogleSheets() {
    if (!AppState.isOnline) {
        console.log('‚ö†Ô∏è Offline - planeamento n√£o sincronizado');
        return;
    }
    
    try {
        console.log('üîÑ Sincronizando planeamento completo com Supabase...');
        console.log('üìä AppState.planning.tasks:', AppState.planning.tasks);
        
        // Buscar planeamentos existentes
        const existingPlanning = await window.SupabaseAPI.getPlaneamento();
        console.log('üì• Planeamentos existentes no Supabase:', existingPlanning.length);
        
        // Preparar dados para guardar (da NOVA estrutura)
        const tasksToSync = [];
        
        Object.keys(AppState.planning.tasks).forEach(taskId => {
            const task = AppState.requests.find(r => r.id === taskId);
            const planningData = AppState.planning.tasks[taskId];
            
            if (!task) {
                console.error(`‚ùå Task ${taskId} n√£o encontrado em AppState.requests!`);
                return;
            }
            
            if (!planningData) {
                console.warn(`‚ö†Ô∏è Task ${taskId} sem planningData!`);
                return;
            }
            
            // ‚úÖ SEMPRE guardar se o objeto existir (mesmo vazio)
            const responsavel = planningData.responsavel || '';
            const horas = planningData.horasEstimadas || 0;
            const dias = planningData.diasAlocados || [];
            
            console.log(`üîç Task ${taskId}:`, { 
                responsavel: responsavel || '(vazio)',
                horas: horas,
                dias: dias.length
            });
            
            tasksToSync.push({
                taskId,
                data: {
                    'Pedido ID': taskId,
                    'Descri√ß√£o': task.descricao,
                    'Tipo': task.tipo,
                    'Prioridade': task.prioridade,
                    'Empresa': task.empresa,
                    'Respons√°vel': responsavel,
                    'Horas Estimadas': horas,
                    'Dias Alocados': JSON.stringify(dias),
                    '√öltima Atualiza√ß√£o': new Date().toISOString()
                }
            });
        });
        
        console.log(`üì¶ Total de tasks em AppState.planning.tasks: ${Object.keys(AppState.planning.tasks).length}`);
        console.log(`üì¶ Tasks V√ÅLIDOS para sincronizar: ${tasksToSync.length}`);
        
        if (tasksToSync.length > 0) {
            tasksToSync.forEach(t => {
                console.log(`  ‚ûú ${t.taskId.substring(0, 8)}...: ${t.data['Respons√°vel'] || '(sem)'} | ${t.data['Horas Estimadas']}h | ${JSON.parse(t.data['Dias Alocados']).length} dias`);
            });
        }
        
        if (tasksToSync.length === 0) {
            console.warn('‚ö†Ô∏è Nenhum task para sincronizar!');
            console.warn('‚ö†Ô∏è Verifica se definiste respons√°vel, horas ou marcaste dias');
            return;  // ‚úÖ N√ÉO mostrar toast de erro, apenas return
        }
        
        // Limpar planeamentos antigos que j√° n√£o existem
        for (const existing of existingPlanning) {
            const stillExists = tasksToSync.find(t => t.taskId === existing['Pedido ID']);
            if (!stillExists) {
                await window.SupabaseAPI.deletePlaneamento(existing.ID);
                console.log('üóëÔ∏è Planeamento removido:', existing['Pedido ID']);
            }
        }
        
        // Inserir/Atualizar planeamentos
        for (const taskData of tasksToSync) {
            const existingTask = existingPlanning.find(p => p['Pedido ID'] === taskData.taskId);
            
            if (existingTask) {
                // Atualizar
                console.log('üîÑ Atualizando task:', taskData.taskId);
                await window.SupabaseAPI.updatePlaneamento(existingTask.ID, taskData.data);
            } else {
                // Criar novo
                console.log('‚ûï Criando novo task:', taskData.taskId);
                await window.SupabaseAPI.addPlaneamento(taskData.data);
            }
        }
        
        console.log(`‚úÖ ${tasksToSync.length} tasks sincronizados com Supabase`);
        showToast('Planeamento guardado com sucesso!', 'success');
        
    } catch (error) {
        console.error('‚ùå Erro ao sincronizar planeamento:', error);
        console.error('‚ùå Stack:', error.stack);
        showToast('Erro ao guardar planeamento: ' + error.message, 'error');
    }
}
function exportPlanningToExcel() {
    if (AppState.requests.length === 0) { showToast('N√£o h√° dados para exportar.', 'info'); return; }
    try {
        const dates = generateDateRange(), activeTasks = AppState.requests.filter(r => r.estado !== 'Resolvido');
        const requestsData = AppState.requests.map(request => ({ 'ID': request.id, 'Data/Hora': formatDateLong(request.dataHora), 'Tipo': request.tipo, 'Prioridade': request.prioridade, 'Estado': request.estado, 'Departamento': request.departamento, 'Respons√°vel': request.responsavel || '-', 'Descri√ß√£o': request.descricao, 'Registado por': request.nome, 'Tem Foto': request.foto ? 'Sim' : 'N√£o' }));
        const planningData = [];
        activeTasks.forEach(task => {
            const row = { 'Pedido ID': task.id, 'Descri√ß√£o': task.descricao, 'Tipo': task.tipo, 'Prioridade': task.prioridade, 'Respons√°vel': task.responsavel || '-', 'Horas Estimadas': task.horasEstimadas || 0 };
            dates.forEach(date => {
                const dateKey = formatDateKey(date), allocationKey = `${task.id}-${dateKey}`, dayLabel = `${date.getDate()}/${date.getMonth() + 1}`;
                row[dayLabel] = AppState.planning.allocations[allocationKey] ? 'X' : '';
            });
            planningData.push(row);
        });
        const wb = XLSX.utils.book_new();
        const ws1 = XLSX.utils.json_to_sheet(requestsData);
        ws1['!cols'] = [{ wch: 36 }, { wch: 20 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 20 }, { wch: 50 }, { wch: 20 }, { wch: 10 }];
        XLSX.utils.book_append_sheet(wb, ws1, "Pedidos de Manuten√ß√£o");
        if (planningData.length > 0) {
            const ws2 = XLSX.utils.json_to_sheet(planningData);
            const cols = [{ wch: 36 }, { wch: 50 }, { wch: 12 }, { wch: 12 }, { wch: 20 }, { wch: 12 }];
            dates.forEach(() => cols.push({ wch: 8 }));
            ws2['!cols'] = cols;
            XLSX.utils.book_append_sheet(wb, ws2, "Planeamento");
        }
        const fileName = `Manutencao_Completo_${formatDateForFilename()}.xlsx`;
        XLSX.writeFile(wb, fileName, { bookType: 'xlsx' });
        showToast('Excel exportado com sucesso!', 'success');
    } catch (error) { console.error('Erro ao exportar:', error); showToast('Erro ao exportar Excel.', 'error'); }
}
function formatDateKey(date) {
    const year = date.getFullYear(), month = String(date.getMonth() + 1).padStart(2, '0'), day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}
function formatDateShort(date) { return date.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric' }); }
function formatDateLong2(date) { return date.toLocaleDateString('pt-PT', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }); }

// MANUTEN√á√ïES AUT√ìNOMAS
// ‚ùå REMOVIDO v3.7.2.2: Fun√ß√µes relacionadas com tab "Aut√≥nomas MCF" (removida)
/*
function initializeAutonomousMaintenance() {
    const machineSelect = document.getElementById('machineSelect');
    const closePdfBtn = document.getElementById('closePdfBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const printPdfBtn = document.getElementById('printPdfBtn');
    const openOneDriveBtn = document.getElementById('openOneDriveBtn');
    
    machineSelect.addEventListener('change', function() {
        const machineKey = this.value;
        if (!machineKey) { hidePdfViewer(); return; }
        const machine = CONFIG.MACHINES[machineKey];
        if (!machine) { showToast('M√°quina n√£o encontrada.', 'error'); return; }
        loadPdfForMachine(machineKey, machine);
    });
    
    closePdfBtn.addEventListener('click', function() { hidePdfViewer(); machineSelect.value = ''; });
    downloadPdfBtn.addEventListener('click', function() { if (currentMachine) { window.open(currentMachine.url, '_blank'); showToast('Abrindo download...', 'info'); } });
    printPdfBtn.addEventListener('click', function() {
        if (currentMachine) {
            try {
                const iframe = document.getElementById('pdfIframe');
                iframe.contentWindow.print();
            } catch (error) {
                const printWindow = window.open(currentMachine.embedUrl, '_blank');
                if (printWindow) printWindow.onload = function() { printWindow.print(); };
            }
        }
    });
    openOneDriveBtn.addEventListener('click', function() { if (currentMachine) { window.open(currentMachine.url, '_blank'); showToast('Abrindo no OneDrive...', 'info'); } });
}

function loadPdfForMachine(machineKey, machine) {
    const pdfActions = document.getElementById('pdfActions');
    const pdfViewerContainer = document.getElementById('pdfViewerContainer');
    const pdfEmptyState = document.getElementById('pdfEmptyState');
    const pdfIframe = document.getElementById('pdfIframe');
    const pdfTitle = document.getElementById('pdfTitle');
    const pdfViewer = document.querySelector('.pdf-viewer');
    currentMachine = machine;
    pdfViewer.classList.add('loading');
    pdfEmptyState.style.display = 'none';
    pdfActions.style.display = 'flex';
    pdfViewerContainer.style.display = 'block';
    pdfTitle.textContent = `Procedimento: ${machine.name}`;
    pdfIframe.src = machine.embedUrl;
    setTimeout(() => { pdfViewer.classList.remove('loading'); }, 2000);
    setTimeout(() => { pdfViewerContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 300);
    showToast(`Carregando: ${machine.name}`, 'info');
}

function hidePdfViewer() {
    const pdfActions = document.getElementById('pdfActions');
    const pdfViewerContainer = document.getElementById('pdfViewerContainer');
    const pdfEmptyState = document.getElementById('pdfEmptyState');
    const pdfIframe = document.getElementById('pdfIframe');
    const pdfViewer = document.querySelector('.pdf-viewer');
    currentMachine = null;
    pdfIframe.src = '';
    pdfViewer.classList.remove('loading');
    pdfActions.style.display = 'none';
    pdfViewerContainer.style.display = 'none';
    pdfEmptyState.style.display = 'flex';
}
*/

// ============================================
// ============================================
// M√ìDULO DE GEST√ÉO DE STOCK
// ============================================

// ============================================
// üìç M√ìDULO DE ZONAS (v3.7.2.4)
// ============================================

let zonasCache = [];

/**
 * Carregar zonas do Supabase e popular o dropdown
 */
async function carregarZonas() {
    try {
        console.log('üìç Carregando zonas do Supabase...');
        
        // Buscar zonas ativas do Supabase
        const response = await fetch(`${SUPABASE_CONFIG.URL}/rest/v1/zonas?ativa=eq.true&order=nome.asc`, {
            headers: {
                'apikey': SUPABASE_CONFIG.ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`Erro ao carregar zonas: ${response.status}`);
        }
        
        const zonas = await response.json();
        zonasCache = zonas;
        
        console.log(`‚úÖ ${zonas.length} zonas carregadas:`, zonas.map(z => z.nome));
        
        // Popular dropdown
        const zonaSelect = document.getElementById('zona');
        if (zonaSelect) {
            // Limpar op√ß√µes antigas (exceto a primeira)
            zonaSelect.innerHTML = '<option value="">Selecione a zona da casa</option>';
            
            // Adicionar zonas
            zonas.forEach(zona => {
                const option = document.createElement('option');
                option.value = zona.id;
                option.textContent = `${zona.icone} ${zona.nome}`;
                option.dataset.zonaNome = zona.nome;
                zonaSelect.appendChild(option);
            });
            
            console.log('‚úÖ Dropdown de zonas populado');
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar zonas:', error);
        showToast('‚ö†Ô∏è Erro ao carregar zonas. Usando modo offline.', 'warning');
        
        // Fallback: zonas offline
        zonasCache = [
            { id: 1, nome: 'Cozinha', icone: 'üç≥' },
            { id: 2, nome: 'Sala', icone: 'üõãÔ∏è' },
            { id: 3, nome: 'Quarto', icone: 'üõèÔ∏è' },
            { id: 4, nome: 'Casa de Banho', icone: 'üöø' },
            { id: 5, nome: 'Garagem', icone: 'üöó' },
            { id: 6, nome: 'Jardim', icone: 'üå≥' },
            { id: 10, nome: 'Geral', icone: 'üè†' }
        ];
        
        // Popular com dados offline
        const zonaSelect = document.getElementById('zona');
        if (zonaSelect) {
            zonaSelect.innerHTML = '<option value="">Selecione a zona da casa</option>';
            zonasCache.forEach(zona => {
                const option = document.createElement('option');
                option.value = zona.id;
                option.textContent = `${zona.icone} ${zona.nome}`;
                option.dataset.zonaNome = zona.nome;
                zonaSelect.appendChild(option);
            });
        }
    }
}

/**
 * Obter nome da zona pelo ID
 */
function getZonaNome(zonaId) {
    const zona = zonasCache.find(z => z.id === parseInt(zonaId));
    return zona ? zona.nome : 'Desconhecida';
}

// ============================================
// SINCRONIZA√á√ÉO COM GOOGLE SHEETS
// ============================================

// ‚ö° CACHE DE ARTIGOS (24h)
function getCachedArtigos() {
    try {
        const cached = localStorage.getItem('artigos_cache');
        const cacheTime = localStorage.getItem('artigos_cache_time');
        
        if (cached && cacheTime) {
            const age = Date.now() - parseInt(cacheTime);
            const maxAge = 24 * 60 * 60 * 1000; // 24 horas
            
            if (age < maxAge) {
                console.log('‚ö° Usando artigos do cache (idade: ' + (age / 1000 / 60).toFixed(0) + ' min)');
                return JSON.parse(cached);
            }
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è Erro ao ler cache:', error);
    }
    return null;
}

function setCachedArtigos(artigos) {
    try {
        localStorage.setItem('artigos_cache', JSON.stringify(artigos));
        localStorage.setItem('artigos_cache_time', Date.now().toString());
        console.log('üíæ Artigos guardados em cache para 24h');
    } catch (error) {
        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel guardar cache:', error);
    }
}

// üî• v3.6.13: Carregar artigos do Supabase (com cache e retry)
async function loadArtigosFromGoogleSheets(retryCount = 0, forceReload = false) {
    if (!AppState.isOnline) {
        console.log('‚ö†Ô∏è Offline - usando dados locais');
        // Carregar do cache se estiver offline
        const cached = getCachedArtigos();
        if (cached && cached.length > 0) {
            AppState.artigos = cached;
            console.log('‚ö° Artigos carregados do cache:', cached.length);
            hideLoadingSpinner();
        }
        return;
    }
    
    // ‚ö° TENTAR CACHE PRIMEIRO (se n√£o for reload for√ßado)
    if (!forceReload) {
        const cached = getCachedArtigos();
        if (cached && cached.length > 0) {
            AppState.artigos = cached;
            console.log('‚ö° Artigos carregados do cache:', cached.length);
            hideLoadingSpinner();
            return;
        }
    }
    
    // ‚ö° MOSTRAR LOADING SPINNER
    if (retryCount === 0) {
        showLoadingSpinner('Carregando artigos do Supabase...');
    }
    
    try {
        console.log('üîÑ Carregando artigos do Supabase... (tentativa ' + (retryCount + 1) + ')');
        
        const artigos = await window.SupabaseAPI.getArtigos();
        
        if (artigos && artigos.length > 0) {
            AppState.artigos = artigos.map(a => ({
                id: a.ID,
                codigo: a.ID,
                familia: a.Fam√≠lia,
                designacao: a.Designa√ß√£o,
                referencia: a.Refer√™ncia,
                fornecedor: a.Fornecedor,
                preco: parseFloat(a['Pre√ßo Unit√°rio']) || 0,
                stockMinimo: parseInt(a['Stock M√≠nimo']) || 0,
                empresa: a.Empresa,
                unidade: a.Unidade
            }));
            
            setCachedArtigos(AppState.artigos);
            console.log('‚úÖ Artigos carregados do Supabase:', AppState.artigos.length);
            
            hideLoadingSpinner();
            showToast(`‚úÖ ${AppState.artigos.length} artigos carregados com sucesso!`, 'success');
            
            // Atualizar interface se j√° estiver no tab stock
            const stockTab = document.getElementById('tab-stock');
            if (stockTab && stockTab.classList.contains('active')) {
                const searchInput = document.getElementById('stockSearchInput');
                if (searchInput && searchInput.value.length >= 2) {
                    searchArtigos(searchInput.value);
                }
            }
        } else {
            console.error('‚ùå ERRO: Nenhum artigo no Supabase!');
            
            // Retry autom√°tico (m√°ximo 2 tentativas)
            if (retryCount < 2) {
                console.warn('‚ö†Ô∏è Tentando novamente em 2 segundos...');
                setTimeout(() => loadArtigosFromGoogleSheets(retryCount + 1), 2000);
            } else {
                AppState.artigos = [];
                hideLoadingSpinner();
                showToast('‚ùå Nenhum artigo encontrado. Verifique o Supabase.', 'error');
            }
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar artigos do Supabase:', error);
        
        // Retry autom√°tico em caso de erro de rede (m√°ximo 2 tentativas)
        if (retryCount < 2) {
            console.warn('‚ö†Ô∏è Tentando novamente em 2 segundos...');
            setTimeout(() => loadArtigosFromGoogleSheets(retryCount + 1), 2000);
        } else {
            AppState.artigos = [];
            hideLoadingSpinner();
            showToast('‚ùå Erro ao conectar com Supabase. Verifique a configura√ß√£o.', 'error');
        }
    }
}

// üî• v3.6.14: Carregar movimentos do Supabase
async function loadMovimentosFromGoogleSheets() {
    // ‚ö†Ô∏è Nome mantido para compatibilidade, mas usa Supabase
    if (!AppState.isOnline) {
        console.log('‚ö†Ô∏è Offline - usando dados locais');
        return;
    }
    
    try {
        console.log('üîÑ Carregando movimentos do Supabase...');
        const movimentos = await window.SupabaseAPI.getMovimentos();
        
        if (movimentos && movimentos.length > 0) {
            AppState.movimentos = movimentos.map(m => ({
                id: m.ID,
                dataHora: new Date(m['Data/Hora']),
                artigoId: m['Artigo ID'],
                tipo: m.Tipo,
                quantidade: parseInt(m.Quantidade) || 0,
                pedidoId: m['Pedido ID'],
                responsavel: m.Respons√°vel,
                observacoes: m.Observa√ß√µes,
                empresa: m.Empresa
            }));
            
            // Ordenar por data (mais recentes primeiro)
            AppState.movimentos.sort((a, b) => b.dataHora - a.dataHora);
            
            console.log('‚úÖ Movimentos carregados:', AppState.movimentos.length);
        } else {
            console.warn('‚ö†Ô∏è Nenhum movimento no Supabase');
            AppState.movimentos = [];
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar movimentos:', error);
        AppState.movimentos = [];
    }
}

// üî• v3.6.16: Sincronizar movimento com Supabase (CORRIGIDO)
async function syncMovimentoToGoogleSheets(movimento) {
    // ‚ö†Ô∏è Nome mantido para compatibilidade, mas usa Supabase
    if (!AppState.isOnline) {
        console.log('‚ö†Ô∏è Offline - movimento ser√° sincronizado depois');
        addToOfflineQueue({action: 'createMovimento', movimento: movimento});
        return null;
    }
    
    try {
        console.log('üîÑ Sincronizando movimento com Supabase...');
        
        // Converter formato app ‚Üí formato Supabase
        const quantidadeParaSupabase = (movimento.tipo === 'Sa√≠da' || movimento.tipo === 'Baixa') 
            ? -Math.abs(movimento.quantidade)  // ‚úÖ Sa√≠da/Baixa = negativo
            : Math.abs(movimento.quantidade);   // ‚úÖ Entrada = positivo
        
        const supabaseMovimento = {
            'ID': movimento.id || 'MOV' + Date.now(),
            'Data/Hora': movimento.dataHora ? new Date(movimento.dataHora).toISOString() : new Date().toISOString(),
            'Artigo ID': movimento.artigoId || '',
            'Tipo': movimento.tipo || '',
            'Quantidade': String(quantidadeParaSupabase),  // ‚úÖ Negativo para Sa√≠da/Baixa
            'Pedido ID': movimento.pedidoId || '',
            'Respons√°vel': movimento.responsavel || '',
            'Observa√ß√µes': movimento.observacoes || '',
            'Empresa': movimento.empresa || 'MCF'
        };
        
        // ‚úÖ CORRE√á√ÉO 2: Debug detalhado
        console.log('üì§ Movimento a enviar:', JSON.stringify(supabaseMovimento, null, 2));
        
        const result = await window.SupabaseAPI.addMovimento(supabaseMovimento);
        console.log('‚úÖ Movimento guardado no Supabase:', result);
        
        // Recarregar movimentos para atualizar interface
        setTimeout(() => {
            loadMovimentosFromGoogleSheets();
            renderStockMinimo(); // ‚úÖ Atualizar alertas de stock
        }, 1000);
        
        return movimento.id;
    } catch (error) {
        console.error('‚ùå Erro ao sincronizar movimento:', error);
        addToOfflineQueue({action: 'createMovimento', movimento: movimento});
        showToast('Erro ao guardar movimento', 'error');
        return null;
    }
}

// ============================================
// INICIALIZA√á√ÉO DO M√ìDULO
// ============================================

// ============================================
// üõí M√ìDULO DE LISTA DE COMPRAS
// ============================================

let listaCompras = [];

// Carregar lista de compras do localStorage
function carregarListaCompras() {
    const saved = localStorage.getItem('listaCompras');
    if (saved) {
        listaCompras = JSON.parse(saved);
    }
    renderizarListaCompras();
}

// Salvar lista no localStorage
function salvarListaCompras() {
    localStorage.setItem('listaCompras', JSON.stringify(listaCompras));
}

// Adicionar item
function adicionarItemCompras(nome) {
    if (!nome || nome.trim() === '') return;
    
    const novoItem = {
        id: Date.now(),
        nome: nome.trim(),
        comprado: false,
        dataAdicao: new Date().toISOString()
    };
    
    listaCompras.push(novoItem);
    salvarListaCompras();
    renderizarListaCompras();
    showToast('‚úÖ Item adicionado √† lista', 'success');
}

// Marcar como comprado/n√£o comprado
function toggleItemComprado(id) {
    const item = listaCompras.find(i => i.id === id);
    if (item) {
        item.comprado = !item.comprado;
        salvarListaCompras();
        renderizarListaCompras();
    }
}

// Remover item espec√≠fico
function removerItemCompras(id) {
    listaCompras = listaCompras.filter(i => i.id !== id);
    salvarListaCompras();
    renderizarListaCompras();
    showToast('üóëÔ∏è Item removido', 'info');
}

// Limpar itens comprados
function limparComprasCompletas() {
    const naoComprados = listaCompras.filter(i => !i.comprado);
    const totalRemovidos = listaCompras.length - naoComprados.length;
    
    if (totalRemovidos === 0) {
        showToast('‚ÑπÔ∏è Nenhum item comprado para limpar', 'info');
        return;
    }
    
    if (confirm(`Remover ${totalRemovidos} item(ns) j√° comprado(s)?`)) {
        listaCompras = naoComprados;
        salvarListaCompras();
        renderizarListaCompras();
        showToast(`‚úÖ ${totalRemovidos} item(ns) removido(s)`, 'success');
    }
}

// Reset completo da lista
function resetarTodasCompras() {
    if (listaCompras.length === 0) {
        showToast('‚ÑπÔ∏è A lista j√° est√° vazia', 'info');
        return;
    }
    
    if (confirm(`Apagar TODOS os ${listaCompras.length} itens da lista?`)) {
        listaCompras = [];
        salvarListaCompras();
        renderizarListaCompras();
        showToast('üóëÔ∏è Lista de compras limpa', 'success');
    }
}

// Renderizar lista
function renderizarListaCompras() {
    const container = document.getElementById('listaCompras');
    const emptyState = document.getElementById('comprasEmptyState');
    
    if (listaCompras.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'flex';
        return;
    }
    
    container.style.display = 'flex';
    emptyState.style.display = 'none';
    
    // Ordenar: n√£o comprados primeiro
    const ordenados = [...listaCompras].sort((a, b) => {
        if (a.comprado === b.comprado) return 0;
        return a.comprado ? 1 : -1;
    });
    
    container.innerHTML = ordenados.map(item => `
        <div style="
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: ${item.comprado ? '#f5f5f7' : '#fff'};
            border: 1px solid ${item.comprado ? '#e5e5e7' : '#d1d1d6'};
            border-radius: 8px;
            transition: all 0.2s;
            ${item.comprado ? 'opacity: 0.6;' : ''}
        ">
            <input 
                type="checkbox" 
                ${item.comprado ? 'checked' : ''} 
                onchange="toggleItemComprado(${item.id})"
                style="width: 20px; height: 20px; cursor: pointer; accent-color: #34C759;"
            >
            <span style="
                flex: 1;
                font-size: 1rem;
                color: ${item.comprado ? '#86868b' : '#1d1d1f'};
                text-decoration: ${item.comprado ? 'line-through' : 'none'};
            ">
                ${item.nome}
            </span>
            <button 
                onclick="removerItemCompras(${item.id})" 
                style="
                    background: none;
                    border: none;
                    color: #ff3b30;
                    cursor: pointer;
                    padding: 4px 8px;
                    font-size: 18px;
                "
                title="Remover item"
            >
                üóëÔ∏è
            </button>
        </div>
    `).join('');
}

// Inicializar m√≥dulo de compras
function initializeComprasModule() {
    carregarListaCompras();
    
    // Event listener para o formul√°rio
    const form = document.getElementById('comprasForm');
    if (form) {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('novoItemCompras');
            if (input && input.value.trim()) {
                adicionarItemCompras(input.value);
                input.value = '';
                input.focus();
            }
        });
    }
}

// ============================================
// üìù M√ìDULO DE TAREFAS - UPLOAD DE FOTOS
// ============================================

let currentTarefaPhoto = null;

// ‚úÖ v3.7.2.18: Fun√ß√£o de compress√£o de imagem para tarefas
function compressTarefaImage(file, maxWidth = 800, quality = 0.8) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            const img = new Image();
            
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Redimensionar se necess√°rio
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Converter para base64
                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                resolve(dataUrl);
            };
            
            img.onerror = () => {
                reject(new Error('Erro ao carregar imagem'));
            };
            
            img.src = e.target.result;
        };
        
        reader.onerror = () => {
            reject(new Error('Erro ao ler ficheiro'));
        };
        
        reader.readAsDataURL(file);
    });
}

function handleTarefaImage(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validar tipo
    if (!file.type.startsWith('image/')) {
        showToast('‚ùå Por favor selecione uma imagem.', 'error');
        event.target.value = '';
        return;
    }
    
    // Validar tamanho (m√°x 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showToast('‚ùå Imagem muito grande! M√°ximo 5MB.', 'error');
        event.target.value = '';
        return;
    }
    
    // Atualizar nome do ficheiro
    const fileNameEl = document.getElementById('fileName');
    if (fileNameEl) {
        fileNameEl.textContent = file.name;
    }
    
    // Comprimir e preview
    compressTarefaImage(file, 800, 0.8).then(dataUrl => {
        currentTarefaPhoto = dataUrl;
        showTarefaPreview(dataUrl);
        showToast('‚úÖ Imagem carregada e comprimida!', 'success');
    }).catch(error => {
        console.error('Erro ao processar imagem:', error);
        showToast('‚ùå Erro ao processar imagem.', 'error');
        event.target.value = '';
        currentTarefaPhoto = null;
        if (fileNameEl) {
            fileNameEl.textContent = 'Escolher imagem';
        }
    });
}

function showTarefaPreview(dataUrl) {
    const preview = document.getElementById('imagePreview');
    if (!preview) return;
    
    preview.innerHTML = `
        <img src="${dataUrl}" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 8px;">
        <button type="button" class="remove-image" onclick="clearTarefaPreview()" style="
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(255, 59, 48, 0.9);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            color: white;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        ">√ó</button>
    `;
    preview.style.position = 'relative';
}

function clearTarefaPreview() {
    const preview = document.getElementById('imagePreview');
    if (preview) {
        preview.innerHTML = '';
    }
    
    const fotoInput = document.getElementById('foto');
    if (fotoInput) {
        fotoInput.value = '';
    }
    
    const fileNameEl = document.getElementById('fileName');
    if (fileNameEl) {
        fileNameEl.textContent = 'Escolher imagem';
    }
    
    currentTarefaPhoto = null;
}

// ============================================
// üìÑ M√ìDULO DE DOCUMENTOS
// ============================================

let listaDocumentos = [];
let filtroDocumentoAtivo = '';

// Carregar documentos do localStorage
function carregarDocumentos() {
    const saved = localStorage.getItem('listaDocumentos');
    if (saved) {
        listaDocumentos = JSON.parse(saved);
    }
    
    // ‚úÖ S√≥ renderizar se os elementos existirem
    if (document.getElementById('documentosLista')) {
        renderizarDocumentos();
    } else {
        console.log('‚ö†Ô∏è Tab Documentos vazia - pulando renderiza√ß√£o');
    }
}

// Salvar documentos no localStorage
function salvarDocumentos() {
    localStorage.setItem('listaDocumentos', JSON.stringify(listaDocumentos));
}

// Adicionar documento
function adicionarDocumento(dados) {
    // Gerar ID sequencial DOC_XXXXX
    const proximoId = listaDocumentos.length > 0 
        ? Math.max(...listaDocumentos.map(d => parseInt(d.id.split('_')[1]))) + 1 
        : 1;
    const docId = `DOC_${String(proximoId).padStart(5, '0')}`;
    
    const novoDoc = {
        id: docId,
        tipo: dados.tipo,
        titulo: dados.titulo,
        descricao: dados.descricao || '',
        foto: dados.foto || '',
        dataValidade: dados.dataValidade || '',
        dataAdicao: new Date().toISOString()
    };
    
    listaDocumentos.unshift(novoDoc);  // Adicionar no in√≠cio
    salvarDocumentos();
    renderizarDocumentos();
    showToast('‚úÖ Documento adicionado com sucesso', 'success');
    
    // ‚úÖ Ir para a tab Documentos ap√≥s criar
    setTimeout(() => {
        const btnDocumentos = document.querySelector('.tab-btn[data-tab="analise"]');
        if (btnDocumentos) {
            btnDocumentos.click();
        }
    }, 500);
}

// Abrir/Ver documento
function abrirDocumento(id) {
    const doc = listaDocumentos.find(d => d.id === id);
    if (!doc) return;
    
    const dataAdicao = new Date(doc.dataAdicao).toLocaleDateString('pt-PT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const dataValidade = doc.dataValidade ? new Date(doc.dataValidade).toLocaleDateString('pt-PT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    }) : 'Sem validade';
    
    const vencido = doc.dataValidade && new Date(doc.dataValidade) < new Date();
    
    let html = `
        <div style="display: grid; gap: 16px;">
            <div>
                <p style="color: #86868b; font-size: 0.875rem; margin-bottom: 4px;">ID do Documento</p>
                <p style="font-weight: 600; font-size: 1.1rem;">${doc.id}</p>
            </div>
            
            <div>
                <p style="color: #86868b; font-size: 0.875rem; margin-bottom: 4px;">Tipo</p>
                <p style="font-weight: 600;">${getTipoIcon(doc.tipo)} ${doc.tipo}</p>
            </div>
            
            <div>
                <p style="color: #86868b; font-size: 0.875rem; margin-bottom: 4px;">T√≠tulo</p>
                <p style="font-weight: 600; font-size: 1.1rem;">${doc.titulo}</p>
            </div>
            
            ${doc.descricao ? `
                <div>
                    <p style="color: #86868b; font-size: 0.875rem; margin-bottom: 4px;">Descri√ß√£o/Notas</p>
                    <p style="line-height: 1.6;">${doc.descricao}</p>
                </div>
            ` : ''}
            
            <div>
                <p style="color: #86868b; font-size: 0.875rem; margin-bottom: 4px;">Validade</p>
                <p style="font-weight: 600; color: ${vencido ? '#ff3b30' : '#34c759'};">
                    ${vencido ? '‚ö†Ô∏è Vencido em' : dataValidade === 'Sem validade' ? 'üìã Sem validade' : '‚úÖ V√°lido at√©'} ${dataValidade}
                </p>
            </div>
            
            <div>
                <p style="color: #86868b; font-size: 0.875rem; margin-bottom: 4px;">Data de Adi√ß√£o</p>
                <p>${dataAdicao}</p>
            </div>
            
            ${doc.foto && doc.foto.startsWith('data:') ? `
                <div>
                    <p style="color: #86868b; font-size: 0.875rem; margin-bottom: 8px;">Fotografia/Scan</p>
                    ${doc.foto.startsWith('data:image') ? `
                        <img src="${doc.foto}" alt="${doc.titulo}" style="max-width: 100%; max-height: 400px; border-radius: 8px; border: 1px solid #d2d2d7;">
                    ` : doc.foto.startsWith('data:application/pdf') ? `
                        <div style="
                            display: flex;
                            align-items: center;
                            gap: 12px;
                            padding: 16px;
                            background: rgba(0, 122, 255, 0.1);
                            border: 2px dashed rgba(0, 122, 255, 0.3);
                            border-radius: 8px;
                        ">
                            <div style="font-size: 64px;">üìÑ</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #007AFF; font-size: 1.1rem;">PDF anexado</div>
                                <div style="font-size: 12px; color: #8E8E93; margin-top: 4px;">Ficheiro PDF guardado</div>
                            </div>
                            <button 
                                onclick="abrirPDF('${doc.id}')" 
                                style="
                                    background: #007AFF;
                                    color: white;
                                    border: none;
                                    padding: 12px 24px;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    white-space: nowrap;
                                    transition: all 0.2s;
                                "
                                onmouseover="this.style.background='#0051D5'"
                                onmouseout="this.style.background='#007AFF'"
                                title="Abrir PDF em nova janela"
                            >
                                üì• Abrir PDF
                            </button>
                        </div>
                    ` : ''}
                </div>
            ` : ''}
        </div>
    `;
    
    document.getElementById('modalTitle').textContent = 'Detalhes do Documento';
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('detailsModal').classList.add('active');
}

// ‚úÖ v3.7.2.21: Abrir/Baixar PDF usando Blob URL
function abrirPDF(documentoId) {
    const doc = listaDocumentos.find(d => d.id === documentoId);
    if (!doc || !doc.foto || !doc.foto.startsWith('data:application/pdf')) {
        showToast('‚ùå PDF n√£o encontrado', 'error');
        return;
    }
    
    // Criar nome de ficheiro baseado no t√≠tulo do documento
    const nomeArquivo = `${doc.titulo.replace(/[^a-z0-9]/gi, '_')}.pdf`;
    
    try {
        // ‚úÖ CORRE√á√ÉO: Converter Base64 para Blob URL
        // Extrair o Base64 puro (remover "data:application/pdf;base64,")
        const base64Data = doc.foto.split(',')[1];
        
        // Converter Base64 para array de bytes
        const byteCharacters = atob(base64Data);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        
        // Criar Blob
        const blob = new Blob([byteArray], { type: 'application/pdf' });
        
        // Criar Blob URL
        const blobUrl = URL.createObjectURL(blob);
        
        console.log('‚úÖ PDF convertido para Blob URL:', blobUrl);
        
        // Abrir em nova janela
        const janela = window.open(blobUrl, '_blank');
        
        if (janela) {
            showToast('‚úÖ PDF aberto em nova janela', 'success');
            
            // Limpar Blob URL ap√≥s 1 minuto (economia de mem√≥ria)
            setTimeout(() => {
                URL.revokeObjectURL(blobUrl);
                console.log('üßπ Blob URL limpo');
            }, 60000);
        } else {
            // Fallback: Fazer download se popup foi bloqueado
            URL.revokeObjectURL(blobUrl);
            baixarPDF(doc, nomeArquivo);
        }
    } catch (error) {
        console.error('‚ùå Erro ao abrir PDF:', error);
        showToast('‚ùå Erro ao abrir PDF. A fazer download...', 'error');
        // Fallback: Fazer download
        baixarPDF(doc, nomeArquivo);
    }
}

// Fun√ß√£o auxiliar para fazer download do PDF
function baixarPDF(doc, nomeArquivo) {
    const link = document.createElement('a');
    link.href = doc.foto;
    link.download = nomeArquivo;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showToast('üì• Download do PDF iniciado', 'info');
}

// Remover documento
function removerDocumento(id) {
    if (confirm('Tens a certeza que queres apagar este documento?')) {
        listaDocumentos = listaDocumentos.filter(d => d.id !== id);
        salvarDocumentos();
        renderizarDocumentos();
        showToast('üóëÔ∏è Documento removido', 'info');
    }
}





// Limpar formul√°rio
function limparFormDocumento() {
    document.getElementById('documentoForm').reset();
    document.getElementById('imagePreviewDocumento').innerHTML = '';
    document.getElementById('fileNameDocumento').textContent = 'Escolher ficheiro';
    currentDocumentoPhoto = null;
}

// Handler para foto do documento
let currentDocumentoPhoto = null;

// ‚úÖ v3.7.2.15: Fun√ß√£o de compress√£o de imagem simples
function compressDocumentoImage(file, maxWidth = 800, quality = 0.8) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            const img = new Image();
            
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Redimensionar se necess√°rio
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Converter para base64
                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                resolve(dataUrl);
            };
            
            img.onerror = () => {
                reject(new Error('Erro ao carregar imagem'));
            };
            
            img.src = e.target.result;
        };
        
        reader.onerror = () => {
            reject(new Error('Erro ao ler ficheiro'));
        };
        
        reader.readAsDataURL(file);
    });
}

function handleDocumentoImage(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // ‚úÖ v3.7.2.16: Aceitar imagens E PDFs
    const isImage = file.type.startsWith('image/');
    const isPDF = file.type === 'application/pdf';
    
    if (!isImage && !isPDF) {
        showToast('‚ùå Por favor selecione uma imagem ou PDF.', 'error');
        event.target.value = '';
        return;
    }
    
    // Validar tamanho (m√°x 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showToast('‚ùå Ficheiro muito grande! M√°ximo 5MB.', 'error');
        event.target.value = '';
        return;
    }
    
    // Atualizar nome do ficheiro
    const fileNameEl = document.getElementById('fileNameDocumento');
    if (fileNameEl) {
        fileNameEl.textContent = file.name;
    }
    
    // ‚úÖ Se for PDF, guardar direto (sem compress√£o)
    if (isPDF) {
        const reader = new FileReader();
        reader.onload = (e) => {
            currentDocumentoPhoto = e.target.result;
            showDocumentoPreview(e.target.result, true); // true = √© PDF
            showToast('‚úÖ PDF carregado!', 'success');
        };
        reader.onerror = () => {
            showToast('‚ùå Erro ao carregar PDF.', 'error');
            event.target.value = '';
            currentDocumentoPhoto = null;
            if (fileNameEl) {
                fileNameEl.textContent = 'Escolher ficheiro';
            }
        };
        reader.readAsDataURL(file);
    } 
    // ‚úÖ Se for imagem, comprimir
    else if (isImage) {
        compressDocumentoImage(file, 800, 0.8).then(dataUrl => {
            currentDocumentoPhoto = dataUrl;
            showDocumentoPreview(dataUrl, false); // false = √© imagem
            showToast('‚úÖ Imagem carregada e comprimida!', 'success');
        }).catch(error => {
            console.error('Erro ao processar imagem:', error);
            showToast('‚ùå Erro ao processar imagem.', 'error');
            event.target.value = '';
            currentDocumentoPhoto = null;
            if (fileNameEl) {
                fileNameEl.textContent = 'Escolher ficheiro';
            }
        });
    }
}

function showDocumentoPreview(dataUrl, isPDF = false) {
    const preview = document.getElementById('imagePreviewDocumento');
    
    // ‚úÖ v3.7.2.16: Preview diferente para PDF vs Imagem
    if (isPDF) {
        // Mostrar √≠cone de PDF
        preview.innerHTML = `
            <div style="
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px;
                background: rgba(0, 122, 255, 0.1);
                border: 2px dashed rgba(0, 122, 255, 0.3);
                border-radius: 8px;
                margin-top: 8px;
                position: relative;
            ">
                <div style="font-size: 48px;">üìÑ</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: #007AFF;">PDF anexado</div>
                    <div style="font-size: 12px; color: #8E8E93; margin-top: 4px;">Ficheiro PDF pronto para guardar</div>
                </div>
                <button type="button" class="remove-image" onclick="clearDocumentoPreview()" style="
                    position: absolute;
                    top: 8px;
                    right: 8px;
                    background: rgba(255, 59, 48, 0.9);
                    border: none;
                    border-radius: 50%;
                    width: 28px;
                    height: 28px;
                    cursor: pointer;
                    color: white;
                    font-size: 18px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">√ó</button>
            </div>
        `;
    } else {
        // Mostrar preview de imagem
        preview.innerHTML = `
            <img src="${dataUrl}" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 8px;">
            <button type="button" class="remove-image" onclick="clearDocumentoPreview()" style="
                position: absolute;
                top: 4px;
                right: 4px;
                background: rgba(255, 59, 48, 0.9);
                border: none;
                border-radius: 50%;
                width: 28px;
                height: 28px;
                cursor: pointer;
                color: white;
                font-size: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
            ">√ó</button>
        `;
    }
    
    preview.style.position = 'relative';
}

function clearDocumentoPreview() {
    const preview = document.getElementById('imagePreviewDocumento');
    preview.innerHTML = '';
    document.getElementById('fotoDocumento').value = '';
    document.getElementById('fileNameDocumento').textContent = 'Escolher ficheiro';
    currentDocumentoPhoto = null;
}

// Aplicar filtro de tipo
function aplicarFiltroDocumentos() {
    renderizarDocumentos();
}

// Renderizar lista de documentos (IGUAL √Ä LISTA DE TAREFAS)
function renderizarDocumentos() {
    const container = document.getElementById('documentosLista');
    const emptyState = document.getElementById('documentosEmptyState');
    const countEl = document.getElementById('documentosCount');
    
    // ‚úÖ Se os elementos n√£o existem, n√£o fazer nada
    if (!container || !emptyState || !countEl) {
        console.log('‚ö†Ô∏è Tab Documentos vazia - elementos HTML n√£o existem');
        return;
    }
    
    // Aplicar filtros
    const tipoCheckboxes = document.querySelectorAll('.filter-tipo-documento:checked');
    const tiposSelecionados = Array.from(tipoCheckboxes).map(cb => cb.value);
    
    let documentosFiltrados = listaDocumentos;
    
    // Filtrar por tipo (se houver filtros ativos)
    if (tiposSelecionados.length > 0) {
        documentosFiltrados = listaDocumentos.filter(d => tiposSelecionados.includes(d.tipo));
    }
    
    // Atualizar contador
    const count = documentosFiltrados.length;
    countEl.textContent = `${count} ${count === 1 ? 'documento' : 'documentos'}`;
    
    if (count === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'flex';
        return;
    }
    
    emptyState.style.display = 'none';
    
    // Renderizar cards (MESMO ESTILO DAS TAREFAS)
    container.innerHTML = documentosFiltrados.map(doc => {
        const dataAdicao = new Date(doc.dataAdicao).toLocaleDateString('pt-PT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
        
        const dataValidade = doc.dataValidade ? new Date(doc.dataValidade).toLocaleDateString('pt-PT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        }) : null;
        
        const vencido = doc.dataValidade && new Date(doc.dataValidade) < new Date();
        
        return `
            <div class="request-card" onclick="abrirDocumento('${doc.id}')">
                <div class="request-header">
                    <div class="request-badges">
                        <span class="badge" style="background: #2c3e50; color: white; font-size: 11px; font-weight: 600; letter-spacing: 0.5px;">
                            üÜî ${doc.id}
                        </span>
                        <span class="badge badge-tipo">${getTipoIcon(doc.tipo)} ${doc.tipo}</span>
                        ${vencido ? `
                            <span class="badge" style="background: #ff3b30; color: white; font-size: 11px; font-weight: 600;">
                                ‚ö†Ô∏è VENCIDO
                            </span>
                        ` : dataValidade ? `
                            <span class="badge" style="background: #34c759; color: white; font-size: 11px;">
                                ‚úÖ V√°lido at√© ${dataValidade}
                            </span>
                        ` : ''}
                    </div>
                    <div class="request-actions">
                        <button class="btn-icon" onclick="event.stopPropagation(); abrirDocumento('${doc.id}')" title="Ver documento">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                        <button class="btn-icon btn-delete" onclick="event.stopPropagation(); removerDocumento('${doc.id}')" title="Apagar documento">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="request-content">
                    <h3 class="request-title">${doc.titulo}</h3>
                    ${doc.descricao ? `<p class="request-description">${doc.descricao}</p>` : ''}
                </div>
                
                <div class="request-footer">
                    <div class="request-meta">
                        <span class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            ${dataAdicao}
                        </span>
                        ${doc.foto ? `
                            <span class="meta-item" style="color: #007aff;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                                Com foto
                            </span>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Helper para √≠cones dos tipos
function getTipoIcon(tipo) {
    const icons = {
        'Certid√£o': 'üìú',
        'Contrato': 'üìÑ',
        'Garantia': 'üõ°Ô∏è',
        'Fatura': 'üßæ',
        'Seguro': 'üè•',
        'Identifica√ß√£o': 'ü™™',
        'Senha': 'üîê',
        'Foto': 'üì∏',
        'Outro': 'üìå'
    };
    return icons[tipo] || 'üìÑ';
}

// Limpar filtros de documentos
function limparFiltrosDocumentos() {
    document.querySelectorAll('.filter-tipo-documento').forEach(cb => cb.checked = true);
    renderizarDocumentos();
}

// Toggle ordena√ß√£o de documentos
let sortOrderDocumentos = 'desc'; // mais recentes primeiro
function toggleSortOrderDocumentos() {
    sortOrderDocumentos = sortOrderDocumentos === 'desc' ? 'asc' : 'desc';
    listaDocumentos.sort((a, b) => {
        const dateA = new Date(a.dataAdicao);
        const dateB = new Date(b.dataAdicao);
        return sortOrderDocumentos === 'desc' ? dateB - dateA : dateA - dateB;
    });
    renderizarDocumentos();
    showToast(sortOrderDocumentos === 'desc' ? 'üìÖ Mais recentes primeiro' : 'üìÖ Mais antigos primeiro', 'info');
}

// Inicializar m√≥dulo de documentos
function initializeDocumentosModule() {
    carregarDocumentos();
    
    // Event listener para o formul√°rio
    const form = document.getElementById('documentoForm');
    if (form) {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const tipo = document.getElementById('tipoDocumento').value;
            const titulo = document.getElementById('tituloDocumento').value;
            const descricao = document.getElementById('descricaoDocumento').value;
            const dataValidade = document.getElementById('validadeDocumento').value;
            
            if (!tipo || !titulo) {
                showToast('‚ùå Preenche os campos obrigat√≥rios (Tipo e T√≠tulo)!', 'error');
                return;
            }
            
            adicionarDocumento({
                tipo,
                titulo,
                descricao,
                dataValidade,
                foto: currentDocumentoPhoto || ''
            });
            
            limparFormDocumento();
        });
    }
    
    // Event listeners para filtros
    const filterCheckboxes = document.querySelectorAll('.filter-tipo-documento');
    filterCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            renderizarDocumentos();
        });
    });
    
    // Bot√£o limpar filtros
    const clearFiltersBtn = document.getElementById('clearFiltersDocumentos');
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', () => {
            filterCheckboxes.forEach(cb => cb.checked = false);
            renderizarDocumentos();
        });
    }
    
    // Bot√£o ordenar
    const sortBtn = document.getElementById('sortBtnDocumentos');
    if (sortBtn) {
        sortBtn.addEventListener('click', () => {
            listaDocumentos.reverse();
            renderizarDocumentos();
        });
    }
}

// Helper para ler ficheiro como Base64
function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function initializeStockModule() {
    // ‚úÖ v3.7.2.3: Inicializar m√≥dulos
    initializeComprasModule();
    initializeDocumentosModule();
    
    // ‚úÖ CORRIGIDO: J√° carregado em syncWithSupabase(), n√£o precisa recarregar
    // loadArtigosFromGoogleSheets(); // ‚ùå REMOVIDO - fun√ß√£o n√£o existe
    // loadMovimentosFromGoogleSheets(); // ‚ùå REMOVIDO - fun√ß√£o n√£o existe
    
    // Setup event listeners
    const stockTab = document.querySelector('.tab-btn[data-tab="stock"]');
    if (stockTab) {
        stockTab.addEventListener('click', () => {
            // renderMovimentos() - removido, agora usa pesquisa
            renderizarListaCompras(); // ‚úÖ Atualizar lista ao abrir tab
        });
    }
    
    const searchInput = document.getElementById('stockSearchInput');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchArtigos(e.target.value);
            }, 300); // Debounce de 300ms
        });
    }
    
    // üÜï Event listener para pesquisa de hist√≥rico
    const historicoSearchInput = document.getElementById('historicoSearchInput');
    if (historicoSearchInput) {
        let historicoTimeout;
        historicoSearchInput.addEventListener('input', (e) => {
            clearTimeout(historicoTimeout);
            historicoTimeout = setTimeout(() => {
                searchArtigoHistorico(e.target.value);
            }, 300); // Debounce de 300ms
        });
    }
    
    // üÜï Event listener para pesquisa de OT na baixa m√∫ltipla
    const baixaOTSearch = document.getElementById('baixaMultiplaOTSearch');
    if (baixaOTSearch) {
        baixaOTSearch.addEventListener('input', (e) => {
            const otId = e.target.value.trim().toUpperCase();
            const otInfo = document.getElementById('baixaMultiplaOTInfo');
            
            if (otId.length > 2) {
                const ot = AppState.requests.find(r => r.id.toUpperCase().includes(otId));
                if (ot) {
                    otInfo.style.display = 'block';
                    const descricaoPreview = ot.descricao && ot.descricao.length > 60 
                        ? ot.descricao.substring(0, 60) + '...' 
                        : ot.descricao || '';
                    otInfo.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                            <div style="flex: 1;">
                                <div style="margin-bottom: 4px;">
                                    <strong style="font-size: 15px;">${ot.id}</strong> 
                                    <span class="badge badge-tipo" style="font-size: 11px; margin-left: 8px;">${ot.tipo}</span>
                                    <span class="badge badge-estado ${ot.estado.toLowerCase()}" style="font-size: 11px; margin-left: 4px;">${ot.estado}</span>
                                </div>
                                <div style="color: #6c757d; font-size: 13px; margin-bottom: 4px;">
                                    ${ot.areaEquipamento || ''} ${ot.componente ? '‚Üí ' + ot.componente : ''}
                                </div>
                                ${descricaoPreview ? `<div style="color: #495057; font-size: 12px; font-style: italic;">"${descricaoPreview}"</div>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    otInfo.style.display = 'none';
                }
            } else {
                otInfo.style.display = 'none';
            }
        });
    }
    
    const movimentoForm = document.getElementById('movimentoForm');
    if (movimentoForm) {
        movimentoForm.addEventListener('submit', handleMovimentoSubmit);
    }
}

// üî• v3.7.0.9: Fun√ß√£o auxiliar para calcular stock atual (FIX: quantidade j√° vem com sinal)
function calcularStockAtual(artigoId) {
    const movimentosArtigo = AppState.movimentos.filter(m => m.artigoId === artigoId);
    let stockAtual = 0;
    
    // ‚úÖ SIMPLIFICADO: Quantidade j√° vem com o sinal correto do Supabase
    // Entrada: +10
    // Sa√≠da:   -5
    // Baixa:   -3
    movimentosArtigo.forEach(mov => {
        stockAtual += mov.quantidade;  // ‚úÖ Simplesmente somar (funciona para positivos e negativos)
    });
    
    return stockAtual;
}

// ‚úÖ v3.7.0.9: Filtrar artigos por fam√≠lia no modal de movimento
function filtrarArtigosPorFamilia() {
    const familiaSelect = document.getElementById('movimentoFamiliaSelect');
    const artigoSelect = document.getElementById('movimentoArtigoSelect');
    
    if (!familiaSelect || !artigoSelect) return;
    
    const familiaSelecionada = familiaSelect.value;
    
    // Filtrar artigos
    let artigosFiltrados = AppState.artigos;
    if (familiaSelecionada) {
        artigosFiltrados = AppState.artigos.filter(a => a.familia === familiaSelecionada);
    }
    
    // Popular dropdown de artigos
    artigoSelect.innerHTML = '<option value="">Selecione um artigo...</option>';
    artigosFiltrados.forEach(artigo => {
        const option = document.createElement('option');
        option.value = artigo.id;
        option.textContent = `${artigo.designacao} (${artigo.referencia})`;
        artigoSelect.appendChild(option);
    });
    
    console.log(`‚úÖ ${artigosFiltrados.length} artigos carregados no dropdown`);
}

// ‚úÖ v3.7.0.9: Atualizar informa√ß√£o do artigo selecionado
function updateArtigoInfo() {
    const artigoSelect = document.getElementById('movimentoArtigoSelect');
    const infoDiv = document.getElementById('artigoSelectedInfo');
    
    if (!artigoSelect || !infoDiv) return;
    
    const artigoId = artigoSelect.value;
    
    if (!artigoId) {
        infoDiv.style.display = 'none';
        return;
    }
    
    const artigo = AppState.artigos.find(a => a.id === artigoId);
    if (!artigo) return;
    
    const stock = calcularStockAtual(artigoId);
    const stockDisplay = (stock !== undefined && stock !== null) ? stock : 0;
    const stockBaixo = stockDisplay <= artigo.stockMinimo;
    
    infoDiv.style.display = 'block';
    infoDiv.innerHTML = `
        <div style="padding: 12px; background: ${stockBaixo ? '#fff3cd' : '#d4edda'}; border-radius: 8px; margin: 12px 0;">
            <div style="font-weight: 600; margin-bottom: 8px;">${artigo.designacao}</div>
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px; font-size: 0.875rem;">
                <strong>Refer√™ncia:</strong> <span>${artigo.referencia}</span>
                <strong>Stock Atual:</strong> <span style="color: ${stockBaixo ? '#856404' : '#155724'}; font-weight: 600;">${stockDisplay} ${artigo.unidade || 'UN'}</span>
                <strong>Stock M√≠nimo:</strong> <span>${artigo.stockMinimo} ${artigo.unidade || 'UN'}</span>
                <strong>Fornecedor:</strong> <span>${artigo.fornecedor || '-'}</span>
            </div>
            ${stockBaixo ? '<div style="margin-top: 8px; color: #856404; font-weight: 600;">‚ö†Ô∏è Stock abaixo do m√≠nimo!</div>' : ''}
        </div>
    `;
}

// ‚úÖ v3.7.0.9: Abrir modal de novo movimento
function openNovoMovimentoModal() {
    const modal = document.getElementById('movimentoModal');
    if (!modal) return;
    
    // Limpar formul√°rio
    document.getElementById('movimentoForm')?.reset();
    document.getElementById('artigoSelectedInfo').style.display = 'none';
    
    // Popular dropdown de fam√≠lias
    const familiaSelect = document.getElementById('movimentoFamiliaSelect');
    if (familiaSelect) {
        const familias = [...new Set(AppState.artigos.map(a => a.familia))].sort();
        familiaSelect.innerHTML = '<option value="">Todas as fam√≠lias</option>';
        familias.forEach(familia => {
            const option = document.createElement('option');
            option.value = familia;
            option.textContent = familia;
            familiaSelect.appendChild(option);
        });
    }
    
    // Popular dropdown de artigos (todos)
    filtrarArtigosPorFamilia();
    
    // Preencher respons√°vel com utilizador logado
    const responsavelInput = document.getElementById('movimentoResponsavel');
    if (responsavelInput && AppState.currentUser) {
        responsavelInput.value = AppState.currentUser.nomeCompleto;
    }
    
    // Abrir modal
    modal.classList.add('active');
}

// ‚úÖ v3.7.0.9: Fechar modal de movimento
function closeMovimentoModal() {
    const modal = document.getElementById('movimentoModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

// ‚úÖ v3.7.0.9: Ajustar quantidade com bot√µes +/-
function adjustQuantidade(delta) {
    const input = document.getElementById('movimentoQuantidade');
    if (!input) return;
    
    const currentValue = parseInt(input.value) || 1;
    const newValue = Math.max(1, currentValue + delta);
    input.value = newValue;
}

// Pesquisa de artigos
function searchArtigos(term) {
    const resultsDiv = document.getElementById('stockSearchResults');
    const resultsBody = document.getElementById('stockSearchResultsBody');
    const emptyDiv = document.getElementById('stockEmptySearch');
    
    if (!term || term.trim().length < 2) {
        resultsDiv.style.display = 'none';
        emptyDiv.style.display = 'block';
        return;
    }
    
    const searchTerm = term.toLowerCase();
    const artigos = AppState.artigos.filter(a => 
        a.designacao && a.designacao.toLowerCase().includes(searchTerm) ||
        a.referencia && a.referencia.toLowerCase().includes(searchTerm) ||
        a.id && a.id.toLowerCase().includes(searchTerm) ||
        a.fornecedor && a.fornecedor.toLowerCase().includes(searchTerm) ||
        a.familia && a.familia.toLowerCase().includes(searchTerm)
    );
    
    if (artigos.length === 0) {
        emptyDiv.style.display = 'block';
        emptyDiv.innerHTML = '<p>‚ùå Nenhum artigo encontrado</p>';
        resultsDiv.style.display = 'none';
        return;
    }
    
    emptyDiv.style.display = 'none';
    resultsDiv.style.display = 'block';
    
    resultsBody.innerHTML = artigos.map(artigo => {
        const stockAtual = calcularStockAtual(artigo.id);
        const stockBaixo = stockAtual <= artigo.stockMinimo;
        const stockClass = stockBaixo ? 'baixo' : 'ok';
        const stockIcon = stockBaixo ? '‚ö†Ô∏è' : '‚úÖ';
        
        return `
            <div class="stock-card">
                <div class="stock-card-header">
                    <div class="stock-card-title">${artigo.designacao}</div>
                    <div class="stock-card-ref">${artigo.referencia}</div>
                </div>
                
                <div class="stock-card-body">
                    <div class="stock-card-info">
                        <div class="stock-card-info-row">
                            <span class="stock-card-info-label">üì¶ Fam√≠lia:</span>
                            <span class="stock-card-info-value">${artigo.familia}</span>
                        </div>
                        <div class="stock-card-info-row">
                            <span class="stock-card-info-label">üè¢ Fornecedor:</span>
                            <span class="stock-card-info-value">${artigo.fornecedor}</span>
                        </div>
                        <div class="stock-card-info-row">
                            <span class="stock-card-info-label">üí∂ Pre√ßo:</span>
                            <span class="stock-card-info-value">‚Ç¨${artigo.preco.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="stock-card-stock">
                        <div class="stock-card-stock-label">${stockIcon} Stock Atual</div>
                        <div class="stock-card-stock-value ${stockClass}">
                            ${stockAtual} ${artigo.unidade || 'un'}
                        </div>
                        <small style="color: var(--color-text-secondary);">M√≠nimo: ${artigo.stockMinimo} ${artigo.unidade || 'un'}</small>
                    </div>
                </div>
                
                <div class="stock-card-footer">
                    <button class="btn btn-secondary btn-sm" onclick="darBaixaRapida('${artigo.id}')">
                        üì§ Dar Baixa
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="openMovimentoModal('${artigo.id}')">
                        üìù Movimento
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function clearStockSearch() {
    document.getElementById('stockSearchInput').value = '';
    document.getElementById('stockSearchResults').style.display = 'none';
    document.getElementById('stockEmptySearch').style.display = 'block';
    document.getElementById('stockEmptySearch').innerHTML = '<p>üîç Digite acima para procurar artigos</p>';
}

// üÜï HIST√ìRICO DE MOVIMENTOS - Pesquisar artigo
let selectedArtigoHistorico = null;

function searchArtigoHistorico(term) {
    const historicoFilters = document.getElementById('historicoFilters');
    const historicoTableContainer = document.getElementById('historicoTableContainer');
    const historicoEmptyState = document.getElementById('historicoEmptyState');
    const historicoNoMovimentos = document.getElementById('historicoNoMovimentos');
    
    // Resetar sele√ß√£o
    selectedArtigoHistorico = null;
    historicoFilters.style.display = 'none';
    historicoTableContainer.style.display = 'none';
    historicoNoMovimentos.style.display = 'none';
    
    if (!term || term.trim().length < 2) {
        historicoEmptyState.style.display = 'block';
        historicoEmptyState.innerHTML = '<p>üîç Digite acima para procurar um artigo e ver seu hist√≥rico</p>';
        return;
    }
    
    const searchTerm = term.toLowerCase();
    const artigos = AppState.artigos.filter(a => 
        a.designacao && a.designacao.toLowerCase().includes(searchTerm) ||
        a.referencia && a.referencia.toLowerCase().includes(searchTerm) ||
        a.id && a.id.toLowerCase().includes(searchTerm) ||
        a.fornecedor && a.fornecedor.toLowerCase().includes(searchTerm) ||
        a.familia && a.familia.toLowerCase().includes(searchTerm)
    );
    
    if (artigos.length === 0) {
        historicoEmptyState.style.display = 'block';
        historicoEmptyState.innerHTML = '<p>‚ùå Nenhum artigo encontrado</p>';
        return;
    }
    
    // Se encontrou exatamente 1 artigo, selecionar automaticamente
    if (artigos.length === 1) {
        selectArtigoHistorico(artigos[0].id);
        historicoEmptyState.style.display = 'none';
        return;
    }
    
    // Se encontrou m√∫ltiplos, mostrar lista para sele√ß√£o
    historicoEmptyState.style.display = 'block';
    historicoEmptyState.innerHTML = `
        <div style="text-align: left;">
            <strong>üì¶ ${artigos.length} artigos encontrados - Selecione um:</strong>
            <div style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">
                ${artigos.map(a => `
                    <button class="btn btn-secondary" onclick="selectArtigoHistorico('${a.id}')" style="text-align: left; padding: 12px;">
                        <strong>${a.designacao}</strong><br>
                        <small style="color: var(--color-text-secondary);">${a.referencia} | ${a.familia}</small>
                    </button>
                `).join('')}
            </div>
        </div>
    `;
}

// üÜï Selecionar artigo e mostrar hist√≥rico
function selectArtigoHistorico(artigoId) {
    selectedArtigoHistorico = artigoId;
    const artigo = AppState.artigos.find(a => a.id === artigoId);
    
    if (!artigo) return;
    
    const historicoEmptyState = document.getElementById('historicoEmptyState');
    const historicoFilters = document.getElementById('historicoFilters');
    
    // Atualizar input com nome do artigo
    document.getElementById('historicoSearchInput').value = artigo.designacao;
    
    // Ocultar estado vazio e mostrar filtros
    historicoEmptyState.style.display = 'none';
    historicoFilters.style.display = 'block';
    
    // Renderizar movimentos
    renderMovimentosByArtigo();
}

// üÜï Renderizar movimentos de um artigo espec√≠fico
function renderMovimentosByArtigo() {
    if (!selectedArtigoHistorico) return;
    
    const tbody = document.getElementById('movimentosTableBody');
    const tableContainer = document.getElementById('historicoTableContainer');
    const noMovimentos = document.getElementById('historicoNoMovimentos');
    
    const tipoFilter = document.getElementById('movimentoTipoFilter')?.value || 'TODOS';
    const limit = parseInt(document.getElementById('movimentoLimitFilter')?.value || 20);
    
    // Filtrar movimentos do artigo selecionado
    let movimentos = AppState.movimentos.filter(m => m.artigoId === selectedArtigoHistorico);
    
    // Filtrar por tipo
    if (tipoFilter !== 'TODOS') {
        movimentos = movimentos.filter(m => m.tipo === tipoFilter);
    }
    
    // Ordenar por data (mais recente primeiro)
    movimentos.sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
    
    // Limitar quantidade
    movimentos = movimentos.slice(0, limit);
    
    if (movimentos.length === 0) {
        tableContainer.style.display = 'none';
        noMovimentos.style.display = 'block';
        return;
    }
    
    noMovimentos.style.display = 'none';
    tableContainer.style.display = 'block';
    
    const artigo = AppState.artigos.find(a => a.id === selectedArtigoHistorico);
    
    tbody.innerHTML = movimentos.map(mov => {
        const dataFormatada = formatDateTime(mov.dataHora);
        const qtdClass = mov.quantidade > 0 ? 'positivo' : 'negativo';
        const badgeClass = mov.tipo === 'Entrada' ? 'badge-entrada' : mov.tipo === 'Sa√≠da' ? 'badge-saida' : 'badge-ajuste';
        
        return `
            <tr>
                <td><small>${dataFormatada}</small></td>
                <td><span class="badge ${badgeClass}">${mov.tipo}</span></td>
                <td>
                    <span class="quantidade-badge ${qtdClass}">
                        ${mov.quantidade > 0 ? '+' : ''}${mov.quantidade} ${artigo?.unidade || 'un'}
                    </span>
                </td>
                <td>${mov.responsavel}</td>
                <td><small>${mov.observacoes || '-'}</small></td>
                <td>
                    <div class="stock-actions">
                        <button class="btn btn-secondary btn-sm" onclick="editarMovimento('${mov.id}')" title="Editar">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="eliminarMovimento('${mov.id}')" title="Eliminar">
                            üóëÔ∏è
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// üÜï Limpar pesquisa de hist√≥rico
function clearHistoricoSearch() {
    selectedArtigoHistorico = null;
    document.getElementById('historicoSearchInput').value = '';
    document.getElementById('historicoFilters').style.display = 'none';
    document.getElementById('historicoTableContainer').style.display = 'none';
    document.getElementById('historicoNoMovimentos').style.display = 'none';
    document.getElementById('historicoEmptyState').style.display = 'block';
    document.getElementById('historicoEmptyState').innerHTML = '<p>üîç Digite acima para procurar um artigo e ver seu hist√≥rico</p>';
}

// ============================================
// üí∞ BAIXA M√öLTIPLA DE STOCK
// ============================================

let baixaMultiplaOTSelecionada = null;
let baixaMultiplaLinhasCount = 0;

// Abrir modal de baixa m√∫ltipla
function openBaixaMultiplaModal(otId = null) {
    baixaMultiplaOTSelecionada = otId;
    baixaMultiplaLinhasCount = 0;
    
    const modal = document.getElementById('baixaMultiplaModal');
    const otSearch = document.getElementById('baixaMultiplaOTSearch');
    const otInfo = document.getElementById('baixaMultiplaOTInfo');
    const linhasContainer = document.getElementById('baixaMultiplaLinhas');
    const responsavelInput = document.getElementById('baixaMultiplaResponsavel');
    
    // Resetar
    linhasContainer.innerHTML = '';
    otSearch.value = '';
    otInfo.style.display = 'none';
    document.getElementById('baixaMultiplaResumo').style.display = 'none';
    
    // Se veio de uma OT, pr√©-preencher
    if (otId) {
        const ot = AppState.requests.find(r => r.id === otId);
        if (ot) {
            otSearch.value = otId;
            otInfo.style.display = 'block';
            const descricaoPreview = ot.descricao && ot.descricao.length > 60 
                ? ot.descricao.substring(0, 60) + '...' 
                : ot.descricao || '';
            otInfo.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                    <div style="flex: 1;">
                        <div style="margin-bottom: 4px;">
                            <strong style="font-size: 15px;">${otId}</strong> 
                            <span class="badge badge-tipo" style="font-size: 11px; margin-left: 8px;">${ot.tipo}</span>
                            <span class="badge badge-estado ${ot.estado.toLowerCase()}" style="font-size: 11px; margin-left: 4px;">${ot.estado}</span>
                        </div>
                        <div style="color: #6c757d; font-size: 13px; margin-bottom: 4px;">
                            ${ot.areaEquipamento || ''} ${ot.componente ? '‚Üí ' + ot.componente : ''}
                        </div>
                        ${descricaoPreview ? `<div style="color: #495057; font-size: 12px; font-style: italic;">"${descricaoPreview}"</div>` : ''}
                    </div>
                </div>
            `;
            otSearch.disabled = true;
        }
    }
    
    // Pr√©-preencher respons√°vel
    if (AppState.currentUser) {
        responsavelInput.value = AppState.currentUser.nomeCompleto;
    }
    
    // Adicionar primeira linha
    adicionarLinhaBaixa();
    
    modal.classList.add('active');
}

// Fechar modal
function closeBaixaMultiplaModal() {
    document.getElementById('baixaMultiplaModal').classList.remove('active');
    baixaMultiplaOTSelecionada = null;
    baixaMultiplaLinhasCount = 0;
}

// Adicionar linha de artigo
function adicionarLinhaBaixa() {
    const container = document.getElementById('baixaMultiplaLinhas');
    const linhaId = `baixa-linha-${baixaMultiplaLinhasCount++}`;
    
    const linha = document.createElement('div');
    linha.id = linhaId;
    linha.style.cssText = 'display: grid; grid-template-columns: 1fr 2fr 1fr auto; gap: 8px; padding: 12px; background: #f8f9fa; border-radius: 8px; align-items: end;';
    
    // Obter fam√≠lias √∫nicas
    const familias = [...new Set(AppState.artigos.filter(a => a.visivel !== false).map(a => a.familia))].sort();
    
    linha.innerHTML = `
        <div class="form-group" style="margin: 0;">
            <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">üì¶ Fam√≠lia</label>
            <select class="form-input baixa-familia-select" data-linha="${linhaId}" onchange="filtrarArtigosBaixaLinha('${linhaId}')" required>
                <option value="">Escolher fam√≠lia...</option>
                ${familias.map(f => `<option value="${f}">${f}</option>`).join('')}
            </select>
        </div>
        <div class="form-group" style="margin: 0;">
            <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">Artigo</label>
            <select class="form-input baixa-artigo-select" data-linha="${linhaId}" onchange="updateLinhaBaixaInfo('${linhaId}')" required disabled>
                <option value="">Escolha fam√≠lia primeiro...</option>
            </select>
            <small class="baixa-linha-info" style="display: none; margin-top: 4px; color: #6c757d;"></small>
        </div>
        <div class="form-group" style="margin: 0;">
            <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">Quantidade</label>
            <input type="number" 
                   class="form-input baixa-quantidade-input" 
                   data-linha="${linhaId}"
                   min="0.01" 
                   step="0.01" 
                   value="1" 
                   onchange="calcularResumoBaixa()"
                   required>
        </div>
        <button type="button" 
                class="btn btn-secondary btn-sm" 
                onclick="removerLinhaBaixa('${linhaId}')" 
                style="height: 38px; padding: 0 12px;"
                title="Remover">
            üóëÔ∏è
        </button>
    `;
    
    container.appendChild(linha);
    calcularResumoBaixa();
}

// Remover linha
function removerLinhaBaixa(linhaId) {
    const linha = document.getElementById(linhaId);
    if (linha) {
        linha.remove();
        calcularResumoBaixa();
    }
}

// Filtrar artigos por fam√≠lia na linha
function filtrarArtigosBaixaLinha(linhaId) {
    const linha = document.getElementById(linhaId);
    if (!linha) return;
    
    const familiaSelect = linha.querySelector('.baixa-familia-select');
    const artigoSelect = linha.querySelector('.baixa-artigo-select');
    const familiaSelecionada = familiaSelect.value;
    
    // Resetar artigo
    artigoSelect.innerHTML = '<option value="">Selecione um artigo...</option>';
    artigoSelect.disabled = !familiaSelecionada;
    
    if (familiaSelecionada) {
        // Filtrar artigos da fam√≠lia
        const artigosFiltrados = AppState.artigos.filter(a => 
            a.visivel !== false && a.familia === familiaSelecionada
        );
        
        artigosFiltrados.forEach(a => {
            const stock = calcularStockAtual(a.id);
            const option = document.createElement('option');
            option.value = a.id;
            option.dataset.stock = stock;
            option.dataset.preco = a.preco;
            option.dataset.unidade = a.unidade || 'un';
            option.textContent = `${a.designacao} (Stock: ${stock} ${a.unidade || 'un'})`;
            artigoSelect.appendChild(option);
        });
        
        console.log(`‚úÖ ${artigosFiltrados.length} artigos da fam√≠lia "${familiaSelecionada}" carregados`);
    }
    
    // Resetar info e resumo
    const info = linha.querySelector('.baixa-linha-info');
    if (info) info.style.display = 'none';
    calcularResumoBaixa();
}

// Atualizar info da linha
function updateLinhaBaixaInfo(linhaId) {
    const linha = document.getElementById(linhaId);
    if (!linha) return;
    
    const select = linha.querySelector('.baixa-artigo-select');
    const info = linha.querySelector('.baixa-linha-info');
    
    if (select.value) {
        const option = select.options[select.selectedIndex];
        const stock = option.dataset.stock;
        const preco = parseFloat(option.dataset.preco);
        const unidade = option.dataset.unidade;
        
        info.style.display = 'block';
        info.innerHTML = `Stock atual: ${stock} ${unidade} | Pre√ßo: ‚Ç¨${preco.toFixed(2)}/${unidade}`;
        
        // Verificar stock baixo
        const artigo = AppState.artigos.find(a => a.id === select.value);
        if (artigo && parseFloat(stock) <= artigo.stockMinimo) {
            info.style.color = '#dc3545';
            info.innerHTML += ' ‚ö†Ô∏è Stock baixo!';
        }
    } else {
        info.style.display = 'none';
    }
    
    calcularResumoBaixa();
}

// Calcular resumo
function calcularResumoBaixa() {
    const linhas = document.querySelectorAll('#baixaMultiplaLinhas > div');
    const resumoDiv = document.getElementById('baixaMultiplaResumo');
    const resumoConteudo = document.getElementById('baixaMultiplaResumoConteudo');
    
    let totalItens = 0;
    let custoTotal = 0;
    const artigos = [];
    
    linhas.forEach(linha => {
        const select = linha.querySelector('.baixa-artigo-select');
        const qtdInput = linha.querySelector('.baixa-quantidade-input');
        
        if (select.value && qtdInput.value) {
            const option = select.options[select.selectedIndex];
            const quantidade = parseFloat(qtdInput.value);
            const preco = parseFloat(option.dataset.preco);
            const unidade = option.dataset.unidade;
            const artigoNome = option.text.split(' (Stock:')[0];
            
            const custo = quantidade * preco;
            custoTotal += custo;
            totalItens++;
            
            artigos.push({ nome: artigoNome, quantidade, unidade, preco, custo });
        }
    });
    
    if (totalItens > 0) {
        resumoDiv.style.display = 'block';
        resumoConteudo.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px;">
                ${artigos.map(a => `
                    <div style="display: flex; justify-content: space-between;">
                        <span>${a.nome} (${a.quantidade} ${a.unidade})</span>
                        <strong>‚Ç¨${a.custo.toFixed(2)}</strong>
                    </div>
                `).join('')}
            </div>
            <div style="padding-top: 8px; border-top: 2px solid #28a745; display: flex; justify-content: space-between; font-size: 16px;">
                <strong>${totalItens} ${totalItens === 1 ? 'artigo' : 'artigos'}</strong>
                <strong style="color: #dc3545;">Total: ‚Ç¨${custoTotal.toFixed(2)}</strong>
            </div>
        `;
    } else {
        resumoDiv.style.display = 'none';
    }
}

// Confirmar baixa m√∫ltipla
async function confirmarBaixaMultipla() {
    const linhas = document.querySelectorAll('#baixaMultiplaLinhas > div');
    const empresa = document.getElementById('baixaMultiplaEmpresa').value;
    const responsavel = document.getElementById('baixaMultiplaResponsavel').value;
    const observacoesGerais = document.getElementById('baixaMultiplaObservacoes').value;
    const otSearch = document.getElementById('baixaMultiplaOTSearch');
    
    // Validar
    if (!responsavel.trim()) {
        showToast('‚ùå Por favor, preencha o respons√°vel!', 'error');
        return;
    }
    
    const movimentos = [];
    let erro = false;
    
    linhas.forEach((linha, index) => {
        const select = linha.querySelector('.baixa-artigo-select');
        const qtdInput = linha.querySelector('.baixa-quantidade-input');
        
        if (!select.value) {
            showToast(`‚ùå Linha ${index + 1}: Selecione um artigo!`, 'error');
            erro = true;
            return;
        }
        
        if (!qtdInput.value || parseFloat(qtdInput.value) <= 0) {
            showToast(`‚ùå Linha ${index + 1}: Quantidade inv√°lida!`, 'error');
            erro = true;
            return;
        }
        
        const artigo = AppState.artigos.find(a => a.id === select.value);
        const quantidade = parseFloat(qtdInput.value);
        
        movimentos.push({
            id: 'MOV' + Date.now() + '_' + index,
            dataHora: new Date().toISOString(),
            artigoId: artigo.id,
            tipo: 'Sa√≠da',
            quantidade: -quantidade,  // Negativo para sa√≠da
            empresa: empresa,
            pedidoId: otSearch.value.trim() || '',  // üî• ID da OT (ou vazio)
            responsavel: responsavel,
            observacoes: observacoesGerais || `Baixa m√∫ltipla - ${artigo.designacao}`
        });
    });
    
    if (erro || movimentos.length === 0) {
        return;
    }
    
    // Confirmar
    const totalMovimentos = movimentos.length;
    if (!confirm(`Confirmar baixa de ${totalMovimentos} ${totalMovimentos === 1 ? 'artigo' : 'artigos'}?`)) {
        return;
    }
    
    try {
        // Processar todos os movimentos
        for (const movimento of movimentos) {
            AppState.movimentos.unshift(movimento);
            
            // Sincronizar com Supabase
            const syncedId = await syncMovimentoToGoogleSheets(movimento);
            if (syncedId) {
                movimento.id = syncedId;
            }
        }
        
        saveToLocalStorage();
        showToast(`‚úÖ ${totalMovimentos} ${totalMovimentos === 1 ? 'artigo dado' : 'artigos dados'} baixa com sucesso!`, 'success');
        
        // Atualizar hist√≥rico se necess√°rio
        if (selectedArtigoHistorico) {
            renderMovimentosByArtigo();
        }
        
        // Recarregar OT se estava aberta
        if (baixaMultiplaOTSelecionada) {
            closeModal();
            setTimeout(() => openRequestDetails(baixaMultiplaOTSelecionada), 300);
        }
        
        closeBaixaMultiplaModal();
        
    } catch (error) {
        console.error('‚ùå Erro ao processar baixas:', error);
        showToast('‚ùå Erro ao processar baixas!', 'error');
    }
}

// Dar baixa r√°pida
async function darBaixaRapida(artigoId) {
    const artigo = AppState.artigos.find(a => a.id === artigoId);
    if (!artigo) return;
    
    const stockAtual = calcularStockAtual(artigoId);
    const quantidade = prompt(`Dar baixa de ${artigo.designacao}\n\nStock atual: ${stockAtual} ${artigo.unidade || 'un'}\n\nQuantidade a dar baixa:`, '1');
    
    if (!quantidade || isNaN(quantidade) || parseInt(quantidade) <= 0) {
        return;
    }
    
    const qtd = parseInt(quantidade);
    
    if (qtd > artigo.stockAtual) {
        alert(`‚ùå Quantidade inv√°lida!\n\nStock dispon√≠vel: ${artigo.stockAtual} ${artigo.unidade}\nQuantidade solicitada: ${qtd} ${artigo.unidade}`);
        return;
    }
    
    const responsavel = prompt('Respons√°vel:', '');
    const observacoes = prompt('Observa√ß√µes (opcional):', '');
    
    // Registar movimento
    const movimento = {
        id: 'MOV' + Date.now(),
        dataHora: new Date(),
        artigoId: artigo.id,
        tipo: 'Sa√≠da',
        quantidade: -qtd,
        empresa: 'MCF',
        pedidoId: '',
        responsavel: responsavel || '-',
        observacoes: observacoes || 'Baixa r√°pida'
    };
    
    AppState.movimentos.unshift(movimento);
    artigo.stockAtual -= qtd;
    
    // ‚úÖ SINCRONIZAR COM GOOGLE SHEETS
    const syncedId = await syncMovimentoToGoogleSheets(movimento);
    if (syncedId) {
        movimento.id = syncedId;
    }
    
    showToast(`‚úÖ Baixa registada: ${qtd} ${artigo.unidade} de ${artigo.designacao}`, 'success');
    
    // Atualizar visualiza√ß√µes
    searchArtigos(document.getElementById('stockSearchInput').value);
    if (selectedArtigoHistorico) {
        renderMovimentosByArtigo(); // Atualizar hist√≥rico se tiver artigo selecionado
    }
    saveToLocalStorage();
}

// Renderizar movimentos
// üÜï Fun√ß√£o antiga removida - agora usa renderMovimentosByArtigo()

// ‚úÖ v3.6.16: Renderizar alertas de stock m√≠nimo (CORRIGIDO)
function renderStockMinimo() {
    const container = document.getElementById('stockMinimoContent');
    if (!container) return;
    
    // Filtrar artigos abaixo do m√≠nimo (calcular stock em tempo real)
    const alertas = AppState.artigos.filter(a => {
        const stockAtual = calcularStockAtual(a.id);
        return a.stockMinimo > 0 && stockAtual < a.stockMinimo;
    });
    
    // Atualizar badge no bot√£o da tab Stock
    const badge = document.getElementById('stockAlertBadge');
    if (badge) {
        if (alertas.length > 0) {
            badge.textContent = alertas.length;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }
    
    // Se n√£o h√° alertas, mostrar mensagem positiva
    if (alertas.length === 0) {
        container.innerHTML = `
            <div class="empty-state-small" style="color: var(--color-success); background: #e8f5e9; padding: var(--spacing-lg); border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 8px;">‚úÖ</div>
                <strong>Todos os stocks est√£o acima do m√≠nimo!</strong>
                <p style="margin-top: 8px; color: var(--color-text-secondary);">Nenhum artigo requer aten√ß√£o imediata.</p>
            </div>
        `;
        return;
    }
    
    // Ordenar por criticidade: stock=0 primeiro, depois por % de falta
    alertas.sort((a, b) => {
        const stockAtualA = calcularStockAtual(a.id);
        const stockAtualB = calcularStockAtual(b.id);
        if (stockAtualA === 0 && stockAtualB !== 0) return -1;
        if (stockAtualA !== 0 && stockAtualB === 0) return 1;
        const faltaA = (a.stockMinimo - stockAtualA) / a.stockMinimo;
        const faltaB = (b.stockMinimo - stockAtualB) / b.stockMinimo;
        return faltaB - faltaA;
    });
    
    // Renderizar tabela
    let html = `
        <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-sm); background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
            <strong>‚ö†Ô∏è ${alertas.length} artigo(s) abaixo do stock m√≠nimo</strong>
        </div>
        <div class="stock-table-container" style="max-height: 500px; overflow-y: auto;">
            <table class="stock-table">
                <thead>
                    <tr>
                        <th style="min-width: 200px;">Artigo</th>
                        <th style="min-width: 120px;">Fam√≠lia</th>
                        <th style="text-align: center; min-width: 100px;">Stock Atual</th>
                        <th style="text-align: center; min-width: 100px;">Stock M√≠nimo</th>
                        <th style="text-align: center; min-width: 80px;">Falta</th>
                        <th style="text-align: center; min-width: 100px;">Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    alertas.forEach(artigo => {
        const stockAtual = calcularStockAtual(artigo.id);
        const falta = artigo.stockMinimo - stockAtual;
        const isCritico = stockAtual === 0;
        const statusClass = isCritico ? 'badge-critico' : 'badge-alerta';
        const statusIcon = isCritico ? 'üî¥' : '‚ö†Ô∏è';
        const statusText = isCritico ? 'Cr√≠tico' : 'Baixo';
        
        html += `
            <tr style="${isCritico ? 'background: #ffebee;' : ''}">
                <td>
                    <strong>${artigo.designacao}</strong><br>
                    <small style="color: var(--color-text-secondary);">Ref: ${artigo.referencia}</small>
                </td>
                <td>${artigo.familia}</td>
                <td style="text-align: center;">
                    <strong style="color: ${isCritico ? '#d32f2f' : '#f57c00'}; font-size: 1.1rem;">
                        ${stockAtual}
                    </strong>
                </td>
                <td style="text-align: center;">${artigo.stockMinimo}</td>
                <td style="text-align: center;">
                    <strong style="color: #d32f2f;">-${falta}</strong>
                </td>
                <td style="text-align: center;">
                    <span class="badge ${statusClass}">${statusIcon} ${statusText}</span>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

function formatDateTime(date) {
    const d = new Date(date);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    const hours = String(d.getHours()).padStart(2, '0');
    const minutes = String(d.getMinutes()).padStart(2, '0');
    return `${day}/${month}/${year} ${hours}:${minutes}`;
}

// Editar movimento
async function editarMovimento(movId) {
    const mov = AppState.movimentos.find(m => m.id === movId);
    if (!mov) return;
    
    const artigo = AppState.artigos.find(a => a.id === mov.artigoId);
    
    const novaQtd = prompt(`Editar Movimento\n\nArtigo: ${artigo ? artigo.designacao : mov.artigoId}\nTipo: ${mov.tipo}\nQuantidade atual: ${mov.quantidade}\n\nNova quantidade:`, Math.abs(mov.quantidade));
    
    if (!novaQtd || isNaN(novaQtd)) return;
    
    const qtd = parseInt(novaQtd);
    const novasObs = prompt('Observa√ß√µes:', mov.observacoes);
    
    // Reverter movimento antigo
    if (artigo) {
        artigo.stockAtual -= mov.quantidade;
    }
    
    // Aplicar novo movimento
    const diferencaQtd = (mov.tipo === 'SA√çDA' ? -Math.abs(qtd) : Math.abs(qtd)) - mov.quantidade;
    mov.quantidade = mov.tipo === 'SA√çDA' ? -Math.abs(qtd) : Math.abs(qtd);
    mov.observacoes = novasObs || mov.observacoes;
    
    if (artigo) {
        artigo.stockAtual += mov.quantidade;
    }
    
    // ‚ö†Ô∏è NOTA: Google Sheets n√£o suporta edi√ß√£o direta de movimentos
    // Solu√ß√£o: Criar novo movimento de ajuste com a diferen√ßa
    if (AppState.isOnline && diferencaQtd !== 0) {
        const movimentoAjuste = {
            artigoId: mov.artigoId,
            tipo: 'AJUSTE',
            quantidade: diferencaQtd,
            responsavel: 'Sistema',
            observacoes: `Ajuste por edi√ß√£o do movimento ${movId}`
        };
        await syncMovimentoToGoogleSheets(movimentoAjuste);
    }
    
    showToast('‚úÖ Movimento atualizado!', 'success');
    if (selectedArtigoHistorico) {
        renderMovimentosByArtigo(); // Atualizar hist√≥rico se tiver artigo selecionado
    }
    searchArtigos(document.getElementById('stockSearchInput').value);
    saveToLocalStorage();
}

// Eliminar movimento
async function eliminarMovimento(movId) {
    if (!confirm('Tem a certeza que deseja eliminar este movimento?')) return;
    
    const mov = AppState.movimentos.find(m => m.id === movId);
    if (!mov) return;
    
    const artigo = AppState.artigos.find(a => a.id === mov.artigoId);
    
    // Reverter o movimento no stock
    if (artigo) {
        artigo.stockAtual -= mov.quantidade;
    }
    
    // ‚ö†Ô∏è NOTA: Google Sheets n√£o suporta elimina√ß√£o direta de movimentos
    // Solu√ß√£o: Criar movimento de ajuste inverso
    if (AppState.isOnline) {
        const movimentoInverso = {
            artigoId: mov.artigoId,
            tipo: 'AJUSTE',
            quantidade: -mov.quantidade, // Inverso
            responsavel: 'Sistema',
            observacoes: `Revers√£o por elimina√ß√£o do movimento ${movId}`
        };
        await syncMovimentoToGoogleSheets(movimentoInverso);
    }
    
    // Remover movimento localmente
    AppState.movimentos = AppState.movimentos.filter(m => m.id !== movId);
    
    showToast('‚úÖ Movimento eliminado!', 'success');
    if (selectedArtigoHistorico) {
        renderMovimentosByArtigo(); // Atualizar hist√≥rico se tiver artigo selecionado
    }
    searchArtigos(document.getElementById('stockSearchInput').value);
    saveToLocalStorage();
}

async function handleMovimentoSubmit(e) {
    e.preventDefault();
    
    if (!AppState.artigoSelecionado) return;
    
    const tipo = document.getElementById('movimentoTipo').value;
    let quantidade = parseInt(document.getElementById('movimentoQuantidade').value);
    const empresa = document.getElementById('movimentoEmpresa').value;
    const responsavel = document.getElementById('movimentoResponsavel').value || '-';
    const observacoes = document.getElementById('movimentoObservacoes').value || '';
    
    // ‚úÖ v3.6.17: Normalizar tipo para formato do Supabase
    let tipoNormalizado = tipo;
    if (tipo === 'SA√çDA') tipoNormalizado = 'Sa√≠da';
    else if (tipo === 'ENTRADA') tipoNormalizado = 'Entrada';
    else if (tipo === 'BAIXA') tipoNormalizado = 'Baixa';
    
    // Quantidade sempre positiva (o tipo define entrada/sa√≠da)
    quantidade = Math.abs(quantidade);
    
    const artigo = AppState.artigos.find(a => a.id === AppState.artigoSelecionado.id);
    if (!artigo) {
        showToast('‚ùå Artigo n√£o encontrado', 'error');
        return;
    }
    
    // ‚úÖ Verificar stock atual ANTES de permitir sa√≠da
    const stockAtual = calcularStockAtual(artigo.id);
    
    // ‚ö†Ô∏è PERMITIR STOCK NEGATIVO (para identificar erros de invent√°rio)
    if (tipoNormalizado === 'Sa√≠da' || tipoNormalizado === 'Baixa') {
        const novoStock = stockAtual - quantidade;
        if (novoStock < 0) {
            console.warn(`‚ö†Ô∏è Stock ficar√° negativo: ${stockAtual} - ${quantidade} = ${novoStock}`);
            // N√ÉO bloquear - permitir para identificar erros
        }
    }
    
    // Registar movimento
    const movimento = {
        id: 'MOV' + Date.now(),
        dataHora: new Date().toISOString(),
        artigoId: artigo.id,
        tipo: tipoNormalizado,  // ‚úÖ Usar tipo normalizado
        quantidade: quantidade,  // ‚úÖ Sempre positivo
        empresa: empresa,
        pedidoId: '',
        responsavel: responsavel,
        observacoes: observacoes
    };
    
    AppState.movimentos.unshift(movimento);
    
    // ‚úÖ SINCRONIZAR COM SUPABASE
    try {
        const syncedId = await syncMovimentoToGoogleSheets(movimento);
        if (syncedId) {
            movimento.id = syncedId;
        }
        
        // Mostrar notifica√ß√£o
        const novoStock = calcularStockAtual(artigo.id);
        showToast(`‚úÖ Movimento registado: ${tipoNormalizado} de ${quantidade} ${artigo.unidade || 'un'}. Stock atual: ${novoStock}`, 'success');
        
        // Fechar modal
        closeMovimentoModal();
        
        // Re-renderizar
        if (selectedArtigoHistorico) {
            renderMovimentosByArtigo(); // Atualizar hist√≥rico se tiver artigo selecionado
        }
        searchArtigos(document.getElementById('stockSearchInput').value);
        saveToLocalStorage();
        
    } catch (error) {
        console.error('‚ùå Erro ao registar movimento:', error);
        showToast('‚ùå Erro ao guardar movimento', 'error');
    }
}

// EXPOSI√á√ÉO GLOBAL
window.openRequestDetails = openRequestDetails;
window.closeModal = closeModal;
window.changeRequestState = changeRequestState;
window.deleteRequest = deleteRequest;
window.clearImagePreview = clearImagePreview;
window.toggleAllocation = toggleAllocation;
window.updateTaskHours = updateTaskHours;
// ‚ùå REMOVIDO - Fun√ß√£o n√£o existe
// window.openMovimentoModal = openMovimentoModal;
// window.closeMovimentoModal = closeMovimentoModal;
window.adjustQuantidade = adjustQuantidade;
window.updateArtigoInfo = updateArtigoInfo;
window.filtrarArtigosPorFamilia = filtrarArtigosPorFamilia;
window.searchArtigos = searchArtigos;
window.clearStockSearch = clearStockSearch;
window.darBaixaRapida = darBaixaRapida;
// ‚ùå REMOVIDO - Fun√ß√£o foi substitu√≠da por renderMovimentosByArtigo()
// window.renderMovimentos = renderMovimentos;
window.editarMovimento = editarMovimento;
window.eliminarMovimento = eliminarMovimento;
window.openNovoMovimentoModal = openNovoMovimentoModal;

// ================================================
// üìä TAB AN√ÅLISE - v3.7.0
// ================================================

// Vari√°veis globais dos gr√°ficos
let chartPedidosPorSemana = null;
let chartEvolucaoBacklog = null;
let chartPedidosPorUtilizador = null;  // ‚úÖ v3.7.0.9: NOVO gr√°fico

// ‚úÖ Per√≠odo selecionado para gr√°fico por utilizador (em dias)
let periodoUtilizadorSelecionado = 7; // Default: √∫ltima semana

// ===================================
// FUN√á√ïES DE PROCESSAMENTO DE DADOS
// ===================================

/**
 * Obter n√∫mero da semana do ano (ISO 8601)
 */
function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

/**
 * Formatar data da semana (ex: "Sem 47 (18-24 Nov)")
 */
function formatWeekLabel(year, week) {
    // Calcular o primeiro dia da semana
    const simple = new Date(year, 0, 1 + (week - 1) * 7);
    const dow = simple.getDay();
    const ISOweekStart = simple;
    if (dow <= 4)
        ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
    else
        ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
    
    const endWeek = new Date(ISOweekStart);
    endWeek.setDate(endWeek.getDate() + 6);
    
    const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    
    return `Sem ${week} (${ISOweekStart.getDate()} ${months[ISOweekStart.getMonth()]})`;
}

/**
 * Processar dados de ordens de trabalho por semana
 */
function processarDadosPorSemana(numSemanas = 12, empresaFiltro = '') {
    const hoje = new Date();
    const anoAtual = hoje.getFullYear();
    const semanaAtual = getWeekNumber(hoje);
    
    // Criar array de semanas
    const semanas = [];
    for (let i = numSemanas - 1; i >= 0; i--) {
        let ano = anoAtual;
        let semana = semanaAtual - i;
        
        if (semana <= 0) {
            ano--;
            semana += 52; // Aproxima√ß√£o (52 semanas por ano)
        }
        
        semanas.push({
            ano,
            semana,
            label: formatWeekLabel(ano, semana),
            abertos: 0,
            fechados: 0
        });
    }
    
    // Filtrar pedidos
    const pedidosFiltrados = empresaFiltro 
        ? AppState.requests.filter(r => r.empresa === empresaFiltro)
        : AppState.requests;
    
    // Contar pedidos por semana
    pedidosFiltrados.forEach(pedido => {
        const data = new Date(pedido.dataHora);
        const ano = data.getFullYear();
        const semana = getWeekNumber(data);
        
        const semanaData = semanas.find(s => s.ano === ano && s.semana === semana);
        if (semanaData) {
            semanaData.abertos++;
            if (pedido.estado === 'Resolvido') {
                semanaData.fechados++;
            }
        }
    });
    
    return semanas;
}

/**
 * Processar evolu√ß√£o do backlog
 */
function processarEvolucaoBacklog(numSemanas = 12, empresaFiltro = '') {
    const hoje = new Date();
    const anoAtual = hoje.getFullYear();
    const semanaAtual = getWeekNumber(hoje);
    
    // Criar array de semanas
    const semanas = [];
    for (let i = numSemanas - 1; i >= 0; i--) {
        let ano = anoAtual;
        let semana = semanaAtual - i;
        
        if (semana <= 0) {
            ano--;
            semana += 52;
        }
        
        semanas.push({
            ano,
            semana,
            label: formatWeekLabel(ano, semana),
            backlog: 0
        });
    }
    
    // Filtrar pedidos
    const pedidosFiltrados = empresaFiltro 
        ? AppState.requests.filter(r => r.empresa === empresaFiltro)
        : AppState.requests;
    
    // Calcular backlog acumulado por semana
    semanas.forEach((semanaData, index) => {
        // Contar pedidos abertos at√© esta semana que ainda n√£o foram resolvidos
        const backlog = pedidosFiltrados.filter(pedido => {
            const dataPedido = new Date(pedido.dataHora);
            const anoPedido = dataPedido.getFullYear();
            const semanaPedido = getWeekNumber(dataPedido);
            
            // Pedido foi criado antes ou na semana atual?
            const criadoAntes = (anoPedido < semanaData.ano) || 
                               (anoPedido === semanaData.ano && semanaPedido <= semanaData.semana);
            
            // Pedido ainda n√£o est√° resolvido OU foi resolvido depois desta semana?
            const naoResolvido = pedido.estado !== 'Resolvido';
            
            return criadoAntes && naoResolvido;
        }).length;
        
        semanaData.backlog = backlog;
    });
    
    return semanas;
}

/**
 * Calcular m√©tricas da semana atual
 */
function calcularMetricasSemana(empresaFiltro = '') {
    const hoje = new Date();
    const anoAtual = hoje.getFullYear();
    const semanaAtual = getWeekNumber(hoje);
    
    // Filtrar pedidos
    const pedidosFiltrados = empresaFiltro 
        ? AppState.requests.filter(r => r.empresa === empresaFiltro)
        : AppState.requests;
    
    // Contar ordens de trabalho desta semana
    const pedidosEstaSemana = pedidosFiltrados.filter(p => {
        const data = new Date(p.dataHora);
        return data.getFullYear() === anoAtual && getWeekNumber(data) === semanaAtual;
    });
    
    // Abertos = Novo + Em curso (N√ÉO resolvidos)
    const abertos = pedidosEstaSemana.filter(p => p.estado !== 'Resolvido').length;
    const fechados = pedidosEstaSemana.filter(p => p.estado === 'Resolvido').length;
    
    // Calcular backlog total atual (todos os pedidos n√£o resolvidos)
    const backlogTotal = pedidosFiltrados.filter(p => p.estado !== 'Resolvido').length;
    
    // Tend√™ncia do backlog (comparar com semana anterior)
    const semanaAnterior = processarEvolucaoBacklog(2, empresaFiltro);
    const backlogAnterior = semanaAnterior.length >= 2 ? semanaAnterior[0].backlog : backlogTotal;
    const tendencia = backlogTotal - backlogAnterior;
    
    return {
        abertos,
        fechados,
        backlogTotal,
        tendencia
    };
}

/**
 * ‚úÖ v3.7.0.9: Processar pedidos fechados por utilizador
 * @param {string} empresaFiltro - Filtro por empresa
 * @param {number} dias - N√∫mero de dias a considerar (7, 30, 180, 365)
 */
function processarPedidosPorUtilizador(empresaFiltro = '', dias = 7) {
    const hoje = new Date();
    const dataLimite = new Date(hoje);
    dataLimite.setDate(dataLimite.getDate() - dias);
    
    // Filtrar pedidos
    const pedidosFiltrados = empresaFiltro 
        ? AppState.requests.filter(r => r.empresa === empresaFiltro)
        : AppState.requests;
    
    // Pedidos fechados no per√≠odo
    const pedidosFechados = pedidosFiltrados.filter(p => {
        const data = new Date(p.dataHora);
        return p.estado === 'Resolvido' && data >= dataLimite;
    });
    
    // Contar por respons√°vel
    const porUtilizador = {};
    pedidosFechados.forEach(p => {
        const responsavel = p.responsavel || 'Sem respons√°vel';
        porUtilizador[responsavel] = (porUtilizador[responsavel] || 0) + 1;
    });
    
    // Converter para array e ordenar
    const dados = Object.entries(porUtilizador)
        .map(([nome, count]) => ({ nome, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 10); // Top 10
    
    return dados;
}

// ===================================
// FUN√á√ïES DE RENDERIZA√á√ÉO DE GR√ÅFICOS
// ===================================

/**
 * Criar/atualizar gr√°fico de ordens de trabalho por semana
 */
function renderizarGraficoPedidosPorSemana(dados) {
    try {
        const ctx = document.getElementById('chartPedidosPorSemana');
        if (!ctx) {
            console.error('‚ùå Canvas chartPedidosPorSemana n√£o encontrado!');
            return;
        }
        
        // Destruir gr√°fico anterior se existir
        if (chartPedidosPorSemana) {
            chartPedidosPorSemana.destroy();
        }
        
        if (typeof Chart === 'undefined') {
            console.error('‚ùå Chart.js n√£o est√° carregado!');
            return;
        }
        
        chartPedidosPorSemana = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dados.map(d => d.label),
            datasets: [
                {
                    label: 'Ordens Abertas',
                    data: dados.map(d => d.abertos),
                    backgroundColor: 'rgba(255, 152, 0, 0.7)',
                    borderColor: 'rgba(255, 152, 0, 1)',
                    borderWidth: 2,
                    borderRadius: 6
                },
                {
                    label: 'Ordens Fechadas',
                    data: dados.map(d => d.fechados),
                    backgroundColor: 'rgba(76, 175, 80, 0.7)',
                    borderColor: 'rgba(76, 175, 80, 1)',
                    borderWidth: 2,
                    borderRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: {
                            family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto',
                            size: 12
                        },
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' pedidos';
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });
    } catch (error) {
        console.error('‚ùå Erro ao renderizar gr√°fico por semana:', error);
    }
}

/**
 * Criar/atualizar gr√°fico de evolu√ß√£o do backlog
 */
function renderizarGraficoEvolucaoBacklog(dados) {
    try {
        const ctx = document.getElementById('chartEvolucaoBacklog');
        if (!ctx) {
            console.error('‚ùå Canvas chartEvolucaoBacklog n√£o encontrado!');
            return;
        }
    
    // Destruir gr√°fico anterior se existir
    if (chartEvolucaoBacklog) {
        chartEvolucaoBacklog.destroy();
    }
    
    chartEvolucaoBacklog = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dados.map(d => d.label),
            datasets: [
                {
                    label: 'Backlog (Ordens Pendentes)',
                    data: dados.map(d => d.backlog),
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    borderColor: 'rgba(33, 150, 243, 1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgba(33, 150, 243, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: {
                            family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto',
                            size: 12
                        },
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            return 'Backlog: ' + context.parsed.y + ' pedidos';
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });
    } catch (error) {
        console.error('‚ùå Erro ao renderizar gr√°fico backlog:', error);
    }
}

/**
 * ‚úÖ v3.7.0.9: Criar/atualizar gr√°fico de ordens de trabalho fechadas por utilizador
 */
function renderizarGraficoPedidosPorUtilizador(dados) {
    try {
        const ctx = document.getElementById('chartPedidosPorUtilizador');
        if (!ctx) {
            console.error('‚ùå Canvas chartPedidosPorUtilizador n√£o encontrado!');
            return;
        }
    
    // Destruir gr√°fico anterior se existir
    if (chartPedidosPorUtilizador) {
        chartPedidosPorUtilizador.destroy();
    }
    
    if (dados.length === 0) {
        // Mostrar mensagem se n√£o h√° dados
        ctx.parentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhuma ordem de trabalho fechada esta semana</p>';
        return;
    }
    
    chartPedidosPorUtilizador = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dados.map(d => d.nome),
            datasets: [
                {
                    label: 'Ordens Fechadas',
                    data: dados.map(d => d.count),
                    backgroundColor: 'rgba(76, 175, 80, 0.7)',
                    borderColor: 'rgba(76, 175, 80, 1)',
                    borderWidth: 2,
                    borderRadius: 6
                }
            ]
        },
        options: {
            indexAxis: 'y',  // Horizontal bar
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            return context.parsed.x + ' pedidos fechados';
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
    } catch (error) {
        console.error('‚ùå Erro ao renderizar gr√°fico por utilizador:', error);
    }
}

/**
 * Atualizar cards de m√©tricas
 */
function atualizarCardsMetricas(metricas) {
    // Abertos esta semana
    const abertosEl = document.getElementById('abertosEstaSemana');
    if (abertosEl) {
        abertosEl.textContent = metricas.abertos || 0;
    }
    
    // Fechados esta semana
    const fechadosEl = document.getElementById('fechadosEstaSemana');
    if (fechadosEl) {
        fechadosEl.textContent = metricas.fechados || 0;
    }
    
    // Backlog total
    const backlogEl = document.getElementById('backlogTotal');
    if (backlogEl) {
        backlogEl.textContent = metricas.backlogTotal || 0;
    }
    
    // Tend√™ncia do backlog
    const trendEl = document.getElementById('backlogTrend');
    if (trendEl) {
        if (metricas.tendencia > 0) {
            trendEl.innerHTML = `<span style="color: #FF3B30;">‚Üë +${metricas.tendencia} vs semana anterior</span>`;
        } else if (metricas.tendencia < 0) {
            trendEl.innerHTML = `<span style="color: #34C759;">‚Üì ${metricas.tendencia} vs semana anterior</span>`;
        } else {
            trendEl.innerHTML = `<span style="color: var(--color-text-secondary);">‚Üí Sem altera√ß√£o</span>`;
        }
    }
}

/**
 * Fun√ß√£o principal para atualizar an√°lises
 */
window.atualizarAnalises = function() {
    try {
        // Verificar se h√° pedidos
        if (!AppState.requests || AppState.requests.length === 0) {
            // Mostrar 0 nos cards se n√£o houver dados
            document.getElementById('abertosEstaSemana').textContent = '0';
            document.getElementById('fechadosEstaSemana').textContent = '0';
            document.getElementById('backlogTotal').textContent = '0';
            return;
        }
        
        // Obter filtros
        const empresaFiltro = document.getElementById('analiseEmpresaFilter')?.value || '';
        const numSemanas = parseInt(document.getElementById('analisePeriodoFilter')?.value || '12');
        
        // Processar dados
        const dadosPorSemana = processarDadosPorSemana(numSemanas, empresaFiltro);
        const dadosBacklog = processarEvolucaoBacklog(numSemanas, empresaFiltro);
        const dadosPorUtilizador = processarPedidosPorUtilizador(empresaFiltro, periodoUtilizadorSelecionado);
        const metricas = calcularMetricasSemana(empresaFiltro);
        
        console.log('‚úÖ M√©tricas calculadas:', metricas);
        
        // Renderizar gr√°ficos
        renderizarGraficoPedidosPorSemana(dadosPorSemana);
        renderizarGraficoEvolucaoBacklog(dadosBacklog);
        renderizarGraficoPedidosPorUtilizador(dadosPorUtilizador);
        
        // Atualizar m√©tricas
        atualizarCardsMetricas(metricas);
        
        showToast('‚úÖ An√°lises atualizadas!', 'success');
        
    } catch (error) {
        console.error('‚ùå Erro em atualizarAnalises():', error);
        showToast('‚ùå Erro ao atualizar an√°lises: ' + error.message, 'error');
    }
};

/**
 * ‚úÖ Filtrar gr√°fico por utilizador por per√≠odo
 */
window.filtrarPorUtilizadorPeriodo = function(dias) {
    // Atualizar vari√°vel global
    periodoUtilizadorSelecionado = dias;
    
    // Atualizar bot√µes ativos
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (parseInt(btn.getAttribute('data-period')) === dias) {
            btn.classList.add('active');
        }
    });
    
    // Reprocessar dados e atualizar gr√°fico
    const empresaFiltro = document.getElementById('analiseEmpresaFilter')?.value || '';
    const dadosPorUtilizador = processarPedidosPorUtilizador(empresaFiltro, dias);
    renderizarGraficoPedidosPorUtilizador(dadosPorUtilizador);
    
    // Atualizar t√≠tulo do gr√°fico com per√≠odo
    const titulos = {
        7: '√öltima Semana',
        30: '√öltimo M√™s',
        180: '√öltimos 6 Meses',
        365: '√öltimo Ano'
    };
    console.log(`üìä Gr√°fico atualizado: ${titulos[dias]}`);
};

// ===================================
// CHATBOT COM GEMINI AI
// ===================================

// URL do Cloudflare Worker (ser√° configurado depois)
const CHATBOT_WORKER_URL = 'https://chatbot-manutencao.goncalobarata.workers.dev/chat';

/**
 * Adicionar mensagem ao hist√≥rico do chat
 */
function adicionarMensagemChat(mensagem, tipo = 'user') {
    const history = document.getElementById('chatbotHistory');
    if (!history) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `chatbot-message chatbot-message-${tipo}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'chatbot-message-content';
    
    // üÜï v3.7.6.0: Detectar e renderizar imagens de tabelas/diagramas
    // Formato: üìä [TABLE 1]: https://...url.../page_049_table_00.png
    const imageRegex = /([üìäüñºÔ∏è])\s*\[(TABLE|DIAGRAM)\s+\d+\]:\s*(https?:\/\/[^\s]+)/gi;
    const imagesFound = [];
    let mensagemSemImagens = mensagem;
    
    let match;
    while ((match = imageRegex.exec(mensagem)) !== null) {
        const [fullMatch, emoji, type, url] = match;
        imagesFound.push({ emoji, type, url, fullMatch });
        // Remover refer√™ncia de imagem do texto principal
        mensagemSemImagens = mensagemSemImagens.replace(fullMatch, '');
    }
    
    // Suportar markdown b√°sico (negrito, it√°lico, listas)
    let htmlContent = mensagemSemImagens
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n- /g, '\n‚Ä¢ ')
        .replace(/\n/g, '<br>');
    
    contentDiv.innerHTML = htmlContent;
    
    // üÜï Adicionar imagens encontradas
    if (imagesFound.length > 0 && tipo === 'bot') {
        const imagesContainer = document.createElement('div');
        imagesContainer.style.cssText = 'margin-top: 10px; display: flex; flex-direction: column; gap: 10px;';
        
        imagesFound.forEach(({ emoji, type, url }) => {
            const imageWrapper = document.createElement('div');
            imageWrapper.style.cssText = 'border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; background: #f9f9f9;';
            
            const imageTitle = document.createElement('div');
            imageTitle.style.cssText = 'font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 500;';
            imageTitle.textContent = `${emoji} ${type.charAt(0) + type.slice(1).toLowerCase()}`;
            
            const img = document.createElement('img');
            img.src = url;
            img.alt = type;
            img.style.cssText = 'max-width: 100%; height: auto; border-radius: 4px; cursor: pointer;';
            img.onclick = () => window.open(url, '_blank');
            img.title = 'Clique para ampliar';
            
            imageWrapper.appendChild(imageTitle);
            imageWrapper.appendChild(img);
            imagesContainer.appendChild(imageWrapper);
        });
        
        contentDiv.appendChild(imagesContainer);
    }
    
    messageDiv.appendChild(contentDiv);
    history.appendChild(messageDiv);
    
    // Scroll para baixo
    history.scrollTop = history.scrollHeight;
}

/**
 * Mostrar/esconder status de loading
 */
function mostrarChatbotStatus(mostrar = true) {
    const status = document.getElementById('chatbotStatus');
    if (status) {
        status.style.display = mostrar ? 'flex' : 'none';
    }
}

/**
 * Preparar contexto dos dados para o chatbot
 * ‚úÖ v3.7.1.9 - CONTEXTO ADAPTATIVO (envia apenas dados relevantes √† pergunta)
 */
function prepararContextoDados(pergunta = '') {
    const agora = new Date();
    const umMesAtras = new Date(agora.getTime() - 30 * 24 * 60 * 60 * 1000);
    const umaSemanaAtras = new Date(agora.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    // ===================================
    // 1. RESUMO GERAL (sempre enviado)
    // ===================================
    const totalPedidos = AppState.requests.length;
    const pedidosAbertos = AppState.requests.filter(p => p.estado !== 'Resolvido').length;
    const pedidosResolvidos = AppState.requests.filter(p => p.estado === 'Resolvido').length;
    
    // Por empresa
    const pedidosMCF = AppState.requests.filter(p => p.empresa === 'MCF').length;
    const pedidosPSY = AppState.requests.filter(p => p.empresa === 'PSY').length;
    
    // Por tipo
    const tipos = {};
    AppState.requests.forEach(p => {
        tipos[p.tipo] = (tipos[p.tipo] || 0) + 1;
    });
    
    // Top √°reas (√∫ltimos 30 dias)
    const pedidosRecentes = AppState.requests.filter(p => {
        const dataPedido = new Date(p.dataHora);
        return dataPedido >= umMesAtras;
    });
    
    const areas = {};
    pedidosRecentes.forEach(p => {
        if (p.areaEquipamento) {
            areas[p.areaEquipamento] = (areas[p.areaEquipamento] || 0) + 1;
        }
    });
    const topAreas = Object.entries(areas)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([area, count]) => `${area}: ${count} pedidos`);
    
    // ===================================
    // 2. CONTEXTO ADAPTATIVO (baseado na pergunta)
    // ===================================
    const perguntaLower = pergunta.toLowerCase();
    let pedidosFiltrados = [];
    let filtroAplicado = 'geral';
    
    // üîç Detectar EQUIPAMENTO/√ÅREA espec√≠fica
    const equipamentosMencionados = Object.keys(areas).filter(area => 
        perguntaLower.includes(area.toLowerCase())
    );
    
    if (equipamentosMencionados.length > 0) {
        // ‚úÖ Filtrar por equipamento mencionado
        pedidosFiltrados = AppState.requests.filter(p => 
            equipamentosMencionados.some(eq => 
                p.areaEquipamento && p.areaEquipamento.toLowerCase().includes(eq.toLowerCase())
            )
        ).slice(0, 30);  // M√°ximo 30 pedidos do equipamento
        filtroAplicado = `equipamento: ${equipamentosMencionados.join(', ')}`;
    }
    // üîç Detectar EMPRESA (MCF ou PSY)
    else if (perguntaLower.includes('mcf') && !perguntaLower.includes('psy')) {
        pedidosFiltrados = AppState.requests
            .filter(p => p.empresa === 'MCF')
            .slice(0, 20);
        filtroAplicado = 'empresa: MCF';
    }
    else if (perguntaLower.includes('psy') && !perguntaLower.includes('mcf')) {
        pedidosFiltrados = AppState.requests
            .filter(p => p.empresa === 'PSY')
            .slice(0, 20);
        filtroAplicado = 'empresa: PSY';
    }
    // üîç Detectar URGENTES
    else if (perguntaLower.includes('urgente') || perguntaLower.includes('prioridade')) {
        pedidosFiltrados = AppState.requests
            .filter(p => p.urgente === 'Sim' || p.prioridade === 'Alta')
            .slice(0, 20);
        filtroAplicado = 'urgentes/prioridade alta';
    }
    // üîç Detectar PER√çODO (√∫ltima semana, m√™s, etc.)
    else if (perguntaLower.includes('√∫ltima semana') || perguntaLower.includes('ultima semana')) {
        pedidosFiltrados = AppState.requests
            .filter(p => new Date(p.dataHora) >= umaSemanaAtras)
            .slice(0, 30);
        filtroAplicado = '√∫ltima semana';
    }
    else if (perguntaLower.includes('√∫ltimo m√™s') || perguntaLower.includes('ultimo mes')) {
        pedidosFiltrados = pedidosRecentes.slice(0, 30);
        filtroAplicado = '√∫ltimo m√™s';
    }
    // üîç Detectar ABERTOS
    else if (perguntaLower.includes('aberto') || perguntaLower.includes('pendente')) {
        pedidosFiltrados = AppState.requests
            .filter(p => p.estado !== 'Resolvido')
            .slice(0, 20);
        filtroAplicado = 'pedidos abertos';
    }
    // üîç Perguntas GERAIS (estat√≠sticas)
    else if (perguntaLower.includes('quantos') || perguntaLower.includes('total') || 
             perguntaLower.includes('resumo') || perguntaLower.includes('geral')) {
        // ‚úÖ N√ÉO enviar pedidos detalhados, apenas estat√≠sticas
        pedidosFiltrados = [];
        filtroAplicado = 'estat√≠sticas apenas';
    }
    // üîç Default: √∫ltimos 10 pedidos (se nenhum filtro)
    else {
        pedidosFiltrados = AppState.requests
            .sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora))
            .slice(0, 10);
        filtroAplicado = '√∫ltimos 10 pedidos';
    }
    
    // Mapear campos m√≠nimos
    const pedidosParaEnviar = pedidosFiltrados.map(p => ({
        id: p.id,
        tipo: p.tipo,
        area: p.areaEquipamento,
        empresa: p.empresa,
        estado: p.estado,
        prioridade: p.prioridade,
        urgente: p.urgente,
        data: p.dataHora
    }));
    
    console.log(`ü§ñ Contexto adaptativo: ${filtroAplicado} (${pedidosParaEnviar.length} pedidos)`);
    
    // ===================================
    // 3. RETORNAR CONTEXTO
    // ===================================
    return {
        resumo: {
            total: totalPedidos,
            abertos: pedidosAbertos,
            resolvidos: pedidosResolvidos,
            mcf: pedidosMCF,
            psy: pedidosPSY,
            taxaResolucao: totalPedidos > 0 ? Math.round((pedidosResolvidos / totalPedidos) * 100) : 0
        },
        tipos,
        topAreas,
        // ‚úÖ NOVO: Pedidos filtrados baseados na pergunta
        pedidosRelevantes: pedidosParaEnviar,
        filtroAplicado: filtroAplicado,
        // Estat√≠sticas do √∫ltimo m√™s
        ultimoMes: {
            total: pedidosRecentes.length,
            abertos: pedidosRecentes.filter(p => p.estado !== 'Resolvido').length,
            fechados: pedidosRecentes.filter(p => p.estado === 'Resolvido').length
        },
        // üìö MANUAIS: Adicionar se mencionados na pergunta
        manuais: buscarManuaisRelevantes(pergunta, equipamentosMencionados)
    };
}

/**
 * Buscar manuais relevantes baseados na pergunta
 */
function buscarManuaisRelevantes(pergunta, equipamentosMencionados = []) {
    // Verificar se a pergunta menciona manuais, instru√ß√µes, procedimentos, etc.
    const perguntaLower = pergunta.toLowerCase();
    const palavrasChave = ['manual', 'instru√ß√£o', 'instru√ß√µes', 'procedimento', 'como', 'orienta√ß√£o', 
                           'problema', 'dimensional', 'defeito', 'ajustar', 'regular', 'calibrar'];
    
    const mencionaManual = palavrasChave.some(palavra => perguntaLower.includes(palavra));
    
    if (!mencionaManual && equipamentosMencionados.length === 0) {
        return null;  // N√£o incluir manuais se n√£o forem relevantes
    }
    
    // Se houver manuais carregados no AppState (carregados quando tab √© aberta)
    if (!AppState.manuais || AppState.manuais.length === 0) {
        return {
            disponivel: false,
            mensagem: 'Nenhum manual carregado no sistema ainda.'
        };
    }
    
    // Filtrar manuais relevantes
    let manuaisRelevantes = AppState.manuais;
    
    if (equipamentosMencionados.length > 0) {
        // Filtrar por equipamento mencionado
        manuaisRelevantes = AppState.manuais.filter(m => 
            equipamentosMencionados.some(eq => 
                m.equipamento_nome && m.equipamento_nome.toLowerCase().includes(eq.toLowerCase())
            )
        );
    }
    
    // Se encontrou manuais relevantes, incluir sec√ß√µes de conte√∫do
    if (manuaisRelevantes.length > 0) {
        return {
            disponivel: true,
            quantidade: manuaisRelevantes.length,
            manuais: manuaisRelevantes.map(m => ({
                id: m.id,
                equipamento: m.equipamento_nome,
                titulo: m.titulo,
                descricao: m.descricao,
                num_paginas: m.num_paginas,
                // Incluir conte√∫do se estiver dispon√≠vel
                conteudo: AppState.manuaisConteudo && AppState.manuaisConteudo[m.id] 
                    ? AppState.manuaisConteudo[m.id].map(s => ({
                        titulo: s.secao,  // SQL usa 'secao' n√£o 'titulo'
                        paginas: `${s.pagina_inicio}-${s.pagina_fim}`,
                        texto: s.conteudo.substring(0, 1000)  // SQL usa 'conteudo' n√£o 'texto'
                    }))
                    : []
            }))
        };
    }
    
    return null;
}

/**
 * Enviar pergunta para o chatbot
 */
window.enviarPerguntaChatbot = async function() {
    const input = document.getElementById('chatbotInput');
    const sendBtn = document.getElementById('chatbotSendBtn');
    
    if (!input || !sendBtn) return;
    
    const pergunta = input.value.trim();
    if (!pergunta) return;
    
    // Adicionar pergunta do usu√°rio
    adicionarMensagemChat(pergunta, 'user');
    
    // Limpar input
    input.value = '';
    input.style.height = 'auto';
    
    // Desabilitar bot√£o e mostrar loading
    sendBtn.disabled = true;
    mostrarChatbotStatus(true);
    
    try {
        // ‚úÖ v3.7.1.9 - Preparar contexto ADAPTATIVO baseado na pergunta
        const contexto = prepararContextoDados(pergunta);
        
        // üöÄ MODO PRODU√á√ÉO: IA Real com Gemini via Cloudflare Worker
        const response = await fetch(CHATBOT_WORKER_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                pergunta,
                contexto
            })
        });
        
        if (!response.ok) {
            throw new Error(`Erro na resposta do servidor: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.erro) {
            throw new Error(data.erro);
        }
        
        adicionarMensagemChat(data.resposta, 'assistant');
        
    } catch (error) {
        console.error('‚ùå Erro no chatbot:', error);
        console.error('‚ùå URL:', CHATBOT_WORKER_URL);
        adicionarMensagemChat(
            `Desculpa, ocorreu um erro ao comunicar com o servidor de IA.\n\n**Erro:** ${error.message}\n\nPor favor, verifica se o Cloudflare Worker est√° a funcionar ou contacta o administrador.`,
            'assistant'
        );
    } finally {
        sendBtn.disabled = false;
        mostrarChatbotStatus(false);
    }
};

/**
 * Gerar resposta simulada (enquanto o Worker n√£o est√° configurado)
 */
function gerarRespostaSimulada(pergunta, contexto) {
    const p = pergunta.toLowerCase();
    
    // Detectar palavras-chave e gerar resposta
    if (p.includes('quantos') || p.includes('total')) {
        if (p.includes('aberto') || p.includes('pendente')) {
            return `Atualmente existem **${contexto.resumo.abertos} pedidos abertos** (n√£o resolvidos).\n\n` +
                   `Do total de ${contexto.resumo.total} pedidos:\n` +
                   `‚Ä¢ ${contexto.resumo.abertos} abertos\n` +
                   `‚Ä¢ ${contexto.resumo.resolvidos} resolvidos`;
        }
        return `At√© agora foram registados **${contexto.resumo.total} pedidos** no sistema:\n\n` +
               `‚Ä¢ MCF: ${contexto.resumo.mcf} pedidos\n` +
               `‚Ä¢ PSY: ${contexto.resumo.psy} pedidos\n\n` +
               `Estado atual:\n` +
               `‚Ä¢ Abertos: ${contexto.resumo.abertos}\n` +
               `‚Ä¢ Resolvidos: ${contexto.resumo.resolvidos}`;
    }
    
    if (p.includes('mcf') && (p.includes('psy') || p.includes('compar'))) {
        return `**Compara√ß√£o MCF vs PSY:**\n\n` +
               `‚Ä¢ MCF: ${contexto.resumo.mcf} pedidos (${Math.round(contexto.resumo.mcf/contexto.resumo.total*100)}%)\n` +
               `‚Ä¢ PSY: ${contexto.resumo.psy} pedidos (${Math.round(contexto.resumo.psy/contexto.resumo.total*100)}%)\n\n` +
               `A empresa com mais pedidos √©: **${contexto.resumo.mcf > contexto.resumo.psy ? 'MCF' : 'PSY'}**`;
    }
    
    if (p.includes('m√°quina') || p.includes('equipamento') || p.includes('√°rea')) {
        if (contexto.topAreas.length > 0) {
            return `**Top equipamentos/√°reas com mais pedidos:**\n\n` +
                   contexto.topAreas.map((a, i) => `${i+1}. ${a}`).join('\n');
        }
        return 'N√£o foram encontrados dados de equipamentos/√°reas nos pedidos registados.';
    }
    
    if (p.includes('tipo')) {
        const tiposList = Object.entries(contexto.tipos)
            .sort((a, b) => b[1] - a[1])
            .map(([tipo, count]) => `‚Ä¢ ${tipo}: ${count} pedidos`)
            .join('\n');
        return `**Ordens de trabalho por tipo:**\n\n${tiposList}`;
    }
    
    if (p.includes('tend√™ncia') || p.includes('evolu√ß√£o') || p.includes('backlog')) {
        const metricas = calcularMetricasSemana();
        const sinal = metricas.tendencia > 0 ? '‚Üë' : metricas.tendencia < 0 ? '‚Üì' : '‚Üí';
        const variacao = metricas.tendencia !== 0 ? `${Math.abs(metricas.tendencia)} pedidos` : 'sem altera√ß√£o';
        
        return `**An√°lise de Tend√™ncia:**\n\n` +
               `‚Ä¢ Backlog atual: ${metricas.backlogTotal} pedidos abertos\n` +
               `‚Ä¢ Tend√™ncia: ${sinal} ${variacao} vs semana anterior\n\n` +
               `Esta semana:\n` +
               `‚Ä¢ Novos pedidos: ${metricas.abertos}\n` +
               `‚Ä¢ Pedidos fechados: ${metricas.fechados}`;
    }
    
    // Resposta padr√£o
    return `Analisei a tua pergunta. No momento, tenho dados sobre **${contexto.resumo.total} pedidos** no sistema.\n\n` +
           `Podes perguntar-me sobre:\n` +
           `‚Ä¢ N√∫mero de ordens de trabalho abertas ou fechadas\n` +
           `‚Ä¢ Compara√ß√£o entre MCF e PSY\n` +
           `‚Ä¢ M√°quinas/equipamentos com mais avarias\n` +
           `‚Ä¢ Tipos de pedidos mais comuns\n` +
           `‚Ä¢ Tend√™ncias e evolu√ß√£o do backlog\n\n` +
           `**Nota:** Este √© um modo de demonstra√ß√£o. Para an√°lises mais avan√ßadas com IA, ser√° necess√°rio configurar o backend com Gemini AI.`;
}

// ===================================
// INICIALIZA√á√ÉO
// ===================================

// Adicionar listener para Enter no input do chatbot
document.addEventListener('DOMContentLoaded', () => {
    const chatInput = document.getElementById('chatbotInput');
    if (chatInput) {
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                enviarPerguntaChatbot();
            }
        });
        
        // Auto-resize do textarea
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }
    
    // Listeners para filtros de an√°lise
    const empresaFilter = document.getElementById('analiseEmpresaFilter');
    const periodoFilter = document.getElementById('analisePeriodoFilter');
    
    if (empresaFilter) {
        empresaFilter.addEventListener('change', () => window.atualizarAnalises());
    }
    
    if (periodoFilter) {
        periodoFilter.addEventListener('change', () => window.atualizarAnalises());
    }
});

    </script>
</body>
</html>
